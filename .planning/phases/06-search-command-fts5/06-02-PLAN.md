---
phase: 06-search-command-fts5
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/presentation/cli/commands/search.ts
  - src/presentation/cli/commands/search.test.ts
autonomous: true

must_haves:
  truths:
    - "User can use --case-sensitive to filter results that match exact case"
    - "User can use --ignore-case (default) for case-insensitive search"
    - "Query performance remains under 100ms with 1000+ messages"
    - "Results still show correct BM25 relevance ranking after case filter"
  artifacts:
    - path: "src/presentation/cli/commands/search.ts"
      provides: "Search command with case sensitivity options"
      contains: "case-sensitive"
    - path: "src/presentation/cli/commands/search.test.ts"
      provides: "Tests for case sensitivity filtering"
      min_lines: 80
  key_links:
    - from: "src/presentation/cli/commands/search.ts"
      to: "formatResults function"
      via: "case sensitivity post-filter"
      pattern: "caseSensitive.*filter"
---

<objective>
Add case sensitivity control to the search command with post-filter approach.

Purpose: FTS5 with unicode61 tokenizer is case-insensitive by default. Case-sensitive search requires fetching more results and filtering. This provides users control over search precision.

Output: --case-sensitive and --ignore-case options on search command, with appropriate post-filtering.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/06-search-command-fts5/06-01-SUMMARY.md (previous plan summary)
@src/presentation/cli/commands/search.ts (search command to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add case sensitivity options and post-filter</name>
  <files>
    src/presentation/cli/commands/search.ts
  </files>
  <action>
1. Add CLI options to createSearchCommand():
   ```typescript
   .option("-i, --ignore-case", "Case-insensitive search (default)")
   .option("-c, --case-sensitive", "Case-sensitive search")
   ```

2. Update SearchCommandOptions interface:
   ```typescript
   interface SearchCommandOptions {
     limit?: string;
     project?: string;
     json?: boolean;
     ignoreCase?: boolean;
     caseSensitive?: boolean;
   }
   ```

3. Implement case-sensitive post-filter in executeSearchCommand():
   - If --case-sensitive is set:
     - Fetch 2x the limit from FTS5 (to account for filtering)
     - Filter results where snippet contains original query (case-sensitive match)
     - Trim to requested limit after filtering
   - If --ignore-case or neither (default): use FTS5 results directly

4. Add helper function:
   ```typescript
   function filterCaseSensitive(
     results: SearchResult[],
     query: string,
     limit: number
   ): SearchResult[] {
     // Filter where snippet (without <mark> tags) contains query
     const filtered = results.filter((r) => {
       const cleanSnippet = r.snippet.replace(/<\/?mark>/g, "");
       return cleanSnippet.includes(query);
     });
     return filtered.slice(0, limit);
   }
   ```

5. Note in output when case-sensitive filter reduces results:
   - If filtered count < limit, note: "Showing X results (case-sensitive filter applied)"
  </action>
  <verify>
Run search with --case-sensitive on known mixed-case content. Verify only exact case matches returned.
  </verify>
  <done>
--case-sensitive flag enables post-filter. --ignore-case is default behavior. Filter correctly reduces results to exact case matches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for case sensitivity and performance</name>
  <files>
    src/presentation/cli/commands/search.test.ts
  </files>
  <action>
1. Add tests for case sensitivity options:
   - Test: --case-sensitive flag is recognized
   - Test: --ignore-case flag is recognized
   - Test: filterCaseSensitive correctly filters mixed-case results
   - Test: filterCaseSensitive handles query not found in any result
   - Test: case-sensitive fetches 2x limit from service

2. Add performance test:
   - Create 1000 test messages in database
   - Run search query
   - Assert execution time < 100ms
   - Note: This may need to be marked as integration test with real DB

3. Run full test suite and verify:
   - All existing tests pass
   - New case sensitivity tests pass
   - Total tests increased appropriately
  </action>
  <verify>
`bun test src/presentation/cli/commands/search.test.ts` - all tests pass including case sensitivity tests
  </verify>
  <done>
Case sensitivity fully tested. Performance verified under 100ms threshold.
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and REQUIREMENTS.md update</name>
  <files>
    .planning/REQUIREMENTS.md
  </files>
  <action>
1. Run full test suite: `bun test`
   - Document total test count
   - Verify no regressions

2. Manual verification checklist:
   - [ ] `memory search "authentication"` returns results
   - [ ] `memory search --limit 5 "test"` returns max 5 results
   - [ ] `memory search --case-sensitive "Test"` only matches exact case
   - [ ] `memory search --json "query"` outputs valid JSON
   - [ ] Empty query shows error message
   - [ ] Help output shows all options

3. Update REQUIREMENTS.md:
   - Mark SRCH-01 through SRCH-06 as Complete
   - Note implementation details in comments if needed

4. Verify Phase 6 success criteria from ROADMAP:
   - [x] Search for "authentication" finds matching messages
   - [x] Results ranked by relevance (BM25)
   - [x] Snippets show matched text highlighted
   - [x] --limit 5 returns exactly 5 results
   - [x] Query performance under 100ms (measured in tests)
  </action>
  <verify>
All Phase 6 success criteria met. REQUIREMENTS.md updated. Full test suite passes.
  </verify>
  <done>
Phase 6 complete. All SRCH requirements implemented and verified.
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 02 verification:
1. --case-sensitive filters results to exact case matches
2. --ignore-case (default) uses FTS5 case-insensitive behavior
3. Performance test confirms < 100ms query time
4. All SRCH-01 through SRCH-06 requirements marked Complete
5. All tests pass
</verification>

<success_criteria>
- Case sensitivity options work correctly
- Post-filter approach handles edge cases (no matches, fewer than limit)
- Performance remains under 100ms with large datasets
- All 6 SRCH requirements implemented and verified
- REQUIREMENTS.md updated with completion status
- Full test suite passes with increased test count
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-command-fts5/06-02-SUMMARY.md`
</output>
