---
phase: 06-search-command-fts5
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/presentation/cli/commands/search.ts
  - src/presentation/cli/commands/search.test.ts
  - src/presentation/cli/commands/index.ts
  - src/presentation/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "User can run `memory search <query>` and see matching results"
    - "Results are ranked by relevance with scores displayed"
    - "Matched text is highlighted in result snippets"
    - "--limit option controls number of results returned"
  artifacts:
    - path: "src/presentation/cli/commands/search.ts"
      provides: "Search command handler"
      exports: ["createSearchCommand", "executeSearchCommand"]
    - path: "src/presentation/cli/commands/search.test.ts"
      provides: "Search command unit tests"
      min_lines: 50
  key_links:
    - from: "src/presentation/cli/commands/search.ts"
      to: "src/infrastructure/database/services/search-service.ts"
      via: "Fts5SearchService constructor"
      pattern: "new Fts5SearchService"
    - from: "src/presentation/cli/commands/search.ts"
      to: "src/domain/value-objects/search-query.ts"
      via: "SearchQuery.from()"
      pattern: "SearchQuery\\.from"
---

<objective>
Implement the search CLI command that wires to the existing Fts5SearchService.

Purpose: Enable users to search across all synced sessions using full-text search with BM25 relevance ranking. This is the primary discovery mechanism for finding past conversations.

Output: Working `memory search <query>` command with result formatting and limit support.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/presentation/cli/commands/sync.ts (reference pattern for command structure)
@src/infrastructure/database/services/search-service.ts (Fts5SearchService to wire)
@src/domain/value-objects/search-query.ts (SearchQuery.from() for validation)
@src/domain/value-objects/search-result.ts (SearchResult type for formatting)
@src/presentation/cli/index.ts (CLI entry point to update)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search command module</name>
  <files>
    src/presentation/cli/commands/search.ts
    src/presentation/cli/commands/search.test.ts
  </files>
  <action>
Create search command handler following the sync command pattern:

1. Create `src/presentation/cli/commands/search.ts`:

```typescript
/**
 * Search Command Handler
 *
 * CLI command for full-text search across synced sessions.
 * Wires to Fts5SearchService with result formatting.
 */

import { Command } from "commander";
import { SearchQuery } from "../../../domain/value-objects/search-query.js";
import type { SearchResult } from "../../../domain/value-objects/search-result.js";
import {
  initializeDatabase,
  closeDatabase,
  getDefaultDbPath,
  Fts5SearchService,
} from "../../../infrastructure/database/index.js";

interface SearchCommandOptions {
  limit?: string;
  project?: string;
  json?: boolean;
}

export function createSearchCommand(): Command {
  return new Command("search")
    .argument("<query>", "Search query text")
    .description("Full-text search across all sessions")
    .option("-l, --limit <count>", "Maximum results to return", "10")
    .option("-p, --project <name>", "Filter by project name")
    .option("--json", "Output results as JSON")
    .action(async (query: string, options: SearchCommandOptions) => {
      await executeSearchCommand(query, options);
    });
}
```

2. Implement `executeSearchCommand()`:
   - Initialize database (same pattern as sync)
   - Create SearchQuery.from(query) - catches empty query errors
   - Create Fts5SearchService
   - Call search() with limit option parsed as number
   - Format results or output JSON
   - Close database in finally block

3. Implement `formatResults()`:
   - Convert `<mark>` tags to ANSI bold (\x1b[1m ... \x1b[0m)
   - Display score as percentage (score * 100).toFixed(0)
   - Show session ID and timestamp
   - Number results (1., 2., 3.)

4. Handle error cases:
   - Empty query: print error message and exit code 1
   - No results: print "No results found for: <query>"
   - Database errors: print error and exit code 2

5. Create test file with tests for:
   - Command creation and options parsing
   - Empty query error handling
   - --json flag changes output format
   - --limit is passed correctly
  </action>
  <verify>
Run `bun test src/presentation/cli/commands/search.test.ts` - all tests pass
  </verify>
  <done>
createSearchCommand() returns configured Command instance. executeSearchCommand() wires to Fts5SearchService and formats results with ANSI highlighting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI entry point and commands barrel</name>
  <files>
    src/presentation/cli/commands/index.ts
    src/presentation/cli/index.ts
  </files>
  <action>
1. Update `src/presentation/cli/commands/index.ts`:
   - Add export for createSearchCommand and executeSearchCommand

2. Update `src/presentation/cli/index.ts`:
   - Import createSearchCommand from commands module
   - Replace placeholder search command with: `program.addCommand(createSearchCommand())`
   - Remove the inline .command("search <query>") definition

3. Verify help output shows correct search options:
   ```
   memory search <query>

   Full-text search across all sessions

   Options:
     -l, --limit <count>  Maximum results to return (default: "10")
     -p, --project <name> Filter by project name
     --json               Output results as JSON
   ```
  </action>
  <verify>
Run `bun run src/presentation/cli/index.ts search --help` and verify options are displayed correctly
  </verify>
  <done>
CLI entry point uses createSearchCommand(). Help output shows all options correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite and add integration smoke test</name>
  <files>
    src/presentation/cli/commands/search.test.ts
  </files>
  <action>
1. Add smoke test to search.test.ts that:
   - Creates in-memory database
   - Inserts test session and message via repositories
   - Calls executeSearchCommand with test query
   - Verifies no errors thrown

2. Run full test suite: `bun test`
   - All existing tests should pass
   - New search tests should pass
   - Total test count should increase by ~15-20

3. Manual verification (document in summary):
   - Run sync first: `bun run src/presentation/cli/index.ts sync`
   - Run search: `bun run src/presentation/cli/index.ts search "authentication"`
   - Verify results displayed with formatting
  </action>
  <verify>
`bun test` - all tests pass. Manual test shows formatted search results.
  </verify>
  <done>
Search command works end-to-end. Test suite expanded with search tests.
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 01 verification:
1. `memory search <query>` returns results from Fts5SearchService
2. Results show relevance score, session ID, timestamp, and highlighted snippet
3. --limit option controls result count
4. --json outputs valid JSON array
5. Empty query shows error message
6. All tests pass
</verification>

<success_criteria>
- Search command exists at src/presentation/cli/commands/search.ts
- Command follows sync command pattern (createSearchCommand, executeSearchCommand)
- Results formatted with ANSI highlighting (bold for matched text)
- --limit defaults to 10, accepts custom value
- --json flag outputs JSON instead of formatted text
- All existing tests pass plus new search tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-command-fts5/06-01-SUMMARY.md`
</output>
