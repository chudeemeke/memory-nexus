---
phase: 06-search-command-fts5
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/value-objects/search-result.ts
  - src/infrastructure/database/services/search-service.ts
  - src/presentation/cli/formatters/output-formatter.ts
  - src/presentation/cli/formatters/color.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Search results display role (user/assistant) for each match"
    - "Session IDs are readable (16+ characters, not truncated to 8)"
    - "Snippets provide meaningful context around matched text (64+ tokens)"
    - "Matched text is visually distinguishable even in non-TTY environments"
  artifacts:
    - path: "src/domain/value-objects/search-result.ts"
      provides: "SearchResult with role property"
      contains: "role"
    - path: "src/infrastructure/database/services/search-service.ts"
      provides: "Search service returning role and larger snippets"
      contains: "m.role"
    - path: "src/presentation/cli/formatters/output-formatter.ts"
      provides: "Formatter displaying role and longer session IDs"
      contains: "result.role"
  key_links:
    - from: "src/infrastructure/database/services/search-service.ts"
      to: "src/domain/value-objects/search-result.ts"
      via: "SearchResult.create with role"
      pattern: "role: row\\.role"
    - from: "src/presentation/cli/formatters/output-formatter.ts"
      to: "SearchResult.role getter"
      via: "result.role display"
      pattern: "result\\.role"
---

<objective>
Fix UAT gaps in search result display: add role field propagation, increase session ID visibility, enlarge FTS5 snippet context, and preserve highlight markers in non-TTY environments.

Purpose: Users reported search results are unintelligible - truncated session IDs, missing role, insufficient snippet context, and no visible highlighting. This gap closure addresses all diagnosed issues to make search results usable.

Output: Search results that clearly show role, meaningful session IDs, contextual snippets, and visible match highlighting in all environments.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/06-search-command-fts5/06-UAT.md (gap diagnoses)
@src/domain/value-objects/search-result.ts (add role property)
@src/infrastructure/database/services/search-service.ts (add role to query, increase snippet tokens)
@src/presentation/cli/formatters/output-formatter.ts (display role, longer session IDs, fallback markers)
@src/presentation/cli/formatters/color.ts (reference for TTY detection)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role field to SearchResult and SearchService</name>
  <files>
    src/domain/value-objects/search-result.ts
    src/infrastructure/database/services/search-service.ts
    src/domain/value-objects/search-result.test.ts
    src/infrastructure/database/services/search-service.test.ts
  </files>
  <action>
1. Update `src/domain/value-objects/search-result.ts`:
   - Add `role` to SearchResultParams interface:
     ```typescript
     interface SearchResultParams {
       sessionId: string;
       messageId: string;
       snippet: string;
       score: number;
       timestamp: Date;
       role: string;  // 'user' | 'assistant' | 'system'
     }
     ```
   - Add private `_role` field and public getter
   - Validate role is not empty in create() method

2. Update `src/infrastructure/database/services/search-service.ts`:
   - Add `role` to SearchRow interface:
     ```typescript
     interface SearchRow {
       id: string;
       session_id: string;
       content: string;
       timestamp: string;
       score: number;
       snippet: string;
       role: string;  // Add this
     }
     ```
   - Update SQL query to select `m.role`:
     ```sql
     SELECT
       m.id,
       m.session_id,
       m.role,
       m.content,
       m.timestamp,
       bm25(messages_fts) as score,
       snippet(messages_fts, 0, '<mark>', '</mark>', '...', 64) as snippet
     ```
   - Change snippet token count from 32 to 64 for better context
   - Pass role to SearchResult.create():
     ```typescript
     SearchResult.create({
       sessionId: row.session_id,
       messageId: row.id,
       snippet: row.snippet,
       score: row.normalizedScore,
       timestamp: new Date(row.timestamp),
       role: row.role,
     })
     ```

3. Update existing tests:
   - Add role to all SearchResult.create() calls in tests
   - Add role to mock SearchRow objects in search-service tests
   - Add test verifying role is returned from search results
  </action>
  <verify>
Run `bun test src/domain/value-objects/search-result.test.ts src/infrastructure/database/services/search-service.test.ts` - all tests pass
  </verify>
  <done>
SearchResult has role property. SearchService queries and returns role from messages_meta table. Snippet token count increased to 64.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update output formatters for intelligible display</name>
  <files>
    src/presentation/cli/formatters/output-formatter.ts
    src/presentation/cli/formatters/output-formatter.test.ts
  </files>
  <action>
1. Update `highlightSnippet()` function to use plain text markers when colors disabled:
   ```typescript
   function highlightSnippet(snippet: string, useColor: boolean): string {
     if (!useColor) {
       // Use asterisks for visible highlighting in non-TTY environments
       return snippet
         .replace(/<mark>/g, '*')
         .replace(/<\/mark>/g, '*');
     }
     return snippet
       .replace(/<mark>/g, "\x1b[1m")
       .replace(/<\/mark>/g, "\x1b[0m");
   }
   ```

2. Update `DefaultOutputFormatter.formatResult()`:
   - Increase session ID display from 8 to 16 characters
   - Add role display between score and session ID
   ```typescript
   private formatResult(result: SearchResult, index: number): string {
     const scorePercent = (result.score * 100).toFixed(0);
     const sessionShort = result.sessionId.substring(0, 16);
     const timestamp = formatTimestamp(result.timestamp);
     const snippet = highlightSnippet(result.snippet, this.useColor);
     const role = result.role.charAt(0).toUpperCase() + result.role.slice(1);

     return `${index}. [${scorePercent}%] [${role}] ${sessionShort}...\n   ${timestamp}\n   ${snippet}\n\n`;
   }
   ```

3. Update `QuietOutputFormatter.formatResults()`:
   - Increase session ID from 8 to 16 characters
   - Use asterisk markers for highlighting
   ```typescript
   return results
     .map((r) => {
       const sessionShort = r.sessionId.substring(0, 16);
       const snippet = r.snippet
         .replace(/<mark>/g, '*')
         .replace(/<\/mark>/g, '*');
       return `${sessionShort} ${snippet}`;
     })
     .join("\n");
   ```

4. Update `VerboseOutputFormatter.formatResult()`:
   - Add role display
   - Full session ID already shown in verbose mode
   ```typescript
   private formatResult(result: SearchResult, index: number): string {
     const scorePercent = (result.score * 100).toFixed(0);
     const timestamp = formatTimestamp(result.timestamp);
     const snippet = highlightSnippet(result.snippet, this.useColor);
     const role = result.role.charAt(0).toUpperCase() + result.role.slice(1);

     return `${index}. [${scorePercent}%] [${role}] ${result.sessionId}\n   ${timestamp}\n   ${snippet}\n\n`;
   }
   ```

5. Update `JsonOutputFormatter.formatResults()`:
   - Add role to JSON output
   ```typescript
   const jsonResults = results.map((r) => ({
     sessionId: r.sessionId,
     messageId: r.messageId,
     role: r.role,
     score: r.score,
     timestamp: r.timestamp.toISOString(),
     snippet: r.snippet.replace(/<\/?mark>/g, ""),
   }));
   ```

6. Update tests:
   - Test highlightSnippet with useColor=false produces asterisk markers
   - Test formatResult includes role in output
   - Test JSON output includes role field
   - Test session ID is 16 characters in default/quiet modes
  </action>
  <verify>
Run `bun test src/presentation/cli/formatters/output-formatter.test.ts` - all tests pass
  </verify>
  <done>
All formatters display role. Session IDs show 16 characters. Non-TTY environments use asterisk markers for highlighting. JSON includes role field.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration test and full verification</name>
  <files>
    src/presentation/cli/commands/search.test.ts
  </files>
  <action>
1. Add integration test to search.test.ts:
   - Create test database with session and messages having different roles
   - Execute search and verify results include role field
   - Verify snippet has sufficient context (not just "50" or "---")

2. Run full test suite: `bun test`
   - Document total test count
   - Verify no regressions in existing functionality
   - Verify search-related tests all pass

3. Manual verification (document in summary):
   - Run sync if needed: `bun run src/presentation/cli/index.ts sync`
   - Run search: `bun run src/presentation/cli/index.ts search "test"`
   - Verify output shows:
     - [x] Role label (User/Assistant) visible
     - [x] Session ID is 16+ characters, not truncated to 8
     - [x] Snippet provides meaningful context around matched text
     - [x] If non-TTY: asterisks around matched text visible
   - Run with --json and verify role field present

4. Test in non-TTY environment:
   - Pipe output: `bun run src/presentation/cli/index.ts search "test" | cat`
   - Verify asterisks appear around matched terms (not stripped)
  </action>
  <verify>
`bun test` - all tests pass. Manual verification confirms intelligible search results with role, readable session IDs, and visible highlighting.
  </verify>
  <done>
UAT gaps closed. Search results are intelligible: role visible, session IDs readable, snippets contextual, highlighting works in all environments.
  </done>
</task>

</tasks>

<verification>
Phase 6 Plan 03 (Gap Closure) verification:
1. SearchResult has role property populated from database
2. FTS5 snippet uses 64 tokens (up from 32) for better context
3. Role displayed as [User] or [Assistant] in search results
4. Session IDs show 16 characters (up from 8) in default/quiet modes
5. Non-TTY environments show *matched* text with asterisks
6. JSON output includes role field
7. All existing tests pass plus new tests
</verification>

<success_criteria>
- SearchResult.role property exists and is populated
- Search results clearly show role for each match
- Session IDs are 16+ characters in display (readable)
- Snippet token count increased to 64 (meaningful context)
- Non-TTY environments use asterisk highlighting (*text*)
- All output modes (default, verbose, quiet, json) updated
- All tests pass, no regressions
- Manual UAT verification confirms gaps closed
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-command-fts5/06-03-SUMMARY.md`
</output>
