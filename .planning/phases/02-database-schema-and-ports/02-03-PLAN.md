---
phase: 02-database-schema-and-ports
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/infrastructure/database/connection.ts
  - src/infrastructure/database/connection.test.ts
  - src/infrastructure/database/index.ts
autonomous: true

must_haves:
  truths:
    - "Database initializes with WAL mode enabled"
    - "PRAGMA journal_mode=WAL is verified after setting"
    - "Performance pragmas are configured (synchronous, cache_size, temp_store)"
    - "Database file is created at the expected location"
  artifacts:
    - path: "src/infrastructure/database/connection.ts"
      provides: "Database initialization and connection management"
      exports: ["initializeDatabase", "getDefaultDbPath", "DatabaseConfig"]
    - path: "src/infrastructure/database/connection.test.ts"
      provides: "Connection and initialization tests"
      min_lines: 80
  key_links:
    - from: "src/infrastructure/database/connection.ts"
      to: "src/infrastructure/database/schema.ts"
      via: "import { createSchema, checkFts5Support }"
      pattern: "import.*createSchema.*from.*schema"
---

<objective>
Implement database initialization with WAL mode, performance pragmas, and schema creation.

Purpose: Create a robust database initialization function that configures bun:sqlite for optimal performance with FTS5 full-text search. The initialization handles WAL mode verification, FTS5 availability checking, and schema creation in a single atomic setup.

Output: Database connection module with initializeDatabase function, configuration types, and comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-schema-and-ports/02-RESEARCH.md
@src/infrastructure/database/schema.ts (from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database connection module</name>
  <files>src/infrastructure/database/connection.ts</files>
  <action>
Create connection.ts with database initialization:

DatabaseConfig interface:
```typescript
export interface DatabaseConfig {
    /** Path to the database file. Use ":memory:" for in-memory database. */
    path: string;
    /** Whether to create the database if it doesn't exist. Default: true */
    create?: boolean;
    /** Whether to apply schema on initialization. Default: true */
    applySchema?: boolean;
    /** Whether to enable WAL mode. Default: true */
    walMode?: boolean;
    /** Cache size in KB (negative) or pages (positive). Default: -64000 (64MB) */
    cacheSize?: number;
}
```

getDefaultDbPath function:
```typescript
import { homedir } from "node:os";
import { join } from "node:path";

export function getDefaultDbPath(): string {
    // Store in ~/.memory-nexus/memory.db
    return join(homedir(), ".memory-nexus", "memory.db");
}
```

initializeDatabase function:
```typescript
import { Database } from "bun:sqlite";
import { mkdirSync } from "node:fs";
import { dirname } from "node:path";
import { createSchema, checkFts5Support } from "./schema.js";

export interface DatabaseInitResult {
    db: Database;
    walEnabled: boolean;
    fts5Available: boolean;
}

export function initializeDatabase(config: DatabaseConfig): DatabaseInitResult {
    const {
        path,
        create = true,
        applySchema = true,
        walMode = true,
        cacheSize = -64000,
    } = config;

    // Ensure directory exists for file-based databases
    if (path !== ":memory:") {
        mkdirSync(dirname(path), { recursive: true });
    }

    // Create database connection
    const db = new Database(path, { create });

    // Enable foreign keys
    db.exec("PRAGMA foreign_keys = ON;");

    // Configure WAL mode
    let walEnabled = false;
    if (walMode) {
        db.exec("PRAGMA journal_mode = WAL;");
        const result = db.query("PRAGMA journal_mode;").get() as { journal_mode: string };
        walEnabled = result.journal_mode === "wal";
        if (!walEnabled && path !== ":memory:") {
            console.warn(`Warning: WAL mode not enabled. Current mode: ${result.journal_mode}`);
        }
    }

    // Performance pragmas
    db.exec("PRAGMA synchronous = NORMAL;");
    db.exec(`PRAGMA cache_size = ${cacheSize};`);
    db.exec("PRAGMA temp_store = MEMORY;");

    // Check FTS5 support
    const fts5Available = checkFts5Support(db);
    if (!fts5Available) {
        throw new Error("FTS5 is not available. memory-nexus requires FTS5 for full-text search.");
    }

    // Apply schema
    if (applySchema) {
        createSchema(db);
    }

    return { db, walEnabled, fts5Available };
}
```

closeDatabase function:
```typescript
export function closeDatabase(db: Database): void {
    // Checkpoint WAL before closing
    try {
        db.exec("PRAGMA wal_checkpoint(TRUNCATE);");
    } catch {
        // Ignore errors (e.g., if not in WAL mode)
    }
    db.close();
}
```

checkpointDatabase function:
```typescript
export function checkpointDatabase(db: Database): void {
    db.exec("PRAGMA wal_checkpoint(PASSIVE);");
}
```
  </action>
  <verify>
- File compiles: bun build --dry-run src/infrastructure/database/connection.ts
- All functions exported
- DatabaseConfig and DatabaseInitResult types exported
  </verify>
  <done>
Database connection module provides initialization with WAL mode, performance pragmas, and FTS5 verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add connection unit tests</name>
  <files>src/infrastructure/database/connection.test.ts</files>
  <action>
Create connection.test.ts:

1. In-memory database initialization test:
- Call initializeDatabase with path: ":memory:"
- Verify db is returned
- Verify fts5Available is true

2. WAL mode verification test:
- Create temp file database
- Initialize with walMode: true
- Query PRAGMA journal_mode
- Assert equals "wal"
- Clean up temp file

3. WAL mode disabled test:
- Initialize with walMode: false
- Query PRAGMA journal_mode
- Assert not "wal" (delete or memory)

4. Schema application test:
- Initialize with applySchema: true
- Query sqlite_master for sessions table
- Assert table exists

5. Schema skip test:
- Initialize with applySchema: false
- Query sqlite_master for sessions table
- Assert table does not exist

6. Cache size pragma test:
- Initialize with cacheSize: -32000
- Query PRAGMA cache_size
- Assert equals -32000

7. Foreign keys enabled test:
- Initialize database
- Query PRAGMA foreign_keys
- Assert equals 1

8. closeDatabase checkpoint test:
- Initialize file-based database
- Insert some data
- Call closeDatabase
- Verify WAL file is checkpointed (small or non-existent)

9. getDefaultDbPath test:
- Call getDefaultDbPath()
- Assert contains ".memory-nexus"
- Assert ends with "memory.db"

10. Directory creation test:
- Use temp directory path that doesn't exist
- Initialize database
- Assert database file exists

Test utilities:
```typescript
import { tmpdir } from "node:os";
import { join } from "node:path";
import { mkdtempSync, rmSync, existsSync } from "node:fs";

function createTempDbPath(): string {
    const dir = mkdtempSync(join(tmpdir(), "memory-nexus-test-"));
    return join(dir, "test.db");
}

function cleanupTempDb(dbPath: string): void {
    const dir = dirname(dbPath);
    rmSync(dir, { recursive: true, force: true });
}
```
  </action>
  <verify>
- bun test src/infrastructure/database/connection.test.ts passes
- All 10 test cases pass
- Temp files cleaned up after tests
  </verify>
  <done>
Connection tests verify WAL mode, pragmas, schema application, and proper cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database module index</name>
  <files>src/infrastructure/database/index.ts, src/infrastructure/index.ts</files>
  <action>
Create src/infrastructure/database/index.ts:
```typescript
/**
 * Database Infrastructure
 *
 * Provides SQLite database initialization, schema management,
 * and connection utilities for memory-nexus.
 */

// Schema
export {
    SCHEMA_SQL,
    createSchema,
    checkFts5Support,
    SESSIONS_TABLE,
    MESSAGES_META_TABLE,
    MESSAGES_FTS_TABLE,
    TOOL_USES_TABLE,
    LINKS_TABLE,
    TOPICS_TABLE,
    EXTRACTION_STATE_TABLE,
} from "./schema.js";

// Connection
export {
    initializeDatabase,
    closeDatabase,
    checkpointDatabase,
    getDefaultDbPath,
    type DatabaseConfig,
    type DatabaseInitResult,
} from "./connection.js";
```

Update src/infrastructure/index.ts:
```typescript
/**
 * Infrastructure Layer
 *
 * External system integrations: database, filesystem, etc.
 */

export * from "./database/index.js";
```
  </action>
  <verify>
- Index files compile
- Can import from @src/infrastructure
- All exports accessible
  </verify>
  <done>
Infrastructure database module exports all schema and connection utilities through clean index structure.
  </done>
</task>

</tasks>

<verification>
Database initialization satisfies SETUP-02 requirements:
- [ ] bun:sqlite configured with FTS5 (verified at runtime)
- [ ] WAL mode enabled and verified via PRAGMA
- [ ] Performance pragmas set (synchronous=NORMAL, cache_size, temp_store=MEMORY)
- [ ] Schema created on initialization
- [ ] WAL checkpoint on close
- [ ] All tests pass: bun test src/infrastructure/database/
</verification>

<success_criteria>
1. initializeDatabase creates database with WAL mode verified
2. FTS5 availability checked and throws if unavailable
3. Performance pragmas configured correctly
4. Schema applied during initialization (configurable)
5. closeDatabase performs WAL checkpoint
6. getDefaultDbPath returns ~/.memory-nexus/memory.db
7. All 10+ unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-schema-and-ports/02-03-SUMMARY.md`
</output>
