---
phase: 02-database-schema-and-ports
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - src/infrastructure/database/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "FTS5 MATCH queries work with real data"
    - "BM25 ranking returns results in relevance order"
    - "External content FTS5 synchronization works via triggers"
    - "Database handles concurrent read/write in WAL mode"
  artifacts:
    - path: "src/infrastructure/database/integration.test.ts"
      provides: "Integration tests for database and FTS5"
      min_lines: 150
  key_links:
    - from: "src/infrastructure/database/integration.test.ts"
      to: "src/infrastructure/database/connection.ts"
      via: "import { initializeDatabase, closeDatabase }"
      pattern: "import.*initializeDatabase.*from.*connection"
---

<objective>
Create integration tests verifying FTS5 full-text search works correctly with the database schema.

Purpose: Validate that the external content FTS5 pattern with triggers correctly indexes content, that MATCH queries work as expected, and that BM25 ranking produces relevant results. These tests prove the database layer is ready for repository implementations in Phase 4.

Output: Comprehensive integration test suite covering FTS5 search, ranking, and synchronization scenarios.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-schema-and-ports/02-RESEARCH.md
@src/infrastructure/database/schema.ts (from Plan 02)
@src/infrastructure/database/connection.ts (from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FTS5 search integration tests</name>
  <files>src/infrastructure/database/integration.test.ts</files>
  <action>
Create integration.test.ts with FTS5-focused tests:

Test setup helper:
```typescript
import { describe, it, expect, beforeEach, afterEach } from "bun:test";
import { Database } from "bun:sqlite";
import { initializeDatabase, closeDatabase } from "./connection.js";

function insertTestSession(db: Database, id: string, projectName: string): void {
    db.run(`
        INSERT INTO sessions (id, project_path_encoded, project_path_decoded, project_name, start_time)
        VALUES (?, ?, ?, ?, datetime('now'))
    `, [id, `C--Users-Test-${projectName}`, `C:\\Users\\Test\\${projectName}`, projectName]);
}

function insertTestMessage(db: Database, id: string, sessionId: string, role: string, content: string): void {
    db.run(`
        INSERT INTO messages_meta (id, session_id, role, content, timestamp)
        VALUES (?, ?, ?, ?, datetime('now'))
    `, [id, sessionId, role, content]);
}
```

Test 1: Basic FTS5 MATCH query
- Insert session and messages
- Query: SELECT * FROM messages_fts WHERE messages_fts MATCH 'authentication'
- Verify matching message found

Test 2: FTS5 MATCH vs = operator performance
- Insert many messages
- Time MATCH query
- Verify EXPLAIN QUERY PLAN shows FTS5 usage (contains "SCAN messages_fts")

Test 3: FTS5 prefix search
- Insert message with "authenticate"
- Query: MATCH 'auth*'
- Verify message found

Test 4: FTS5 phrase search
- Insert message with "user authentication flow"
- Query: MATCH '"authentication flow"'
- Verify message found

Test 5: FTS5 boolean OR
- Insert messages with different keywords
- Query: MATCH 'authentication OR authorization'
- Verify both messages found

Test 6: FTS5 NOT operator
- Insert messages with and without keyword
- Query: MATCH 'authentication NOT oauth'
- Verify correct filtering

Test 7: FTS5 column filter (single column table - content only)
- Query: MATCH 'content:authentication'
- Verify works same as unqualified MATCH
  </action>
  <verify>
- Tests compile without errors
- FTS5 MATCH queries work correctly
- Prefix and phrase searches work
  </verify>
  <done>
FTS5 search tests verify MATCH operator, prefix search, phrase search, and boolean operators.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add BM25 ranking and snippet tests</name>
  <files>src/infrastructure/database/integration.test.ts</files>
  <action>
Add to integration.test.ts:

Test 8: BM25 ranking order
- Insert messages:
  - msg1: "authentication is important" (1 occurrence)
  - msg2: "authentication authentication authentication" (3 occurrences)
  - msg3: "user login" (0 occurrences)
- Query with bm25(): ORDER BY bm25(messages_fts)
- Verify msg2 ranks higher than msg1 (more relevant)
- Verify msg3 not returned

Test 9: BM25 with term frequency normalization
- Insert short message with keyword
- Insert long message with same keyword
- Verify shorter message ranks higher (TF-IDF behavior)

Test 10: Snippet extraction
```typescript
const results = db.query(`
    SELECT
        m.id,
        snippet(messages_fts, 0, '<mark>', '</mark>', '...', 32) as snippet
    FROM messages_fts
    JOIN messages_meta m ON messages_fts.rowid = m.rowid
    WHERE messages_fts MATCH ?
`, ['authentication']).all();
```
- Verify snippet contains <mark> tags around matched term
- Verify snippet truncates with '...' for long content

Test 11: Highlight function
```typescript
const results = db.query(`
    SELECT highlight(messages_fts, 0, '<b>', '</b>') as highlighted
    FROM messages_fts
    WHERE messages_fts MATCH ?
`, ['authentication']).all();
```
- Verify highlighted content has <b> tags

Test 12: Multiple term relevance
- Insert messages with different term combinations
- Query for multiple terms
- Verify messages with more matching terms rank higher
  </action>
  <verify>
- BM25 ranking tests pass
- Snippet extraction includes markers
- Multiple term ranking works correctly
  </verify>
  <done>
BM25 and snippet tests verify relevance ranking and context extraction work as expected.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add trigger synchronization and edge case tests</name>
  <files>src/infrastructure/database/integration.test.ts</files>
  <action>
Add to integration.test.ts:

Test 13: Trigger INSERT synchronization
- Insert message into messages_meta
- Query messages_fts immediately
- Verify content is searchable (trigger fired)

Test 14: Trigger DELETE synchronization
- Insert message
- Verify searchable
- DELETE from messages_meta
- Query messages_fts
- Verify NOT found (trigger removed from index)

Test 15: Trigger UPDATE synchronization
- Insert message with content "old content"
- Verify "old content" searchable
- UPDATE content to "new content"
- Verify "old content" NOT searchable
- Verify "new content" IS searchable

Test 16: Bulk insert performance
- Insert 1000 messages in transaction
- Verify all 1000 searchable
- Measure time (should be < 5 seconds)

Test 17: Empty search query handling
- Try MATCH ''
- Verify behavior (error or empty results)

Test 18: Special character handling
- Insert message with special chars: "C++ authentication (OAuth 2.0)"
- Query for "C++"
- Query for "OAuth"
- Verify results handle special chars

Test 19: Unicode content
- Insert message with unicode: "authentication"
- Query for "authentication"
- Verify unicode content indexed

Test 20: Case insensitivity
- Insert "Authentication"
- Query "authentication" (lowercase)
- Verify match found (FTS5 default tokenizer is case-insensitive)

Test 21: Very long content
- Insert message with 10KB of text
- Query for term in the middle
- Verify found and snippet extraction works
  </action>
  <verify>
- All trigger sync tests pass
- Bulk insert under 5 seconds
- Edge cases handled correctly
  </verify>
  <done>
Trigger synchronization tests verify INSERT/UPDATE/DELETE keep FTS5 index consistent. Edge cases cover special characters, unicode, and large content.
  </done>
</task>

</tasks>

<verification>
Integration tests verify Phase 2 success criteria:
- [ ] FTS5 virtual table accepts MATCH queries
- [ ] BM25 ranking orders results by relevance
- [ ] Trigger synchronization keeps index updated on INSERT/UPDATE/DELETE
- [ ] Snippet and highlight functions extract context
- [ ] Bulk operations perform adequately (1000 messages < 5 seconds)
- [ ] All 21 integration tests pass: bun test src/infrastructure/database/integration.test.ts
</verification>

<success_criteria>
1. All FTS5 MATCH queries work correctly
2. BM25 ranking produces expected relevance order
3. Snippet extraction marks matched terms
4. Trigger synchronization verified for INSERT/UPDATE/DELETE
5. Bulk insert of 1000 messages completes in < 5 seconds
6. Edge cases handled (special chars, unicode, large content)
7. All 21 integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-schema-and-ports/02-04-SUMMARY.md`
</output>
