---
phase: 12-polish-error-handling
plan: 11
type: execute
wave: 5
depends_on: ["12-09", "12-10"]
files_modified:
  # Domain layer (~8 files)
  - src/domain/errors/error-codes.test.ts
  - src/domain/errors/memory-nexus-error.test.ts
  - src/domain/models/session.test.ts
  - src/domain/models/message.test.ts
  - src/domain/models/tool-use.test.ts
  - src/domain/models/entity.test.ts
  - src/domain/models/link.test.ts
  - src/domain/index.test.ts
  # Application layer (~6 files)
  - src/application/services/sync-service.test.ts
  - src/application/services/export-service.test.ts
  - src/application/services/recovery-service.test.ts
  - src/application/services/search-service.test.ts
  - src/application/services/stats-service.test.ts
  - src/application/services/query-service.test.ts
  # Infrastructure layer (~10 files)
  - src/infrastructure/signals/signal-handler.test.ts
  - src/infrastructure/signals/checkpoint-manager.test.ts
  - src/infrastructure/database/health-checker.test.ts
  - src/infrastructure/database/connection.test.ts
  - src/infrastructure/database/schema.test.ts
  - src/infrastructure/hooks/hook-runner.test.ts
  - src/infrastructure/hooks/hook-installer.test.ts
  - src/infrastructure/config/config-manager.test.ts
  - src/infrastructure/logging/log-writer.test.ts
  - src/infrastructure/logging/error-logger.test.ts
  # Presentation layer (~12 files)
  - src/presentation/cli/formatters/error-formatter.test.ts
  - src/presentation/cli/commands/sync.test.ts
  - src/presentation/cli/commands/search.test.ts
  - src/presentation/cli/commands/doctor.test.ts
  - src/presentation/cli/commands/export.test.ts
  - src/presentation/cli/commands/import.test.ts
  - src/presentation/cli/commands/purge.test.ts
  - src/presentation/cli/commands/completion.test.ts
  - src/presentation/cli/commands/stats.test.ts
  - src/presentation/cli/commands/context.test.ts
  - src/presentation/cli/commands/list.test.ts
  - src/presentation/cli/commands/show.test.ts
autonomous: true

must_haves:
  truths:
    - "Coverage meets 95%+ at EACH metric"
    - "All layers meet their coverage targets"
    - "No untested error paths remain"
  artifacts:
    - path: "coverage report"
      provides: "Coverage metrics for all layers"
  key_links:
    - from: "coverage thresholds"
      to: "bunfig.toml"
      via: "coverage configuration"
      pattern: "coverageThreshold"
---

<objective>
Achieve 95%+ test coverage at EACH metric across all layers.

Purpose: Meet the quality requirement QUAL-01 and ensure comprehensive test coverage. This plan focuses on identifying and filling coverage gaps.

Output: 95%+ coverage at statements, branches, functions, and lines across all layers.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-polish-error-handling/12-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze and fill domain/application coverage gaps</name>
  <files>
    src/domain/errors/error-codes.test.ts
    src/domain/errors/memory-nexus-error.test.ts
    src/domain/models/session.test.ts
    src/domain/models/message.test.ts
    src/domain/models/tool-use.test.ts
    src/domain/models/entity.test.ts
    src/domain/models/link.test.ts
    src/domain/index.test.ts
    src/application/services/sync-service.test.ts
    src/application/services/export-service.test.ts
    src/application/services/recovery-service.test.ts
    src/application/services/search-service.test.ts
    src/application/services/stats-service.test.ts
    src/application/services/query-service.test.ts
  </files>
  <action>
    Identify and fill coverage gaps in domain and application layers:

    1. Run coverage report:
       - bun test --coverage 2>&1 | tee coverage-report.txt
       - Identify files with < 95% coverage
       - Focus on uncovered lines (from report)

    2. Domain layer (target: 99%, ~8 test files):
       - Check error-codes.ts (new file - needs tests)
       - Check memory-nexus-error.ts (new file - needs tests)
       - Check any uncovered branches in existing files
       - Add tests for edge cases identified

    3. Application layer (target: 95%, ~6 test files):
       - Check sync-service.ts checkpoint/abort paths
       - Check export-service.ts (new file - needs tests)
       - Check recovery-service.ts edge cases
       - Add tests for error paths

    4. For each uncovered line/branch:
       - Determine if it's reachable code
       - If reachable: add test
       - If unreachable: mark with Stryker disable comment or remove

    5. Re-run coverage to verify improvements
  </action>
  <verify>
    Run: bun test --coverage
    Domain: 99%+ on all metrics.
    Application: 95%+ on all metrics.
  </verify>
  <done>
    Domain layer coverage >= 99% all metrics.
    Application layer coverage >= 95% all metrics.
    All new Phase 12 code has tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fill infrastructure/presentation coverage gaps</name>
  <files>
    src/infrastructure/signals/signal-handler.test.ts
    src/infrastructure/signals/checkpoint-manager.test.ts
    src/infrastructure/database/health-checker.test.ts
    src/infrastructure/database/connection.test.ts
    src/infrastructure/database/schema.test.ts
    src/infrastructure/hooks/hook-runner.test.ts
    src/infrastructure/hooks/hook-installer.test.ts
    src/infrastructure/config/config-manager.test.ts
    src/infrastructure/logging/log-writer.test.ts
    src/infrastructure/logging/error-logger.test.ts
    src/presentation/cli/formatters/error-formatter.test.ts
    src/presentation/cli/commands/sync.test.ts
    src/presentation/cli/commands/search.test.ts
    src/presentation/cli/commands/doctor.test.ts
    src/presentation/cli/commands/export.test.ts
    src/presentation/cli/commands/import.test.ts
    src/presentation/cli/commands/purge.test.ts
    src/presentation/cli/commands/completion.test.ts
    src/presentation/cli/commands/stats.test.ts
    src/presentation/cli/commands/context.test.ts
    src/presentation/cli/commands/list.test.ts
    src/presentation/cli/commands/show.test.ts
  </files>
  <action>
    Fill coverage gaps in infrastructure and presentation layers:

    1. Infrastructure layer (target: 95%, ~10 test files):
       - Check signals/signal-handler.ts edge cases
       - Check signals/checkpoint-manager.ts edge cases
       - Check database/health-checker.ts all paths
       - Check hooks/ files (some low coverage noted in STATE.md)
       - sync-hook-script.ts has 5.75% coverage - this is acceptable
         as it's an entry point script, but add basic tests if feasible

    2. Presentation layer (target: 90%, ~12 test files):
       - Check all new commands (doctor, export, import, purge, completion)
       - Check error-formatter.ts all paths
       - Check edge cases in existing commands
       - Ensure --json flag tested for all commands

    3. For hooks/sync-hook-script.ts:
       - This file is meant to be run as a script
       - Add tests for the exported functions if any
       - Accept lower coverage for entry point code

    4. Specific uncovered lines from initial report:
       - connection.ts:104,116-117 (WAL warning path)
       - schema.ts:291-292 (error path)
       - hook-runner.ts:206-231 (various paths)
       - Add tests for these specific lines

    5. Re-run coverage to verify 95%+ overall
  </action>
  <verify>
    Run: bun test --coverage
    Infrastructure: 95%+ on all metrics (excluding entry points).
    Presentation: 90%+ on all metrics.
    Overall: 95%+ on all metrics.
  </verify>
  <done>
    Infrastructure layer coverage >= 95%.
    Presentation layer coverage >= 90%.
    Overall project coverage >= 95% at EACH metric.
    Coverage report shows green for all thresholds.
  </done>
</task>

</tasks>

<verification>
1. Run: bun test --coverage - All metrics show 95%+
2. Verify domain layer >= 99%
3. Verify no file has critical uncovered paths
4. Verify all new Phase 12 code covered
</verification>

<success_criteria>
1. Statements: >= 95%
2. Branches: >= 95%
3. Functions: >= 95%
4. Lines: >= 95%
5. Domain layer: >= 99% (highest target per CONTEXT.md)
6. No critical error paths untested
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish-error-handling/12-11-SUMMARY.md`
</output>
