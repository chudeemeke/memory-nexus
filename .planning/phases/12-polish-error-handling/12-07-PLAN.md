---
phase: 12-polish-error-handling
plan: 07
type: execute
wave: 3
depends_on: ["12-01", "12-02", "12-03"]
files_modified:
  - src/presentation/cli/commands/search.ts
  - src/presentation/cli/commands/list.ts
  - src/presentation/cli/commands/stats.ts
  - src/presentation/cli/commands/context.ts
  - src/presentation/cli/commands/related.ts
  - src/presentation/cli/commands/show.ts
  - src/presentation/cli/commands/browse.ts
autonomous: true

must_haves:
  truths:
    - "All commands use MemoryNexusError for errors"
    - "All commands exit with code 1 on error"
    - "All commands format errors consistently"
    - "Database errors show appropriate suggestions"
  artifacts:
    - path: "src/presentation/cli/commands/search.ts"
      contains: "formatError"
    - path: "src/presentation/cli/commands/list.ts"
      contains: "formatError"
    - path: "src/presentation/cli/commands/stats.ts"
      contains: "formatError"
  key_links:
    - from: "all CLI commands"
      to: "src/presentation/cli/formatters/error-formatter.ts"
      via: "formatError import"
      pattern: "formatError"
---

<objective>
Apply consistent error handling across all existing CLI commands.

Purpose: Ensure all commands follow the same error handling patterns - using MemoryNexusError, formatting errors appropriately, and exiting with correct codes.

Output: All CLI commands updated with consistent error handling, proper exit codes, and helpful error messages.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-polish-error-handling/12-CONTEXT.md
@src/presentation/cli/commands/search.ts
@src/presentation/cli/commands/list.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update query commands with error handling</name>
  <files>
    src/presentation/cli/commands/search.ts
    src/presentation/cli/commands/search.test.ts
    src/presentation/cli/commands/list.ts
    src/presentation/cli/commands/list.test.ts
    src/presentation/cli/commands/stats.ts
    src/presentation/cli/commands/stats.test.ts
  </files>
  <action>
    Update search, list, and stats commands with consistent error handling:

    1. For each command (search, list, stats):
       - Import formatError, formatErrorJson from formatters
       - Import MemoryNexusError, ErrorCode from domain/errors
       - Wrap action handler in try/catch
       - Catch database errors: wrap in MemoryNexusError(ErrorCode.DB_CONNECTION_FAILED)
       - Catch other errors: preserve MemoryNexusError or wrap unknown
       - Format error based on --json flag
       - Call process.exit(1) on error

    2. Add error handling tests to each command test file:
       - Test database error shows formatted message
       - Test database error exits with code 1
       - Test --json flag outputs JSON error format
       - Mock database to throw errors

    3. Specific patterns:
       - search: Handle empty results gracefully (not an error)
       - list: Handle no sessions found (not an error)
       - stats: Handle empty database (show zeros, not error)
  </action>
  <verify>
    Run: bun test src/presentation/cli/commands/search.test.ts
    Run: bun test src/presentation/cli/commands/list.test.ts
    Run: bun test src/presentation/cli/commands/stats.test.ts
    All tests pass including new error handling tests.
  </verify>
  <done>
    search, list, stats commands use consistent error handling.
    Errors formatted appropriately for output mode.
    Exit code 1 on errors.
    Empty results handled gracefully (not errors).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update navigation commands with error handling</name>
  <files>
    src/presentation/cli/commands/context.ts
    src/presentation/cli/commands/context.test.ts
    src/presentation/cli/commands/related.ts
    src/presentation/cli/commands/related.test.ts
    src/presentation/cli/commands/show.ts
    src/presentation/cli/commands/show.test.ts
    src/presentation/cli/commands/browse.ts
    src/presentation/cli/commands/browse.test.ts
  </files>
  <action>
    Update context, related, show, and browse commands:

    1. For each command:
       - Add same error handling pattern as Task 1
       - Import formatError, formatErrorJson, MemoryNexusError, ErrorCode

    2. Specific error handling:
       - context: PROJECT_NOT_FOUND if no sessions for project
       - related: SESSION_NOT_FOUND if session ID doesn't exist
       - show: SESSION_NOT_FOUND if session ID doesn't exist
       - browse: Handle TTY requirement (warn if not TTY)

    3. Add error handling tests:
       - Test not found errors show appropriate message
       - Test database errors handled
       - Test exit codes correct

    4. Special case for browse:
       - If stdin is not TTY: show warning and suggest 'list' command
       - Not an error, just a helpful message
  </action>
  <verify>
    Run: bun test src/presentation/cli/commands/context.test.ts
    Run: bun test src/presentation/cli/commands/related.test.ts
    Run: bun test src/presentation/cli/commands/show.test.ts
    Run: bun test src/presentation/cli/commands/browse.test.ts
    All tests pass.
  </verify>
  <done>
    context, related, show, browse commands use consistent error handling.
    Not found errors use appropriate error codes.
    Browse warns about TTY requirement.
    All exit codes correct.
  </done>
</task>

</tasks>

<verification>
1. Run: bun test src/presentation/cli/commands - All command tests pass
2. Verify all commands import from error-formatter
3. Verify all commands exit with code 1 on errors
4. Verify --json flag produces structured error output
</verification>

<success_criteria>
1. All query commands (search, list, stats) have consistent error handling
2. All navigation commands (context, related, show, browse) have consistent error handling
3. Not found cases use specific error codes
4. Empty results handled gracefully (not errors)
5. Exit codes follow convention (0 success, 1 error)
6. --json flag works for error output
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish-error-handling/12-07-SUMMARY.md`
</output>
