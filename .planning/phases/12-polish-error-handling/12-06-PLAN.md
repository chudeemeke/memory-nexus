---
phase: 12-polish-error-handling
plan: 06
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/presentation/cli/commands/purge.ts
  - src/presentation/cli/commands/purge.test.ts
  - src/presentation/cli/commands/index.ts
autonomous: true

must_haves:
  truths:
    - "Purge command removes old sessions with confirmation"
    - "Purge uses --older-than flag for age filtering"
    - "Purge shows count before confirmation"
    - "Purge respects --force to skip confirmation"
  artifacts:
    - path: "src/presentation/cli/commands/purge.ts"
      provides: "CLI purge command for data cleanup"
      exports: ["createPurgeCommand"]
  key_links:
    - from: "src/presentation/cli/commands/purge.ts"
      to: "session repository"
      via: "delete by age query"
      pattern: "deleteOlderThan|findOlderThan"
---

<objective>
Implement the purge command for cleaning up old session data.

Purpose: Allow users to manage database size by removing sessions older than a specified age. Essential for long-term maintenance of the memory database.

Output: CLI purge command with age filtering and confirmation prompt.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-polish-error-handling/12-CONTEXT.md
@src/infrastructure/database/repositories/session-repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add purge support to session repository</name>
  <files>
    src/infrastructure/database/repositories/session-repository.ts
    src/infrastructure/database/repositories/session-repository.test.ts
  </files>
  <action>
    Add methods to session repository for purge operations:

    1. Add to SqliteSessionRepository:
       - findOlderThan(date: Date): Session[]
         - Query sessions where updated_at < date
         - Return list of sessions that would be purged

       - countOlderThan(date: Date): number
         - Return count of sessions older than date
         - Efficient for showing preview before purge

       - deleteOlderThan(date: Date): number
         - Delete sessions older than date
         - Cascade deletes to messages, tool_uses, links, entities
         - Return count of deleted sessions

    2. Add tests:
       - Test findOlderThan returns correct sessions
       - Test countOlderThan returns accurate count
       - Test deleteOlderThan removes sessions and cascades
       - Test with various date boundaries
  </action>
  <verify>
    Run: bun test src/infrastructure/database/repositories/session-repository.test.ts
    All tests pass including new purge methods.
  </verify>
  <done>
    Session repository can find, count, and delete sessions by age.
    Cascade deletes work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create purge CLI command</name>
  <files>
    src/presentation/cli/commands/purge.ts
    src/presentation/cli/commands/purge.test.ts
    src/presentation/cli/commands/index.ts
  </files>
  <action>
    Create purge command for data cleanup:

    1. Create src/presentation/cli/commands/purge.ts:
       - Command: memory purge
       - Description: "Remove old sessions from database"
       - Options:
         - --older-than <duration> (required, e.g., "90d", "6m", "1y")
         - --force (skip confirmation prompt)
         - --dry-run (show what would be deleted)
         - --json (output as JSON)
         - --quiet (minimal output)

       parseDuration(duration: string): Date
       - Parse duration strings: "30d" (days), "6m" (months), "1y" (years)
       - Return Date representing cutoff time
       - Throw for invalid format

       Action handler:
       - Parse --older-than duration
       - Count sessions to be deleted
       - If 0: show "No sessions older than X" and exit 0
       - If --dry-run: show list of sessions that would be deleted, exit 0
       - If not --force: prompt "Delete X sessions? (y/n)"
       - On confirmation: delete sessions
       - Show stats: "Deleted X sessions (Y messages, Z tool uses)"
       - Exit 0 on success, 1 on error

    2. Create tests in purge.test.ts:
       - Test command creation and help
       - Test --older-than parsing (days, months, years)
       - Test invalid duration format shows error
       - Test dry-run shows sessions without deleting
       - Test force skips confirmation
       - Test confirmation prompt (mock readline)
       - Test actual deletion (integration)
       - Test zero sessions found case

    3. Update src/presentation/cli/commands/index.ts:
       - Export createPurgeCommand
       - Wire into main CLI
  </action>
  <verify>
    Run: bun test src/presentation/cli/commands/purge.test.ts
    All tests pass.
    Verify command appears in --help.
  </verify>
  <done>
    Purge command parses duration correctly.
    Dry-run shows what would be deleted.
    Confirmation prompt prevents accidental deletion.
    --force bypasses confirmation.
    Stats shown after deletion.
  </done>
</task>

</tasks>

<verification>
1. Run: bun test src/infrastructure/database/repositories/session-repository.test.ts - All tests pass
2. Run: bun test src/presentation/cli/commands/purge.test.ts - All tests pass
3. Verify cascade deletes remove related data
4. Verify --dry-run doesn't modify database
</verification>

<success_criteria>
1. Duration parsing handles days, months, years
2. Count shown before confirmation
3. Dry-run shows sessions without deleting
4. --force skips confirmation
5. Cascade deletes remove messages, tool uses, etc.
6. Stats shown after purge
7. Zero found case handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish-error-handling/12-06-SUMMARY.md`
</output>
