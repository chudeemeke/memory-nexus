---
phase: 12-polish-error-handling
plan: 05
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/application/services/export-service.ts
  - src/application/services/export-service.test.ts
  - src/presentation/cli/commands/export.ts
  - src/presentation/cli/commands/export.test.ts
  - src/presentation/cli/commands/import.ts
  - src/presentation/cli/commands/import.test.ts
  - src/presentation/cli/commands/index.ts
autonomous: true

must_haves:
  truths:
    - "User can export database to JSON file"
    - "User can import from JSON backup file"
    - "Export includes version for compatibility"
    - "Import validates format before importing"
  artifacts:
    - path: "src/application/services/export-service.ts"
      provides: "Export and import logic"
      exports: ["exportToJson", "importFromJson", "ExportData"]
    - path: "src/presentation/cli/commands/export.ts"
      provides: "CLI export command"
      exports: ["createExportCommand"]
    - path: "src/presentation/cli/commands/import.ts"
      provides: "CLI import command"
      exports: ["createImportCommand"]
  key_links:
    - from: "src/application/services/export-service.ts"
      to: "database repositories"
      via: "data extraction queries"
      pattern: "sessionRepo|messageRepo"
---

<objective>
Implement export and import commands for database backup and restore.

Purpose: Allow users to backup their memory database and restore from backup. Essential for data portability and disaster recovery.

Output: Export service for JSON serialization, and CLI commands for export/import operations.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-polish-error-handling/12-CONTEXT.md
@src/infrastructure/database/repositories/session-repository.ts
@src/infrastructure/database/repositories/message-repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export/import service</name>
  <files>
    src/application/services/export-service.ts
    src/application/services/export-service.test.ts
    src/application/index.ts
  </files>
  <action>
    Create export/import service for JSON backup:

    1. Create src/application/services/export-service.ts:
       - Interface ExportData:
         - version: string (e.g., "1.0")
         - exportedAt: string (ISO timestamp)
         - stats: { sessions: number; messages: number; toolUses: number; entities: number }
         - sessions: SessionExport[]
         - messages: MessageExport[]
         - toolUses: ToolUseExport[]
         - entities: EntityExport[]
         - links: LinkExport[]

       - Interface SessionExport (match domain Session fields)
       - Interface MessageExport (match domain Message fields)
       - etc. for each entity type

       - exportToJson(db: Database, outputPath: string): ExportStats
         - Query all tables
         - Build ExportData structure
         - Write to file using Bun.write (streaming for large data)
         - Return stats: { sessions, messages, toolUses, entities, links, bytes }

       - validateExportFile(path: string): { valid: boolean; version?: string; error?: string }
         - Check file exists
         - Parse JSON header to get version
         - Validate required fields present
         - Return validation result

       - importFromJson(db: Database, inputPath: string, options: { clearExisting?: boolean }): ImportStats
         - Validate file first
         - If clearExisting: truncate all tables
         - Insert sessions, messages, tool uses, entities, links
         - Use batched inserts for performance
         - Return stats: { sessions, messages, toolUses, entities, links }

    2. Create tests in export-service.test.ts:
       - Test exportToJson creates valid JSON file
       - Test export includes all data types
       - Test export version field present
       - Test validateExportFile with valid file
       - Test validateExportFile with invalid/missing file
       - Test importFromJson restores data correctly
       - Test importFromJson with clearExisting option
       - Test import handles version mismatch gracefully

    3. Update src/application/index.ts:
       - Add export * from "./services/export-service.js"
  </action>
  <verify>
    Run: bun test src/application/services/export-service.test.ts
    All tests pass.
    Verify export file format is valid JSON.
  </verify>
  <done>
    exportToJson creates complete backup file.
    importFromJson restores data correctly.
    Validation catches invalid files.
    Stats returned for user feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create export and import CLI commands</name>
  <files>
    src/presentation/cli/commands/export.ts
    src/presentation/cli/commands/export.test.ts
    src/presentation/cli/commands/import.ts
    src/presentation/cli/commands/import.test.ts
    src/presentation/cli/commands/index.ts
  </files>
  <action>
    Create CLI commands for export and import:

    1. Create src/presentation/cli/commands/export.ts:
       - Command: memory export <output-file>
       - Description: "Export database to JSON file for backup"
       - Options:
         - --quiet (suppress output except path)
         - --json (output stats as JSON)

       Action handler:
       - Initialize database
       - Call exportToJson
       - Display stats: "Exported X sessions, Y messages to <path>"
       - Exit 0 on success, 1 on error

    2. Create tests in export.test.ts:
       - Test command creation and help
       - Test export creates file at specified path
       - Test --quiet suppresses output
       - Test --json outputs stats as JSON
       - Test error handling for invalid path

    3. Create src/presentation/cli/commands/import.ts:
       - Command: memory import <input-file>
       - Description: "Import database from JSON backup file"
       - Options:
         - --clear (clear existing data before import)
         - --quiet (suppress output)
         - --json (output stats as JSON)

       Action handler:
       - Validate file first
       - If invalid: show error, exit 1
       - If --clear not specified and data exists: prompt for confirmation
       - Call importFromJson
       - Display stats: "Imported X sessions, Y messages"
       - Exit 0 on success, 1 on error

    4. Create tests in import.test.ts:
       - Test command creation and help
       - Test import from valid file
       - Test import validation failure shows error
       - Test --clear option works
       - Test confirmation prompt when data exists

    5. Update src/presentation/cli/commands/index.ts:
       - Export createExportCommand, createImportCommand
       - Wire into main CLI
  </action>
  <verify>
    Run: bun test src/presentation/cli/commands/export.test.ts
    Run: bun test src/presentation/cli/commands/import.test.ts
    All tests pass.
    Verify commands appear in --help output.
  </verify>
  <done>
    Export command saves database to JSON file.
    Import command restores from JSON file.
    Validation prevents importing invalid files.
    Confirmation prompt prevents accidental data loss.
  </done>
</task>

</tasks>

<verification>
1. Run: bun test src/application/services/export-service.test.ts - All export service tests pass
2. Run: bun test src/presentation/cli/commands/export.test.ts - All export command tests pass
3. Run: bun test src/presentation/cli/commands/import.test.ts - All import command tests pass
4. Verify round-trip: export then import produces identical data
</verification>

<success_criteria>
1. Export creates complete JSON backup with version field
2. Import restores data correctly
3. Validation catches invalid/corrupted files
4. --clear option works for fresh import
5. Stats displayed after both operations
6. Error handling with appropriate exit codes
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish-error-handling/12-05-SUMMARY.md`
</output>
