---
phase: 12-polish-error-handling
plan: 04
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - src/application/services/sync-service.ts
  - src/application/services/sync-service.test.ts
  - src/presentation/cli/commands/sync.ts
  - src/presentation/cli/commands/sync.test.ts
autonomous: true

must_haves:
  truths:
    - "Sync command exits with code 1 on failure"
    - "Ctrl+C during sync saves checkpoint and exits cleanly"
    - "Recovery notice shown on next run after interrupted sync"
    - "Errors use structured MemoryNexusError with context"
  artifacts:
    - path: "src/application/services/sync-service.ts"
      provides: "Enhanced sync with checkpoint and abort support"
      contains: "shouldAbort"
    - path: "src/presentation/cli/commands/sync.ts"
      provides: "Sync command with error handling and recovery"
      contains: "formatError"
  key_links:
    - from: "src/application/services/sync-service.ts"
      to: "src/infrastructure/signals/signal-handler.ts"
      via: "shouldAbort check in loop"
      pattern: "shouldAbort\\(\\)"
    - from: "src/application/services/sync-service.ts"
      to: "src/infrastructure/signals/checkpoint-manager.ts"
      via: "checkpoint save/load"
      pattern: "saveCheckpoint|loadCheckpoint"
---

<objective>
Integrate error handling and signal management into the sync command.

Purpose: Make the sync command robust against interruption, providing graceful shutdown with progress recovery. Users can safely Ctrl+C without losing work.

Output: Enhanced sync service with checkpoint support, and CLI command with proper error handling and exit codes.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-polish-error-handling/12-CONTEXT.md
@src/application/services/sync-service.ts
@src/presentation/cli/commands/sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkpoint and abort support to SyncService</name>
  <files>
    src/application/services/sync-service.ts
    src/application/services/sync-service.test.ts
  </files>
  <action>
    Enhance SyncService with checkpoint and abort support:

    1. Update SyncService interface/options:
       - Add optional checkpointEnabled?: boolean to SyncOptions
       - Add onSessionComplete?: (sessionId: string) => void callback

    2. Add checkpoint integration to sync():
       - At start: check loadCheckpoint() - if exists, show recovery notice
       - Get completedSessionIds from checkpoint
       - Filter sessions to skip already completed ones
       - Save checkpoint after each successful session
       - Clear checkpoint on successful completion

    3. Add abort checking to session loop:
       - Import shouldAbort from signals
       - Check shouldAbort() before processing each session
       - If should abort: save checkpoint, return partial result
       - Add aborted: boolean to SyncResult

    4. Wrap errors in MemoryNexusError:
       - Import MemoryNexusError and ErrorCode
       - File access errors: SOURCE_INACCESSIBLE with path context
       - JSON parse errors: INVALID_JSON with file and line context
       - Database errors: DB_CONNECTION_FAILED, DB_LOCKED as appropriate

    5. Add tests:
       - Test checkpoint is loaded at start
       - Test checkpoint is saved after each session
       - Test checkpoint is cleared on completion
       - Test abort check stops processing
       - Test errors wrapped in MemoryNexusError
  </action>
  <verify>
    Run: bun test src/application/services/sync-service.test.ts
    All tests pass including new checkpoint and abort tests.
  </verify>
  <done>
    SyncService loads checkpoint and skips completed sessions.
    SyncService saves checkpoint after each session.
    SyncService respects shouldAbort() and stops cleanly.
    Errors wrapped in MemoryNexusError with appropriate context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sync CLI command with error handling</name>
  <files>
    src/presentation/cli/commands/sync.ts
    src/presentation/cli/commands/sync.test.ts
  </files>
  <action>
    Update sync command with proper error handling:

    1. Add signal handler setup:
       - Import setupSignalHandlers, registerCleanup from signals
       - Import closeDatabase from database/connection
       - Call setupSignalHandlers() at command start
       - Register database close as cleanup

    2. Add recovery notice display:
       - Import loadCheckpoint, hasCheckpoint from signals
       - At command start: check hasCheckpoint()
       - If checkpoint exists, show notice:
         "Resuming from previous interrupted sync (X/Y sessions done)"

    3. Add error handling wrapper:
       - Import formatError, formatErrorJson from formatters
       - Wrap action in try/catch
       - On error: format appropriately (JSON vs default)
       - Exit with code 1 on error

    4. Add --dry-run option:
       - Show what would be synced without syncing
       - List sessions to be processed
       - Show recovery info if checkpoint exists

    5. Update tests:
       - Test recovery notice shown when checkpoint exists
       - Test signal handlers registered
       - Test error formatted correctly (both modes)
       - Test exit code 1 on error
       - Test --dry-run lists sessions without syncing
  </action>
  <verify>
    Run: bun test src/presentation/cli/commands/sync.test.ts
    All tests pass including new error handling tests.
  </verify>
  <done>
    Sync command shows recovery notice when resuming.
    Ctrl+C triggers signal handler and saves checkpoint.
    Errors displayed with context and suggestions.
    Exit code 1 on failure, 0 on success.
    --dry-run shows what would sync without syncing.
  </done>
</task>

</tasks>

<verification>
1. Run: bun test src/application/services/sync-service.test.ts - All tests pass
2. Run: bun test src/presentation/cli/commands/sync.test.ts - All tests pass
3. Verify checkpoint integration works end-to-end
4. Verify exit codes: 0 for success, 1 for failure
</verification>

<success_criteria>
1. Interrupted sync saves progress via checkpoint
2. Next sync run shows recovery notice and resumes
3. Completed sync clears checkpoint
4. Errors use MemoryNexusError with appropriate codes
5. CLI displays errors with context and suggestions
6. Exit codes follow convention (0 success, 1 failure)
7. --dry-run works without modifying database
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish-error-handling/12-04-SUMMARY.md`
</output>
