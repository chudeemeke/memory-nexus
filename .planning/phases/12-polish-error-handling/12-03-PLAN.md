---
phase: 12-polish-error-handling
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/database/health-checker.ts
  - src/infrastructure/database/health-checker.test.ts
  - src/infrastructure/database/index.ts
  - src/presentation/cli/commands/doctor.ts
  - src/presentation/cli/commands/doctor.test.ts
  - src/presentation/cli/commands/index.ts
autonomous: true

must_haves:
  truths:
    - "Doctor command checks database integrity"
    - "Doctor command checks file permissions"
    - "Doctor command checks hook installation status"
    - "Doctor command checks config validity"
  artifacts:
    - path: "src/infrastructure/database/health-checker.ts"
      provides: "Database and system health verification"
      exports: ["checkDatabaseIntegrity", "checkQuickIntegrity", "runHealthCheck", "HealthCheckResult"]
    - path: "src/presentation/cli/commands/doctor.ts"
      provides: "CLI doctor command"
      exports: ["createDoctorCommand"]
  key_links:
    - from: "src/infrastructure/database/health-checker.ts"
      to: "PRAGMA integrity_check"
      via: "SQLite integrity verification"
      pattern: "integrity_check"
    - from: "src/presentation/cli/commands/doctor.ts"
      to: "src/infrastructure/database/health-checker.ts"
      via: "runHealthCheck"
      pattern: "runHealthCheck"
---

<objective>
Implement database health checking and the `memory doctor` command.

Purpose: Provide users with a diagnostic tool to verify system health - database integrity, file permissions, hook status, and configuration validity. Essential for troubleshooting issues.

Output: Health checker infrastructure and CLI doctor command with clear status output.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-polish-error-handling/12-CONTEXT.md
@.planning/phases/12-polish-error-handling/12-RESEARCH.md
@src/infrastructure/database/connection.ts
@src/infrastructure/hooks/config-manager.ts
@src/infrastructure/hooks/settings-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health checker infrastructure</name>
  <files>
    src/infrastructure/database/health-checker.ts
    src/infrastructure/database/health-checker.test.ts
    src/infrastructure/database/index.ts
  </files>
  <action>
    Create health checking utilities:

    1. Create src/infrastructure/database/health-checker.ts:
       - Interface HealthCheckResult:
         - database: { exists: boolean; readable: boolean; writable: boolean; integrity: "ok" | "corrupted" | "unknown"; size: number }
         - permissions: { configDir: boolean; logsDir: boolean; sourceDir: boolean }
         - hooks: { installed: boolean; enabled: boolean; lastRun: Date | null }
         - config: { valid: boolean; issues: string[] }

       - checkDatabaseIntegrity(db: Database): "ok" | "corrupted"
         - Run PRAGMA integrity_check(1)
         - Return "ok" if result is "ok", else "corrupted"
         - Catch exceptions and return "corrupted"

       - checkQuickIntegrity(db: Database): "ok" | "corrupted"
         - Run PRAGMA quick_check(1) for faster startup check
         - Same return logic as checkDatabaseIntegrity

       - checkDirectoryPermissions(path: string): { readable: boolean; writable: boolean }
         - Check fs.accessSync with R_OK and W_OK
         - Handle errors gracefully

       - checkHookStatus(): { installed: boolean; enabled: boolean; lastRun: Date | null }
         - Check if hook exists in Claude Code settings
         - Check if autoSync enabled in config
         - Get lastRun from log file

       - checkConfigValidity(): { valid: boolean; issues: string[] }
         - Load config and validate each field type
         - Collect issues (e.g., "logLevel invalid", "timeout not a number")

       - runHealthCheck(): HealthCheckResult
         - Orchestrate all checks
         - Return comprehensive result
         - Handle partial failures gracefully

    2. Create tests in health-checker.test.ts:
       - Test checkDatabaseIntegrity with valid database
       - Test checkDatabaseIntegrity with corrupted database (manually corrupt)
       - Test checkQuickIntegrity performance
       - Test checkDirectoryPermissions for existing/non-existing paths
       - Test checkConfigValidity with valid/invalid configs
       - Test runHealthCheck returns complete result

    3. Update src/infrastructure/database/index.ts:
       - Add export * from "./health-checker.js"
  </action>
  <verify>
    Run: bun test src/infrastructure/database/health-checker.test.ts
    All tests pass.
    Verify integrity checks use correct PRAGMA commands.
  </verify>
  <done>
    checkDatabaseIntegrity and checkQuickIntegrity work correctly.
    Permission checks handle all edge cases.
    runHealthCheck returns complete HealthCheckResult.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create doctor CLI command</name>
  <files>
    src/presentation/cli/commands/doctor.ts
    src/presentation/cli/commands/doctor.test.ts
    src/presentation/cli/commands/index.ts
  </files>
  <action>
    Create the doctor command for health checks:

    1. Create src/presentation/cli/commands/doctor.ts:
       - Import runHealthCheck from infrastructure
       - Import color utilities (green, red, yellow, dim)
       - Import HealthCheckResult type

       createDoctorCommand(): Command
       - Command: memory doctor
       - Description: "Check system health and diagnose issues"
       - Options: --json (output as JSON), --fix (attempt auto-fixes)

       Action handler:
       - Run runHealthCheck()
       - Format output based on --json flag

       formatHealthResult(result: HealthCheckResult, json: boolean): string
       - JSON mode: return JSON.stringify(result, null, 2)
       - Default mode: format as readable checklist:
         "Database"
         "  [check] Exists: ~/.memory-nexus/memory.db"
         "  [check] Integrity: ok"
         "  [check] Size: 2.4 MB"
         "Permissions"
         "  [check] Config directory: readable/writable"
         "  [x] Logs directory: not writable"
         "Hooks"
         "  [check] Installed: yes"
         "  [check] Enabled: yes"
         "  [dim] Last run: 2 hours ago"
         "Config"
         "  [check] Valid"

       - Use green for passing, red for failing, yellow for warnings
       - Show overall status at end: "All checks passed" or "N issues found"

       handleFix(result: HealthCheckResult): void
       - If --fix specified:
         - Create missing directories
         - Offer to recreate corrupted database (prompt user)
         - Note: some issues can't be auto-fixed

    2. Create tests in doctor.test.ts:
       - Test command creation and help text
       - Test JSON output format
       - Test default output format (mock runHealthCheck)
       - Test with all checks passing
       - Test with some checks failing
       - Test --fix creates missing directories

    3. Update src/presentation/cli/commands/index.ts:
       - Add export { createDoctorCommand } from "./doctor.js"
       - Add to program in cli/index.ts
  </action>
  <verify>
    Run: bun test src/presentation/cli/commands/doctor.test.ts
    All tests pass.
    Run: memory doctor --help (shows correct options)
  </verify>
  <done>
    Doctor command runs all health checks.
    Default output shows readable checklist with colors.
    JSON output returns structured HealthCheckResult.
    --fix attempts automatic remediation where possible.
  </done>
</task>

</tasks>

<verification>
1. Run: bun test src/infrastructure/database/health-checker.test.ts - All health checker tests pass
2. Run: bun test src/presentation/cli/commands/doctor.test.ts - All doctor command tests pass
3. Verify PRAGMA integrity_check used correctly
4. Verify color output respects TTY detection
</verification>

<success_criteria>
1. checkDatabaseIntegrity detects corruption correctly
2. checkQuickIntegrity is faster than full check
3. All permission checks work on both existing and missing paths
4. Doctor command shows clear pass/fail status for each check
5. --json outputs valid, parseable JSON
6. --fix creates missing directories
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish-error-handling/12-03-SUMMARY.md`
</output>
