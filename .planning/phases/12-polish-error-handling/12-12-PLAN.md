---
phase: 12-polish-error-handling
plan: 12
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/presentation/cli/commands/completion.ts
  - src/presentation/cli/commands/completion.test.ts
  - src/presentation/cli/commands/index.ts
  - src/presentation/cli/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can generate shell completion scripts for bash, zsh, and fish"
    - "Completion command outputs valid shell script"
    - "User can install completions with single command"
  artifacts:
    - path: "src/presentation/cli/commands/completion.ts"
      provides: "Shell completion command"
      exports: ["createCompletionCommand"]
    - path: "package.json"
      provides: "@gutenye/commander-completion-carapace dependency"
  key_links:
    - from: "src/presentation/cli/commands/completion.ts"
      to: "@gutenye/commander-completion-carapace"
      via: "library import"
      pattern: "commander-completion-carapace"
    - from: "src/presentation/cli/index.ts"
      to: "completion command"
      via: "command registration"
      pattern: "createCompletionCommand|completion"
---

<objective>
Implement shell completion command for bash, zsh, and fish shells.

Purpose: Improve CLI usability by providing tab-completion for commands, options, and arguments. This is a standard CLI best practice that significantly improves user experience.

Output: Shell completion command using @gutenye/commander-completion-carapace library.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-polish-error-handling/12-CONTEXT.md
@.planning/phases/12-polish-error-handling/12-RESEARCH.md
@src/presentation/cli/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add commander-completion-carapace dependency</name>
  <files>
    package.json
  </files>
  <action>
    Add shell completion library:

    1. Update package.json:
       - Add dependency: @gutenye/commander-completion-carapace: ^1.0.9
       - This library provides multi-shell completion support (bash, zsh, fish)
       - Integrates directly with Commander.js

    2. Run: bun install

    Note: This library was selected in 12-RESEARCH.md as the standard for
    Commander.js shell completions with multi-shell support.
  </action>
  <verify>
    Run: bun install
    Verify package installed without errors.
    Check node_modules/@gutenye/commander-completion-carapace exists.
  </verify>
  <done>
    @gutenye/commander-completion-carapace installed.
    Package.json updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create completion command with tests</name>
  <files>
    src/presentation/cli/commands/completion.ts
    src/presentation/cli/commands/completion.test.ts
    src/presentation/cli/commands/index.ts
    src/presentation/cli/index.ts
  </files>
  <action>
    Create shell completion command:

    1. Create src/presentation/cli/commands/completion.ts:
       - Import from @gutenye/commander-completion-carapace
       - Command: memory completion <shell>
       - Shell argument: bash | zsh | fish
       - Description: "Generate shell completion script"

       Action handler:
       - Validate shell argument is one of: bash, zsh, fish
       - Generate completion script using library
       - Output script to stdout (user pipes to file or sources directly)
       - Include usage instructions in --help:
         ```
         Usage:
           # Bash (add to ~/.bashrc)
           eval "$(memory completion bash)"

           # Zsh (add to ~/.zshrc)
           eval "$(memory completion zsh)"

           # Fish (add to ~/.config/fish/completions/memory.fish)
           memory completion fish > ~/.config/fish/completions/memory.fish
         ```

    2. Enable completion on main program:
       - Update src/presentation/cli/index.ts
       - Call enableCompletion() on program instance
       - This enables the library to introspect all commands

    3. Create tests in completion.test.ts:
       - Test command creation and help
       - Test bash completion outputs valid script (contains 'complete' or 'compgen')
       - Test zsh completion outputs valid script (contains 'compdef' or '_arguments')
       - Test fish completion outputs valid script (contains 'complete -c')
       - Test invalid shell argument shows error
       - Test --help includes usage examples

    4. Update src/presentation/cli/commands/index.ts:
       - Export createCompletionCommand
       - Wire into main CLI
  </action>
  <verify>
    Run: bun test src/presentation/cli/commands/completion.test.ts
    All tests pass.
    Run: bun run src/presentation/cli/index.ts completion bash
    Verify output contains bash completion syntax.
  </verify>
  <done>
    completion command generates scripts for bash, zsh, fish.
    Scripts are valid shell syntax.
    Usage instructions in --help.
    Invalid shell argument handled with error.
  </done>
</task>

</tasks>

<verification>
1. Run: bun test src/presentation/cli/commands/completion.test.ts - All tests pass
2. Run: memory completion bash | head - Outputs valid bash completion
3. Run: memory completion zsh | head - Outputs valid zsh completion
4. Run: memory completion fish | head - Outputs valid fish completion
5. Run: memory completion invalid - Shows error for invalid shell
</verification>

<success_criteria>
1. completion command registered and appears in --help
2. Generates valid bash completion script
3. Generates valid zsh completion script
4. Generates valid fish completion script
5. Invalid shell argument shows helpful error
6. Usage instructions included in command help
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish-error-handling/12-12-SUMMARY.md`
</output>
