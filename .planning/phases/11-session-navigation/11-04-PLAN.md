---
phase: 11-session-navigation
plan: 04
type: execute
wave: 4
depends_on: ["11-03"]
files_modified:
  - src/presentation/cli/pickers/session-picker.ts
  - src/presentation/cli/pickers/session-picker.test.ts
  - src/presentation/cli/pickers/index.ts
  - src/presentation/cli/commands/browse.ts
  - src/presentation/cli/commands/browse.test.ts
  - src/presentation/cli/commands/index.ts
  - package.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Interactive picker shows sessions with project name and relative time"
    - "User can type to filter sessions (fuzzy search)"
    - "Selection opens action menu with Show/Search/Context/Related options"
    - "Non-TTY mode falls back to error with hint to use --session flag"
  artifacts:
    - path: "src/presentation/cli/pickers/session-picker.ts"
      provides: "Interactive session picker"
      exports: ["sessionPicker", "PickerResult"]
    - path: "src/presentation/cli/commands/browse.ts"
      provides: "Browse command handler"
      exports: ["createBrowseCommand"]
  key_links:
    - from: "src/presentation/cli/pickers/session-picker.ts"
      to: "@inquirer/search"
      via: "import search"
      pattern: "import.*search.*@inquirer/search"
    - from: "src/presentation/cli/commands/browse.ts"
      to: "src/presentation/cli/pickers/session-picker.ts"
      via: "sessionPicker"
      pattern: "sessionPicker"
---

<objective>
Implement interactive session picker with fzf-style search and action menu for session navigation.

Purpose: Enable discovery and navigation of sessions through interactive UI (NAV-05).
Output: Working interactive picker with fuzzy search, action menu, and browse command integration.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-session-navigation/11-CONTEXT.md
@.planning/phases/11-session-navigation/11-RESEARCH.md
@.planning/phases/11-session-navigation/11-03-SUMMARY.md
@src/presentation/cli/commands/list.ts
@src/presentation/cli/formatters/timestamp-formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create session picker</name>
  <files>package.json, src/presentation/cli/pickers/session-picker.ts, src/presentation/cli/pickers/session-picker.test.ts, src/presentation/cli/pickers/index.ts</files>
  <action>
Install @inquirer/search, @inquirer/select, and fuzzy:
```bash
bun add @inquirer/search @inquirer/select fuzzy
bun add -d @types/fuzzy
```

Create src/presentation/cli/pickers/ directory structure.

Implement session picker using @inquirer/search:

```typescript
import { search } from '@inquirer/search';
import { select } from '@inquirer/select';
import fuzzy from 'fuzzy';
import type { Session } from '../../../domain/entities/session.js';
import type { ISessionRepository } from '../../../domain/ports/repositories.js';
import { formatRelativeTime } from '../formatters/timestamp-formatter.js';

export type PickerAction = 'show' | 'search' | 'context' | 'related' | 'cancel';

export interface PickerResult {
  sessionId: string;
  action: PickerAction;
}

export interface SessionPickerOptions {
  sessionRepo: ISessionRepository;
  limit?: number;  // Default 100
}

/**
 * Interactive session picker with fuzzy search.
 *
 * @throws Error if not running in TTY mode
 * @returns PickerResult or null if cancelled
 */
export async function sessionPicker(
  options: SessionPickerOptions
): Promise<PickerResult | null> {
  // Check TTY
  if (!process.stdout.isTTY) {
    throw new Error(
      'Interactive picker requires TTY. Use --session <id> instead.'
    );
  }

  const { sessionRepo, limit = 100 } = options;

  // Load sessions once for fuzzy filtering
  const sessions = await sessionRepo.findFiltered({ limit });

  // Build searchable choices
  const choices = sessions.map(s => ({
    value: s.id,
    name: `${s.projectPath.projectName} (${formatRelativeTime(s.startTime)})`,
    description: `${s.id.substring(0, 8)}... | ${s.messages.length} messages`,
  }));

  // Search prompt with fuzzy filtering
  const sessionId = await search<string>({
    message: 'Search sessions (type to filter):',
    source: async (term, { signal }) => {
      if (signal.aborted) return [];

      if (!term) {
        return choices;
      }

      // Fuzzy filter
      const results = fuzzy.filter(term, choices, {
        extract: (c) => `${c.name} ${c.description}`,
      });

      return results.map(r => r.original);
    },
    pageSize: 10,
  });

  // Action menu
  const action = await select<PickerAction>({
    message: 'Action:',
    choices: [
      { value: 'show', name: 'Show session details' },
      { value: 'search', name: 'Search within session' },
      { value: 'context', name: 'Get project context' },
      { value: 'related', name: 'Find related sessions' },
      { value: 'cancel', name: 'Cancel' },
    ],
  });

  if (action === 'cancel') {
    return null;
  }

  return { sessionId, action };
}

/**
 * Check if interactive mode is available.
 */
export function canUseInteractivePicker(): boolean {
  return process.stdout.isTTY === true;
}
```

Create pickers/index.ts exporting sessionPicker and canUseInteractivePicker.

Tests (mocking @inquirer modules):
1. sessionPicker() throws Error when not TTY
2. canUseInteractivePicker() returns false when not TTY
3. canUseInteractivePicker() returns true when TTY
4. sessionPicker() returns PickerResult with selected action
5. sessionPicker() returns null when action is cancel
6. Fuzzy filter reduces choices based on search term
7. Choices include project name and relative time
8. Choices include truncated session ID
  </action>
  <verify>bun test src/presentation/cli/pickers/session-picker.test.ts -- passes all tests</verify>
  <done>Session picker implemented with @inquirer/search, fuzzy filtering, and action menu</done>
</task>

<task type="auto">
  <name>Task 2: Create browse command that uses picker</name>
  <files>src/presentation/cli/commands/browse.ts, src/presentation/cli/commands/browse.test.ts, src/presentation/cli/commands/index.ts</files>
  <action>
Create browse command that launches interactive picker and dispatches to appropriate action.

```typescript
import { Command } from 'commander';
import { sessionPicker, canUseInteractivePicker } from '../pickers/session-picker.js';
import { SqliteSessionRepository } from '../../../infrastructure/database/repositories/session-repository.js';
import { executeShowCommand } from './show.js';
import { executeSearchCommand } from './search.js';
import { executeContextCommand } from './context.js';
import { executeRelatedCommand } from './related.js';
import {
  initializeDatabase,
  closeDatabase,
  getDefaultDbPath,
} from '../../../infrastructure/database/index.js';

export function createBrowseCommand(): Command {
  return new Command('browse')
    .description('Interactive session browser')
    .option('-l, --limit <count>', 'Maximum sessions to show', '100')
    .action(async (options: BrowseCommandOptions) => {
      await executeBrowseCommand(options);
    });
}

export async function executeBrowseCommand(
  options: BrowseCommandOptions
): Promise<void> {
  // Check TTY availability
  if (!canUseInteractivePicker()) {
    console.error('Error: Interactive mode requires a terminal.');
    console.error('Use specific commands instead:');
    console.error('  memory list          - List sessions');
    console.error('  memory show <id>     - Show session details');
    console.error('  memory search <q>    - Search sessions');
    process.exitCode = 1;
    return;
  }

  const limit = parseInt(options.limit ?? '100', 10);
  const dbPath = getDefaultDbPath();
  const { db } = initializeDatabase({ path: dbPath });

  try {
    const sessionRepo = new SqliteSessionRepository(db);

    // Launch picker
    const result = await sessionPicker({ sessionRepo, limit });

    if (!result) {
      // User cancelled
      return;
    }

    // Close DB before dispatching (commands manage their own connections)
    closeDatabase(db);

    // Dispatch to appropriate command
    switch (result.action) {
      case 'show':
        await executeShowCommand(result.sessionId, {});
        break;
      case 'search':
        await executeSearchCommand({ session: result.sessionId });
        break;
      case 'context':
        // Extract project name from session
        const { db: db2 } = initializeDatabase({ path: dbPath });
        const repo = new SqliteSessionRepository(db2);
        const session = await repo.findById(result.sessionId);
        closeDatabase(db2);
        if (session) {
          await executeContextCommand(session.projectPath.projectName, {});
        }
        break;
      case 'related':
        await executeRelatedCommand(result.sessionId, {});
        break;
    }
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error);
    console.error(`Error: ${message}`);
    process.exitCode = 2;
    closeDatabase(db);
  }
}
```

Register in commands/index.ts (add to exports and program).

Tests:
1. createBrowseCommand() returns Command with 'browse' name
2. executeBrowseCommand() errors in non-TTY with helpful message
3. executeBrowseCommand() exits cleanly on user cancel
4. executeBrowseCommand() dispatches to show command
5. executeBrowseCommand() dispatches to search command with session filter
6. executeBrowseCommand() dispatches to context command with project
7. executeBrowseCommand() dispatches to related command
8. --limit option passed to picker
  </action>
  <verify>bun test src/presentation/cli/commands/browse.test.ts -- passes all tests</verify>
  <done>Browse command implemented with interactive picker integration and action dispatch</done>
</task>

</tasks>

<verification>
- `bun test src/presentation/cli/pickers/session-picker.test.ts` - Picker tests pass
- `bun test src/presentation/cli/commands/browse.test.ts` - Command tests pass
- `bun run memory browse --help` shows command usage
- Manual test: `bun run memory browse` launches interactive picker (TTY only)
- Non-TTY test: `echo "" | bun run memory browse` shows error message
</verification>

<success_criteria>
1. Interactive picker shows sessions with project name and relative time
2. User can type to filter sessions (fuzzy search via fuzzy library)
3. Selection opens action menu with Show/Search/Context/Related/Cancel options
4. Each action dispatches to appropriate command
5. Non-TTY mode shows helpful error with command alternatives
6. --limit option controls number of sessions loaded
7. User cancel returns cleanly (no error)
8. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-navigation/11-04-SUMMARY.md`
</output>
