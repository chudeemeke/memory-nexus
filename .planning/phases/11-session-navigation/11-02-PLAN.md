---
phase: 11-session-navigation
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/infrastructure/database/repositories/entity-repository.ts
  - src/infrastructure/database/repositories/entity-repository.test.ts
  - src/infrastructure/database/repositories/index.ts
  - src/application/services/pattern-extractor.ts
  - src/application/services/pattern-extractor.test.ts
  - src/application/services/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Entity repository persists entities with INSERT OR REPLACE for deduplication"
    - "Pattern extractor extracts file paths from tool uses"
    - "Pattern extractor extracts file modifications (Write, Edit, NotebookEdit)"
    - "Pattern extractor extracts tool usage statistics"
  artifacts:
    - path: "src/infrastructure/database/repositories/entity-repository.ts"
      provides: "SqliteEntityRepository"
      exports: ["SqliteEntityRepository"]
    - path: "src/application/services/pattern-extractor.ts"
      provides: "Pattern-based entity extraction"
      exports: ["PatternExtractor"]
  key_links:
    - from: "src/application/services/pattern-extractor.ts"
      to: "src/domain/entities/tool-use.ts"
      via: "import ToolUse"
      pattern: "import.*ToolUse"
    - from: "src/infrastructure/database/repositories/entity-repository.ts"
      to: "src/domain/entities/entity.ts"
      via: "import Entity"
      pattern: "import.*Entity"
---

<objective>
Implement SqliteEntityRepository for entity persistence and PatternExtractor for extracting file paths and tool usage from sessions.

Purpose: Enable persistence of extracted entities and pattern-based extraction of file paths and modifications (EXTR-02, EXTR-01).
Output: Working entity repository with deduplication, pattern extractor for file/tool extraction.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-session-navigation/11-CONTEXT.md
@.planning/phases/11-session-navigation/11-RESEARCH.md
@.planning/phases/11-session-navigation/11-01-SUMMARY.md
@src/infrastructure/database/repositories/tool-use-repository.ts
@src/infrastructure/database/repositories/session-repository.ts
@src/domain/entities/entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SqliteEntityRepository</name>
  <files>src/infrastructure/database/repositories/entity-repository.ts, src/infrastructure/database/repositories/entity-repository.test.ts, src/infrastructure/database/repositories/index.ts</files>
  <action>
Create SqliteEntityRepository implementing IEntityRepository. Follow existing repository patterns (prepared statements, transaction batching).

Key implementation details:

```typescript
export class SqliteEntityRepository implements IEntityRepository {
  // Prepared statements
  private readonly findByIdStmt: Statement;
  private readonly findByNameStmt: Statement;
  private readonly findBySessionStmt: Statement;
  private readonly findByTypeStmt: Statement;
  private readonly insertStmt: Statement;
  private readonly linkSessionStmt: Statement;
  private readonly linkEntityStmt: Statement;
  private readonly existsStmt: Statement;

  constructor(db: Database) {
    // Initialize all prepared statements
  }
}
```

Entity deduplication strategy:
- Use INSERT OR REPLACE (upsert) on (type, name) unique constraint
- When entity exists, update confidence to max(existing, new)
- Return entity with assigned id after insert

Query patterns:
- findBySession: JOIN session_entities to get all entities for a session
- findByType: Simple WHERE with optional LIMIT
- findByName: Exact match on normalized name (lowercase, trimmed)

Session linking:
- INSERT OR REPLACE into session_entities
- Increment frequency if link exists

Entity linking:
- INSERT OR IGNORE into entity_links (prevent duplicate relationships)

Tests (following existing repository test patterns):
1. save() inserts new entity and returns with id
2. save() existing entity updates confidence (max of old/new)
3. findById() returns entity or null
4. findByName() uses case-insensitive matching
5. findBySession() returns all linked entities
6. findByType() respects limit option
7. linkToSession() creates session-entity link
8. linkToSession() increments frequency on duplicate
9. linkEntities() creates entity-entity relationship
10. saveMany() batch inserts with transaction
11. CASCADE delete removes session_entities links
  </action>
  <verify>bun test src/infrastructure/database/repositories/entity-repository.test.ts -- passes all tests</verify>
  <done>SqliteEntityRepository implemented with deduplication, batch support, and session/entity linking</done>
</task>

<task type="auto">
  <name>Task 2: Implement PatternExtractor service</name>
  <files>src/application/services/pattern-extractor.ts, src/application/services/pattern-extractor.test.ts, src/application/services/index.ts</files>
  <action>
Create PatternExtractor for extracting entities from tool uses using pattern matching (not LLM).

Static methods for extraction:

```typescript
export interface FileModification {
  path: string;
  operation: 'Write' | 'Edit' | 'NotebookEdit';
  timestamp: Date;
}

export interface ToolStats {
  name: string;
  count: number;
  successCount: number;
  errorCount: number;
}

export class PatternExtractor {
  /**
   * Extract file paths from tool uses.
   * Handles Read, Write, Edit, Glob, Grep tools.
   * Returns deduplicated list of paths.
   */
  static extractFilePaths(toolUses: ToolUse[]): string[];

  /**
   * Extract file modifications (Write, Edit, NotebookEdit).
   * Only includes successful operations.
   */
  static extractFileModifications(toolUses: ToolUse[]): FileModification[];

  /**
   * Extract tool usage statistics.
   * Groups by tool name with success/error counts.
   */
  static extractToolStats(toolUses: ToolUse[]): ToolStats[];

  /**
   * Extract unique tool names used in session.
   */
  static extractToolNames(toolUses: ToolUse[]): string[];

  /**
   * Convert extracted data to Entity objects.
   * File paths become 'file' entities with path as name.
   */
  static toFileEntities(paths: string[]): Entity[];

  /**
   * Convert file modifications to Entity objects with metadata.
   */
  static toFileModificationEntities(modifications: FileModification[]): Entity[];
}
```

Path extraction sources:
- `tool.input.file_path` (Read, Write, Edit)
- `tool.input.path` (Glob, Grep)
- Glob results parsed from `tool.result` (newline-separated file paths)

Tests:
1. extractFilePaths() extracts from Read tool input.file_path
2. extractFilePaths() extracts from Write tool input.file_path
3. extractFilePaths() extracts from Glob tool input.path
4. extractFilePaths() parses Glob results for matched files
5. extractFilePaths() deduplicates paths
6. extractFileModifications() filters to Write/Edit/NotebookEdit
7. extractFileModifications() only includes successful operations
8. extractToolStats() groups by tool name with counts
9. extractToolStats() tracks success vs error counts
10. extractToolNames() returns unique tool names
11. toFileEntities() creates file-type entities
12. toFileModificationEntities() includes operation in metadata
  </action>
  <verify>bun test src/application/services/pattern-extractor.test.ts -- passes all tests</verify>
  <done>PatternExtractor implemented with file path, modification, and tool stats extraction</done>
</task>

</tasks>

<verification>
- `bun test src/infrastructure/database/repositories/entity-repository.test.ts` - Repository tests pass
- `bun test src/application/services/pattern-extractor.test.ts` - Extractor tests pass
- SqliteEntityRepository exported from repositories/index.ts
- PatternExtractor exported from services/index.ts
</verification>

<success_criteria>
1. SqliteEntityRepository persists entities with deduplication (INSERT OR REPLACE)
2. Repository normalizes entity names (lowercase, trim) for case-insensitive matching
3. PatternExtractor extracts file paths from Read/Write/Edit/Glob/Grep tools
4. PatternExtractor extracts file modifications with operation type
5. PatternExtractor extracts tool usage statistics with success/error counts
6. All entities can be linked to sessions and to each other
7. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-navigation/11-02-SUMMARY.md`
</output>
