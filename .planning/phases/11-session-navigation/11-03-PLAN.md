---
phase: 11-session-navigation
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - src/presentation/cli/formatters/show-formatter.ts
  - src/presentation/cli/formatters/show-formatter.test.ts
  - src/presentation/cli/formatters/index.ts
  - src/presentation/cli/commands/show.ts
  - src/presentation/cli/commands/show.test.ts
  - src/presentation/cli/commands/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can run 'aidev memory show <session-id>' and see full session content"
    - "Show command displays messages in conversation thread format"
    - "Tool uses appear as inline markers [ToolName: brief result]"
    - "Header shows session ID, project, date range, duration, message/tool counts"
    - "--tools flag shows detailed tool inputs and outputs"
  artifacts:
    - path: "src/presentation/cli/commands/show.ts"
      provides: "Show command handler"
      exports: ["createShowCommand", "executeShowCommand"]
    - path: "src/presentation/cli/formatters/show-formatter.ts"
      provides: "Session detail formatting"
      exports: ["createShowFormatter", "ShowFormatter"]
  key_links:
    - from: "src/presentation/cli/commands/show.ts"
      to: "src/infrastructure/database/repositories/session-repository.ts"
      via: "SqliteSessionRepository"
      pattern: "new SqliteSessionRepository"
    - from: "src/presentation/cli/commands/show.ts"
      to: "src/infrastructure/database/repositories/message-repository.ts"
      via: "SqliteMessageRepository"
      pattern: "new SqliteMessageRepository"
---

<objective>
Implement the show command for detailed session viewing with conversation thread formatting and inline tool markers.

Purpose: Allow users and Claude to view full session content with structured formatting (NAV-02, EXTR-01).
Output: Working 'aidev memory show <session-id>' command with formatter supporting default/json/verbose/tools modes.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-session-navigation/11-CONTEXT.md
@.planning/phases/11-session-navigation/11-RESEARCH.md
@.planning/phases/11-session-navigation/11-02-SUMMARY.md
@src/presentation/cli/formatters/list-formatter.ts
@src/presentation/cli/formatters/output-formatter.ts
@src/presentation/cli/commands/list.ts
@src/infrastructure/database/repositories/message-repository.ts
@src/infrastructure/database/repositories/tool-use-repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShowFormatter with conversation thread formatting</name>
  <files>src/presentation/cli/formatters/show-formatter.ts, src/presentation/cli/formatters/show-formatter.test.ts, src/presentation/cli/formatters/index.ts</files>
  <action>
Create ShowFormatter following existing formatter patterns (strategy pattern, output modes).

```typescript
export type ShowOutputMode = 'default' | 'json' | 'verbose' | 'tools';

export interface SessionDetail {
  session: Session;
  messages: Message[];
  toolUses: Map<string, ToolUse>;  // id -> ToolUse for lookup
}

export interface ShowFormatOptions {
  executionTimeMs?: number;
}

export interface ShowFormatter {
  formatSession(detail: SessionDetail, options?: ShowFormatOptions): string;
  formatError(error: Error): string;
  formatNotFound(sessionId: string): string;
}

export function createShowFormatter(mode: ShowOutputMode, useColor: boolean): ShowFormatter;
```

DefaultShowFormatter implementation:
1. Header section:
   - Session: {full-id}
   - Project: {project-name}
   - Date: {start-time} - {end-time|ongoing}
   - Duration: {formatted-duration}
   - Messages: {count} | Tools: {count}
   - Separator line: ---

2. Conversation thread:
   - Each message prefixed with [USER] or [ASSISTANT] + timestamp
   - Full message content displayed (no truncation)
   - For assistant messages with tool uses, append inline markers:
     `[Read: file.ts -> 45 lines] [Write: config.json] [Bash: npm test -> OK]`

Inline tool marker formatting (brief results):
```typescript
function summarizeToolResult(tool: ToolUse): string {
  switch (tool.name) {
    case 'Read': {
      const path = tool.input.file_path as string;
      const lines = tool.result?.split('\n').length ?? 0;
      return `${basename(path)} -> ${lines} lines`;
    }
    case 'Write':
      return basename(tool.input.file_path as string);
    case 'Edit':
      return `${basename(tool.input.file_path as string)} edited`;
    case 'Bash': {
      const cmd = (tool.input.command as string).substring(0, 20);
      return tool.isSuccess ? `${cmd}...` : 'FAILED';
    }
    case 'Glob': {
      const count = tool.result?.split('\n').filter(Boolean).length ?? 0;
      return `${count} files`;
    }
    case 'Grep':
      return tool.isSuccess ? 'matches' : 'no matches';
    default:
      return tool.status;
  }
}
```

ToolsShowFormatter (--tools mode):
- Same header as default
- After each assistant message with tools, show full tool details:
  ```
  [TOOL: Read]
  Input: {"file_path": "/path/to/file.ts"}
  Result: <first 500 chars of result>...
  Status: success
  ```

JsonShowFormatter:
- Full session detail as JSON object
- Messages array with tool_use_ids
- Separate toolUses object keyed by id

VerboseShowFormatter:
- Adds execution details header
- Shows full session ID in header
- Full tool results (no truncation)

Tests:
1. DefaultShowFormatter formats header with all metadata
2. DefaultShowFormatter formats conversation thread in order
3. DefaultShowFormatter adds inline tool markers for assistant messages
4. summarizeToolResult() handles Read tool
5. summarizeToolResult() handles Write tool
6. summarizeToolResult() handles Bash tool (success/fail)
7. summarizeToolResult() handles Glob tool
8. summarizeToolResult() handles unknown tool gracefully
9. ToolsShowFormatter shows full tool inputs
10. ToolsShowFormatter shows tool results (truncated at 500 chars)
11. JsonShowFormatter outputs valid JSON
12. formatNotFound() returns appropriate message
13. formatError() includes error message
  </action>
  <verify>bun test src/presentation/cli/formatters/show-formatter.test.ts -- passes all tests</verify>
  <done>ShowFormatter created with default/json/verbose/tools modes and inline tool markers</done>
</task>

<task type="auto">
  <name>Task 2: Implement show command handler</name>
  <files>src/presentation/cli/commands/show.ts, src/presentation/cli/commands/show.test.ts, src/presentation/cli/commands/index.ts</files>
  <action>
Create show command following existing command patterns (Commander.js, option handling, DB lifecycle).

```typescript
export function createShowCommand(): Command {
  return new Command('show')
    .description('Show session details')
    .argument('<session-id>', 'Session ID to display')
    .option('--json', 'Output as JSON')
    .addOption(
      new Option('-v, --verbose', 'Show detailed output').conflicts('quiet')
    )
    .addOption(
      new Option('-q, --quiet', 'Minimal output').conflicts('verbose')
    )
    .option('--tools', 'Show detailed tool inputs and outputs')
    .action(async (sessionId: string, options: ShowCommandOptions) => {
      await executeShowCommand(sessionId, options);
    });
}

export async function executeShowCommand(
  sessionId: string,
  options: ShowCommandOptions
): Promise<void> {
  const startTime = performance.now();
  const dbPath = getDefaultDbPath();
  const { db } = initializeDatabase({ path: dbPath });

  try {
    const sessionRepo = new SqliteSessionRepository(db);
    const messageRepo = new SqliteMessageRepository(db);
    const toolUseRepo = new SqliteToolUseRepository(db);

    // Find session
    const session = await sessionRepo.findById(sessionId);
    if (!session) {
      // Try partial match (first 8 chars)
      // If still not found, show error
    }

    // Load messages and tool uses
    const messages = await messageRepo.findBySession(sessionId);
    const toolUsesArray = await toolUseRepo.findBySession(sessionId);

    // Build toolUses map for lookup
    const toolUses = new Map<string, ToolUse>();
    for (const tool of toolUsesArray) {
      toolUses.set(tool.id, tool);
    }

    // Create session detail
    const detail: SessionDetail = { session, messages, toolUses };

    // Format and output
    const mode = determineOutputMode(options);
    const formatter = createShowFormatter(mode, shouldUseColor());
    const output = formatter.formatSession(detail, {
      executionTimeMs: Math.round(performance.now() - startTime),
    });
    console.log(output);
  } catch (error) {
    // Error handling
  } finally {
    closeDatabase(db);
  }
}
```

Partial session ID matching:
- If full ID not found, try matching by prefix (substring of first 8 chars)
- Use prepared statement: `SELECT * FROM sessions WHERE id LIKE ?`
- If multiple matches, show disambiguation list

Output mode determination:
- --json -> 'json'
- --tools -> 'tools'
- --verbose -> 'verbose'
- --quiet -> 'quiet' (just message content, no formatting)
- default -> 'default'

Register in commands/index.ts (add to exports and program).

Tests:
1. Show command requires session-id argument
2. executeShowCommand() finds session by full ID
3. executeShowCommand() finds session by partial ID (8 chars)
4. executeShowCommand() shows not found for invalid ID
5. --json flag outputs JSON format
6. --tools flag shows detailed tool information
7. --verbose flag shows execution details
8. --quiet flag outputs minimal format
9. Messages ordered by timestamp
10. Tool uses linked to correct messages
  </action>
  <verify>bun test src/presentation/cli/commands/show.test.ts -- passes all tests</verify>
  <done>Show command implemented with full session viewing, partial ID matching, and multiple output modes</done>
</task>

</tasks>

<verification>
- `bun test src/presentation/cli/formatters/show-formatter.test.ts` - Formatter tests pass
- `bun test src/presentation/cli/commands/show.test.ts` - Command tests pass
- `bun run memory show --help` shows command usage
- Manual test: `bun run memory show <session-id>` displays formatted session
</verification>

<success_criteria>
1. User can run `aidev memory show <session-id>` and see full session content
2. Header shows session ID, project, date range, duration, message/tool counts
3. Messages displayed in conversation thread format (USER/ASSISTANT prefixed)
4. Tool uses appear as inline markers [ToolName: brief result]
5. --tools flag shows detailed tool inputs and outputs
6. Partial session ID matching works (first 8 chars)
7. All output modes work (default, json, verbose, quiet, tools)
8. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-navigation/11-03-SUMMARY.md`
</output>
