---
phase: 11-session-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/entities/entity.ts
  - src/domain/entities/entity.test.ts
  - src/domain/entities/index.ts
  - src/domain/ports/repositories.ts
  - src/infrastructure/database/schema.ts
  - src/infrastructure/database/schema.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Entity domain type exists with four variants: concept, file, decision, term"
    - "Entity has confidence score (0-1) for quality filtering"
    - "Decision entity has structured format with subject, decision, rejected[], rationale"
    - "Database schema supports entity storage with session linking"
  artifacts:
    - path: "src/domain/entities/entity.ts"
      provides: "Entity domain type"
      exports: ["Entity", "EntityType", "DecisionData"]
    - path: "src/infrastructure/database/schema.ts"
      provides: "Entity tables DDL"
      contains: "CREATE TABLE IF NOT EXISTS entities"
  key_links:
    - from: "src/domain/entities/entity.ts"
      to: "src/domain/entities/index.ts"
      via: "export"
      pattern: "export.*Entity"
---

<objective>
Create the Entity domain type and database schema for storing extracted concepts, files, decisions, and key terms.

Purpose: Enable structured storage of session metadata for cross-project linking and enhanced search capabilities (EXTR-01, EXTR-03).
Output: Entity domain type with four variants, confidence scoring, and SQLite schema with graph structure.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-session-navigation/11-CONTEXT.md
@.planning/phases/11-session-navigation/11-RESEARCH.md
@src/domain/entities/tool-use.ts
@src/infrastructure/database/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Entity domain type with variants</name>
  <files>src/domain/entities/entity.ts, src/domain/entities/entity.test.ts, src/domain/entities/index.ts</files>
  <action>
Create Entity domain type following existing entity patterns (immutable, factory method, validation).

Entity type variants:
- `concept`: Technical concepts (e.g., "hexagonal architecture", "FTS5")
- `file`: File paths referenced in session
- `decision`: Explicit choices made with rationale
- `term`: Domain-specific terminology

Entity properties:
```typescript
interface EntityParams {
  id?: number;  // Optional - assigned by database
  type: EntityType;
  name: string;
  confidence: number;  // 0-1 range
  metadata?: EntityMetadata;  // Type-specific data
  createdAt?: Date;
}

type EntityType = 'concept' | 'file' | 'decision' | 'term';

// Type-specific metadata
type EntityMetadata = ConceptMetadata | FileMetadata | DecisionMetadata | TermMetadata;

interface DecisionMetadata {
  subject: string;
  decision: string;
  rejected: string[];
  rationale: string;
}

interface FileMetadata {
  operation?: 'read' | 'write' | 'edit';
  lineCount?: number;
}

interface ConceptMetadata {
  category?: string;  // e.g., "architecture", "database", "testing"
}

interface TermMetadata {
  definition?: string;
}
```

Validation rules:
- Name cannot be empty
- Confidence must be 0-1 (inclusive)
- Type must be one of four valid values
- DecisionMetadata requires subject and decision fields

Tests (TDD pattern):
1. Entity.create() with valid params returns entity
2. Entity.create() throws on empty name
3. Entity.create() throws on confidence < 0 or > 1
4. Entity.create() throws on invalid type
5. Decision entity requires subject and decision in metadata
6. Getters return defensive copies for metadata
7. equals() compares by id when set, by type+name when not
8. isDecision/isConcept/isFile/isTerm type guards work correctly
  </action>
  <verify>bun test src/domain/entities/entity.test.ts -- passes all tests</verify>
  <done>Entity domain type created with four variants, confidence scoring, and type-specific metadata</done>
</task>

<task type="auto">
  <name>Task 2: Add entity tables to database schema</name>
  <files>src/infrastructure/database/schema.ts, src/infrastructure/database/schema.test.ts</files>
  <action>
Add three new tables to schema.ts for entity storage with graph structure:

```sql
-- Entities table (master list)
CREATE TABLE IF NOT EXISTS entities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL CHECK (type IN ('concept', 'file', 'decision', 'term')),
    name TEXT NOT NULL,
    metadata TEXT,  -- JSON for type-specific data
    confidence REAL DEFAULT 1.0 CHECK (confidence >= 0 AND confidence <= 1),
    created_at TEXT DEFAULT (datetime('now')),
    UNIQUE(type, name)
);
CREATE INDEX IF NOT EXISTS idx_entities_type ON entities(type);
CREATE INDEX IF NOT EXISTS idx_entities_name ON entities(name);

-- Session-Entity links (many-to-many)
CREATE TABLE IF NOT EXISTS session_entities (
    session_id TEXT NOT NULL,
    entity_id INTEGER NOT NULL,
    frequency INTEGER DEFAULT 1,  -- How often entity appears in session
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (entity_id) REFERENCES entities(id) ON DELETE CASCADE,
    PRIMARY KEY (session_id, entity_id)
);

-- Entity-Entity links (cross-project relationships)
CREATE TABLE IF NOT EXISTS entity_links (
    source_id INTEGER NOT NULL,
    target_id INTEGER NOT NULL,
    relationship TEXT NOT NULL CHECK (relationship IN ('related', 'implies', 'contradicts')),
    weight REAL DEFAULT 1.0 CHECK (weight >= 0 AND weight <= 1),
    FOREIGN KEY (source_id) REFERENCES entities(id) ON DELETE CASCADE,
    FOREIGN KEY (target_id) REFERENCES entities(id) ON DELETE CASCADE,
    PRIMARY KEY (source_id, target_id, relationship)
);
```

Add to SCHEMA_SQL array in correct dependency order (after sessions table).

Add IEntityRepository port interface to repositories.ts:
```typescript
export interface IEntityRepository {
  findById(id: number): Promise<Entity | null>;
  findByName(type: EntityType, name: string): Promise<Entity | null>;
  findBySession(sessionId: string): Promise<Entity[]>;
  findByType(type: EntityType, options?: { limit?: number }): Promise<Entity[]>;
  save(entity: Entity): Promise<Entity>;  // Returns with id assigned
  saveMany(entities: Entity[]): Promise<Entity[]>;
  linkToSession(entityId: number, sessionId: string, frequency?: number): Promise<void>;
  linkEntities(sourceId: number, targetId: number, relationship: string, weight?: number): Promise<void>;
}
```

Tests:
1. Schema creation includes entities table
2. Schema creation includes session_entities table
3. Schema creation includes entity_links table
4. UNIQUE constraint on (type, name) prevents duplicates
5. CHECK constraint on confidence range enforced
6. CASCADE delete removes session_entities when session deleted
  </action>
  <verify>bun test src/infrastructure/database/schema.test.ts -- passes all tests including new entity tables</verify>
  <done>Entity tables (entities, session_entities, entity_links) added to schema with proper constraints and indexes</done>
</task>

</tasks>

<verification>
- `bun test src/domain/entities/entity.test.ts` - All entity domain tests pass
- `bun test src/infrastructure/database/schema.test.ts` - All schema tests pass including entity tables
- Entity type exports from domain index
- Schema creates all three new tables without errors
</verification>

<success_criteria>
1. Entity domain type exists with four variants (concept, file, decision, term)
2. Entity has confidence score validation (0-1 range)
3. DecisionMetadata has structured format (subject, decision, rejected, rationale)
4. Three new database tables created: entities, session_entities, entity_links
5. IEntityRepository port interface defined
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-navigation/11-01-SUMMARY.md`
</output>
