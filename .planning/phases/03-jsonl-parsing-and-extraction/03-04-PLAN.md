# Plan 03-04: Timestamp Normalization and Integration Tests

## Objective

Implement timestamp normalization to ISO 8601 format and create comprehensive integration tests that verify the complete parsing pipeline with realistic test data.

## Requirements Addressed

| ID | Requirement |
|----|-------------|
| PARSE-07 | Timestamp normalization to ISO 8601 |
| QUAL-03 | Integration tests for streaming parser with 10,000+ line files |

## Tasks

### Task 1: Implement Timestamp Normalization

**File:** `src/infrastructure/parsers/timestamp.ts`

Create timestamp normalization utility:

```typescript
/**
 * Normalize various timestamp formats to ISO 8601.
 *
 * Handles:
 * - Already ISO 8601 strings
 * - Unix timestamps (seconds or milliseconds)
 * - Date objects
 */
export function normalizeTimestamp(value: unknown): string {
  if (typeof value === "string") {
    // Already ISO 8601?
    if (/^\d{4}-\d{2}-\d{2}T/.test(value)) {
      return value;
    }
    // Try parsing as date string
    const date = new Date(value);
    if (!isNaN(date.getTime())) {
      return date.toISOString();
    }
  }
  if (typeof value === "number") {
    // Unix timestamp - detect seconds vs milliseconds
    const ts = value > 1e12 ? value : value * 1000;
    return new Date(ts).toISOString();
  }
  if (value instanceof Date) {
    return value.toISOString();
  }
  // Fallback to current time
  return new Date().toISOString();
}
```

**Tests:**
- Preserves valid ISO 8601 strings
- Converts Unix timestamps (seconds)
- Converts Unix timestamps (milliseconds)
- Handles Date objects
- Parses other date string formats
- Returns current time for invalid input

### Task 2: Integrate Timestamp Normalization into Extractors

Update event extractors to normalize all timestamps.

**Files to modify:**
- `src/infrastructure/parsers/event-classifier.ts`

**Tests:**
- Extracted events have normalized timestamps
- Works with various input formats

### Task 3: Create Test Fixtures

**Directory:** `tests/fixtures/`

Create realistic test data files:

**valid-session.jsonl:**
```jsonl
{"type":"system","subtype":"session_start","timestamp":"2026-01-28T10:00:00.000Z","uuid":"sys-1","sessionId":"sess-1"}
{"type":"user","message":{"role":"user","content":"Hello Claude"},"uuid":"user-1","timestamp":"2026-01-28T10:00:01.000Z","parentUuid":null,"sessionId":"sess-1","cwd":"/home/user/project"}
{"type":"assistant","message":{"role":"assistant","content":[{"type":"text","text":"Hello! How can I help you?"}],"model":"claude-opus-4-5-20251101"},"uuid":"asst-1","timestamp":"2026-01-28T10:00:02.000Z","parentUuid":"user-1","sessionId":"sess-1"}
{"type":"summary","summary":"User greeted Claude, Claude responded.","timestamp":"2026-01-28T10:00:03.000Z","leafUuid":"asst-1"}
```

**with-tools.jsonl:**
```jsonl
{"type":"user","message":{"role":"user","content":"Read the file package.json"},"uuid":"user-1","timestamp":"2026-01-28T10:00:00.000Z","sessionId":"sess-1"}
{"type":"assistant","message":{"role":"assistant","content":[{"type":"text","text":"Let me read that file."},{"type":"tool_use","id":"toolu_1","name":"Read","input":{"file_path":"package.json"}}],"model":"claude-opus-4-5-20251101"},"uuid":"asst-1","timestamp":"2026-01-28T10:00:01.000Z","sessionId":"sess-1"}
{"type":"user","message":{"role":"user","content":[{"type":"tool_result","tool_use_id":"toolu_1","content":"{\"name\":\"test\"}"}]},"uuid":"user-2","timestamp":"2026-01-28T10:00:02.000Z","sessionId":"sess-1"}
{"type":"assistant","message":{"role":"assistant","content":[{"type":"text","text":"The package.json contains a simple project."}],"model":"claude-opus-4-5-20251101"},"uuid":"asst-2","timestamp":"2026-01-28T10:00:03.000Z","sessionId":"sess-1"}
```

**malformed.jsonl:**
```jsonl
{"type":"user","message":{"content":"Valid line 1"},"uuid":"1","timestamp":"2026-01-28T10:00:00.000Z"}
{invalid json on line 2
{"type":"user","message":{"content":"Valid line 3"},"uuid":"3","timestamp":"2026-01-28T10:00:01.000Z"}
not even close to json
{"type":"user","message":{"content":"Valid line 5"},"uuid":"5","timestamp":"2026-01-28T10:00:02.000Z"}
```

**empty.jsonl:** (empty file)

**Tests:**
- Fixtures exist and are valid
- Valid session parses without errors
- Malformed file yields mix of events and skipped

### Task 4: Create Large File Generator for Memory Testing

**File:** `tests/generators/large-session.ts`

Script to generate large test files:

```typescript
import { writeFileSync } from "fs";

export function generateLargeSession(
  outputPath: string,
  lineCount: number
): void {
  const lines: string[] = [];
  for (let i = 0; i < lineCount; i++) {
    lines.push(JSON.stringify({
      type: i % 2 === 0 ? "user" : "assistant",
      uuid: `event-${i}`,
      timestamp: new Date(Date.now() + i * 1000).toISOString(),
      message: {
        role: i % 2 === 0 ? "user" : "assistant",
        content: `Message ${i}: ${"x".repeat(100)}`,
      },
    }));
  }
  writeFileSync(outputPath, lines.join("\n"));
}
```

**Tests:**
- Generator creates file with correct line count
- Generated file is valid JSONL

### Task 5: Integration Tests - Complete Pipeline

**File:** `src/infrastructure/parsers/integration.test.ts`

Integration tests for the full parsing pipeline:

```typescript
describe("JSONL Parser Integration", () => {
  describe("valid session file", () => {
    it("parses all events correctly");
    it("extracts user messages");
    it("extracts assistant messages");
    it("extracts tool uses from assistant events");
    it("extracts tool results from user events");
    it("extracts summaries");
  });

  describe("malformed file handling", () => {
    it("yields skipped events for invalid JSON");
    it("continues parsing after malformed lines");
    it("includes line numbers in skip reasons");
  });

  describe("empty file handling", () => {
    it("yields no events for empty file");
  });

  describe("large file handling", () => {
    it("parses 10,000 line file without memory spike");
    it("yields events one at a time");
  });
});
```

**Memory Test Implementation:**
```typescript
it("parses 10,000 line file without memory spike", async () => {
  const testFile = join(scratchpad, "large-session.jsonl");
  generateLargeSession(testFile, 10000);

  const initialMemory = process.memoryUsage().heapUsed;
  let eventCount = 0;

  const parser = new JsonlEventParser();
  for await (const event of parser.parse(testFile)) {
    eventCount++;
    // Don't accumulate events - streaming
  }

  const finalMemory = process.memoryUsage().heapUsed;
  const memoryIncrease = finalMemory - initialMemory;

  expect(eventCount).toBe(10000);
  // Memory should not increase by more than 50MB (generous buffer)
  expect(memoryIncrease).toBeLessThan(50 * 1024 * 1024);
});
```

**Tests:**
- ~15 integration tests covering all scenarios

### Task 6: Session Discovery Integration Tests

**File:** `src/infrastructure/sources/integration.test.ts`

Integration tests for session discovery:

```typescript
describe("FileSystemSessionSource Integration", () => {
  describe("with mock filesystem", () => {
    it("discovers sessions in standard directory structure");
    it("handles nested subagent directories");
    it("returns accurate file metadata");
    it("handles missing directories gracefully");
  });
});
```

**Tests:**
- ~8 integration tests

## Success Criteria

1. All timestamps normalized to ISO 8601
2. Large file test completes without memory issues
3. Malformed files handled gracefully
4. Integration tests cover realistic scenarios
5. All tests pass

## Dependencies

- Plans 03-01, 03-02, 03-03

## Test Count Estimate

~35 tests (unit + integration)

## Files to Create/Modify

| File | Action |
|------|--------|
| src/infrastructure/parsers/timestamp.ts | Create |
| src/infrastructure/parsers/timestamp.test.ts | Create |
| src/infrastructure/parsers/event-classifier.ts | Modify |
| src/infrastructure/parsers/integration.test.ts | Create |
| src/infrastructure/sources/integration.test.ts | Create |
| tests/fixtures/valid-session.jsonl | Create |
| tests/fixtures/with-tools.jsonl | Create |
| tests/fixtures/malformed.jsonl | Create |
| tests/fixtures/empty.jsonl | Create |
| tests/generators/large-session.ts | Create |

---

*Created: 2026-01-28*
