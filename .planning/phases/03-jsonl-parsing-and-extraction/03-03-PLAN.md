# Plan 03-03: Event Classification and Extraction

## Objective

Implement event classification logic that routes raw JSON events to the appropriate `ParsedEvent` type with proper data extraction.

## Requirements Addressed

| ID | Requirement |
|----|-------------|
| PARSE-02 | Event classification by type: system, user, assistant, file-history-snapshot, summary |
| PARSE-03 | Message extraction from user and assistant events |
| PARSE-04 | Tool use extraction from assistant events |
| PARSE-05 | Thinking block extraction from assistant events |
| PARSE-06 | Summary extraction from summary events |

## Tasks

### Task 1: Create Event Classifier Module

**File:** `src/infrastructure/parsers/event-classifier.ts`

Create the classifier function:

```typescript
import type { ParsedEvent } from "../../domain/ports/types.js";

export function classifyEvent(raw: unknown): ParsedEvent {
  if (!isValidEvent(raw)) {
    return { type: "skipped", reason: "Invalid event structure" };
  }
  // Route to appropriate extractor
}
```

**Tests:**
- Rejects non-object values
- Rejects null
- Rejects objects without type field

### Task 2: Implement User Event Extraction

Extract user message data from user events.

**Logic:**
```typescript
function extractUserEvent(raw: RawUserEvent): ParsedEvent {
  return {
    type: "user",
    data: {
      uuid: raw.uuid,
      message: {
        content: extractUserContent(raw.message),
      },
      timestamp: raw.timestamp,
      cwd: raw.cwd,
      gitBranch: raw.gitBranch,
    },
  };
}

function extractUserContent(message: unknown): string {
  // Handle string content directly
  // Handle array content (tool results) by extracting text
}
```

**Tests:**
- Extracts simple string content
- Extracts content from message object
- Handles tool_result content blocks
- Normalizes content to string
- Includes optional fields (cwd, gitBranch)

### Task 3: Implement Assistant Event Extraction

Extract assistant message data including content blocks.

**Logic:**
```typescript
function extractAssistantEvent(raw: RawAssistantEvent): ParsedEvent {
  const content = extractContentBlocks(raw.message.content);
  return {
    type: "assistant",
    data: {
      uuid: raw.uuid,
      message: {
        content,
        model: raw.message.model,
      },
      timestamp: raw.timestamp,
      usage: raw.message.usage ? {
        inputTokens: raw.message.usage.input_tokens,
        outputTokens: raw.message.usage.output_tokens,
      } : undefined,
    },
  };
}
```

**Tests:**
- Extracts text content blocks
- Extracts tool_use content blocks
- Filters out thinking blocks (signature-protected)
- Normalizes usage to domain format
- Handles missing optional fields

### Task 4: Implement Tool Event Extraction

Extract tool uses from assistant events.

**Logic:**
Tool uses are nested in assistant message content. When we encounter a tool_use block, we should yield both:
1. The assistant event (with all content blocks)
2. Separate tool_use events for easier querying

```typescript
function extractToolUseEvents(raw: RawAssistantEvent): ToolUseEventData[] {
  return raw.message.content
    .filter((block): block is ToolUseBlock => block.type === "tool_use")
    .map((block) => ({
      uuid: block.id,
      name: block.name,
      input: block.input,
      timestamp: raw.timestamp,
    }));
}
```

**Tests:**
- Extracts tool uses from content blocks
- Creates separate ToolUseEventData for each tool
- Copies timestamp from parent event

### Task 5: Implement Tool Result Extraction

Extract tool results from user events.

**Logic:**
Tool results are nested in user message content as array items.

```typescript
function extractToolResultEvents(raw: RawUserEvent): ToolResultEventData[] {
  if (!Array.isArray(raw.message.content)) {
    return [];
  }
  return raw.message.content
    .filter((block): block is ToolResultBlock => block.type === "tool_result")
    .map((block) => ({
      uuid: `result-${block.tool_use_id}`,
      toolUseId: block.tool_use_id,
      content: typeof block.content === "string" ? block.content : JSON.stringify(block.content),
      isError: block.is_error ?? false,
      timestamp: raw.timestamp,
    }));
}
```

**Tests:**
- Extracts tool results from content array
- Links to tool_use_id
- Handles string content
- Handles object content (stringifies)
- Handles is_error flag

### Task 6: Implement Summary Event Extraction

Extract summary content from summary events.

**Logic:**
```typescript
function extractSummaryEvent(raw: RawSummaryEvent): ParsedEvent {
  return {
    type: "summary",
    data: {
      content: raw.summary,
      timestamp: raw.timestamp ?? new Date().toISOString(),
      leafUuid: raw.leafUuid,
    },
  };
}
```

**Tests:**
- Extracts summary content
- Includes leafUuid when present
- Handles missing timestamp

### Task 7: Implement System Event Extraction

Extract system event data (timing, configuration).

**Logic:**
```typescript
function extractSystemEvent(raw: RawSystemEvent): ParsedEvent {
  return {
    type: "system",
    data: {
      subtype: raw.subtype,
      data: raw.durationMs ?? raw.data,
      timestamp: raw.timestamp,
    },
  };
}
```

**Tests:**
- Extracts turn_duration events
- Includes subtype field
- Captures event-specific data

### Task 8: Implement Skip Logic for Non-Extracted Types

Skip events that don't have semantic value for search.

**Logic:**
```typescript
const SKIP_TYPES = new Set([
  "progress",
  "agent_progress",
  "bash_progress",
  "mcp_progress",
  "hook_progress",
  "base64",
  "image",
  "file-history-snapshot",
  "waiting_for_task",
  "create",
  "update",
  "queue-operation",
]);

if (SKIP_TYPES.has(eventType)) {
  return { type: "skipped", reason: `Event type "${eventType}" not extracted` };
}
```

**Tests:**
- Skips progress events
- Skips base64 events
- Skips file-history-snapshot events
- Includes reason in skipped event

## Success Criteria

1. All primary event types extracted correctly
2. Nested content (tool uses, results) properly extracted
3. Non-semantic events consistently skipped
4. Tests cover edge cases (missing fields, malformed content)

## Dependencies

- Plan 03-02 (streaming parser)
- Phase 2 ParsedEvent types

## Test Count Estimate

~30 unit tests

## Files to Create/Modify

| File | Action |
|------|--------|
| src/infrastructure/parsers/event-classifier.ts | Create |
| src/infrastructure/parsers/event-classifier.test.ts | Create |
| src/infrastructure/parsers/jsonl-parser.ts | Modify (integrate classifier) |
| src/infrastructure/parsers/jsonl-parser.test.ts | Modify (add integration tests) |

---

*Created: 2026-01-28*
