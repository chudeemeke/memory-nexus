# Plan 03-01: Session Discovery Implementation

## Objective

Implement `FileSystemSessionSource` that discovers Claude Code session files in `~/.claude/projects/`.

## Requirements Addressed

| ID | Requirement |
|----|-------------|
| PARSE-09 | Session discovery: locate all JSONL files in ~/.claude/projects/ |
| PARSE-10 | Encoded path decoding (or treat as opaque identifier) |
| STOR-04 | FileSystemSessionSource implementing ISessionSource |

## Tasks

### Task 1: Create SessionSource Adapter Shell

**File:** `src/infrastructure/sources/session-source.ts`

Create the file structure with proper imports:

```typescript
import { createReadStream } from "fs";
import { readdir, stat } from "fs/promises";
import { join } from "path";
import { homedir } from "os";
import type { ISessionSource, SessionFileInfo } from "../../domain/ports/sources.js";
import { ProjectPath } from "../../domain/value-objects/project-path.js";

export class FileSystemSessionSource implements ISessionSource {
  private readonly claudeProjectsDir: string;

  constructor(options?: { claudeDir?: string }) {
    this.claudeProjectsDir = options?.claudeDir ?? join(homedir(), ".claude", "projects");
  }

  async discoverSessions(): Promise<SessionFileInfo[]> {
    throw new Error("Not implemented");
  }

  async getSessionFile(sessionId: string): Promise<string | null> {
    throw new Error("Not implemented");
  }
}
```

**Tests:**
- Constructor uses default path when no options
- Constructor uses custom path when provided

### Task 2: Implement discoverSessions

Scan the directory structure to find all JSONL files.

**Logic:**
1. List all directories in `~/.claude/projects/`
2. For each directory (encoded path), list all `.jsonl` files
3. For each file, create `SessionFileInfo` with metadata
4. Handle subagent sessions in `<session-id>/subagents/` subdirectories

**Tests:**
- Returns empty array when directory doesn't exist
- Finds single session file
- Finds multiple session files across projects
- Includes subagent session files
- Populates all SessionFileInfo fields correctly
- Handles directory read errors gracefully

### Task 3: Implement getSessionFile

Look up a session file by ID.

**Logic:**
1. Search all project directories for matching session UUID
2. Return full path if found, null otherwise
3. Cache discovered sessions for performance (optional optimization)

**Tests:**
- Returns null for non-existent session
- Returns path for existing session
- Works with subagent sessions

### Task 4: Create Index and Integration

**File:** `src/infrastructure/sources/index.ts`

Export the adapter and update infrastructure index.

**Tests:**
- Export is accessible from infrastructure index
- Integration test with mock filesystem

## Success Criteria

1. `FileSystemSessionSource` implements `ISessionSource` interface
2. Can discover sessions from real `~/.claude/projects/` directory
3. Returns accurate file metadata (size, mtime)
4. Handles missing directories gracefully
5. Tests pass with mocked filesystem

## Dependencies

- Phase 2 port interfaces (ISessionSource, SessionFileInfo)
- Phase 1 ProjectPath value object

## Test Count Estimate

~15 unit tests

## Files to Create/Modify

| File | Action |
|------|--------|
| src/infrastructure/sources/session-source.ts | Create |
| src/infrastructure/sources/session-source.test.ts | Create |
| src/infrastructure/sources/index.ts | Create |
| src/infrastructure/index.ts | Modify (add export) |

---

*Created: 2026-01-28*
