---
phase: 09-context-and-related-commands
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/presentation/cli/commands/related.ts
  - src/presentation/cli/commands/related.test.ts
  - src/presentation/cli/formatters/related-formatter.ts
  - src/presentation/cli/formatters/related-formatter.test.ts
autonomous: true

must_haves:
  truths:
    - "User can run 'memory related <id>' and see related sessions"
    - "Related sessions are ranked by relationship weight (higher weight first)"
    - "1-hop and 2-hop relationships both appear in results"
    - "2-hop relationships show decayed weight (lower than 1-hop)"
    - "--limit N restricts result count"
    - "--hops N controls traversal depth (default 2)"
    - "--format brief/detailed controls output verbosity"
  artifacts:
    - path: "src/presentation/cli/commands/related.ts"
      provides: "CLI command handler for related"
      exports: ["createRelatedCommand"]
    - path: "src/presentation/cli/formatters/related-formatter.ts"
      provides: "Formatter strategy for related output"
      exports: ["createRelatedFormatter", "RelatedFormatter"]
  key_links:
    - from: "related.ts command"
      to: "SqliteLinkRepository"
      via: "dependency injection"
      pattern: "new SqliteLinkRepository"
    - from: "related.ts command"
      to: "related-formatter.ts"
      via: "factory function"
      pattern: "createRelatedFormatter"
    - from: "related.ts command"
      to: "SqliteSessionRepository"
      via: "dependency injection"
      pattern: "new SqliteSessionRepository"
---

<objective>
Implement the related command for finding sessions connected through shared topics/entities.

Purpose: The related command enables discovering sessions that share common topics or are connected through the relationship graph. It uses SqliteLinkRepository's findRelated() method (from Plan 01) for 2-hop graph traversal with weight-based ranking.

Output: Working `memory related <id>` command with --limit, --hops, and --format options.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-context-and-related-commands/09-RESEARCH.md
@.planning/phases/09-context-and-related-commands/09-01-SUMMARY.md

@src/infrastructure/database/repositories/link-repository.ts
@src/infrastructure/database/repositories/session-repository.ts
@src/presentation/cli/commands/list.ts
@src/presentation/cli/formatters/list-formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create related formatter with brief/detailed modes</name>
  <files>
    src/presentation/cli/formatters/related-formatter.ts
    src/presentation/cli/formatters/related-formatter.test.ts
  </files>
  <action>
Create related formatter following list-formatter.ts strategy pattern.

Define types:
```typescript
export type RelatedOutputMode = "default" | "json" | "brief" | "detailed" | "quiet";

export interface RelatedSession {
  session: Session;
  weight: number;
  hops: number;
}

export interface RelatedFormatOptions {
  sourceId: string;
  executionTimeMs?: number;
}

export interface RelatedFormatter {
  formatRelated(sessions: RelatedSession[], options?: RelatedFormatOptions): string;
  formatError(error: Error): string;
  formatEmpty(sourceId: string): string;
  formatNoLinks(): string;  // Message when links table is empty
}
```

Factory function:
```typescript
export function createRelatedFormatter(
  mode: RelatedOutputMode,
  useColor: boolean
): RelatedFormatter
```

Implement formatters:

**BriefRelatedFormatter** (default for --format brief):
```
Related to session abc123...
1. wow-system (95%) - 2 hours ago [1 hop]
2. memory-nexus (72%) - 1 day ago [2 hops]
3. prompter (64%) - 3 days ago [2 hops]
```

**DetailedRelatedFormatter** (for --format detailed):
```
Related to session abc123...
========================================

1. wow-system
   Weight: 95% | Hops: 1 (direct)
   Path: C:\Users\Destiny\Projects\wow-system
   Last active: 2026-01-30 14:23:45
   Messages: 234

2. memory-nexus
   Weight: 72% | Hops: 2 (indirect)
   Path: C:\Users\Destiny\Projects\memory-nexus
   Last active: 2026-01-29 10:15:30
   Messages: 156
```

**JsonRelatedFormatter**:
```json
{
  "sourceId": "abc123",
  "related": [
    {
      "sessionId": "def456",
      "projectName": "wow-system",
      "weight": 0.95,
      "hops": 1,
      "lastActivity": "2026-01-30T14:23:45.000Z",
      "messageCount": 234
    }
  ]
}
```

**QuietRelatedFormatter**:
- Just session IDs: `def456 ghi789 jkl012`

Weight display:
- Convert 0-1 weight to percentage: `(weight * 100).toFixed(0)%`
- Color-code: green for >75%, yellow for 50-75%, default for <50%

Hops display:
- 1 hop: "direct" or "1 hop"
- 2+ hops: "indirect" or "N hops"

Use formatRelativeTime for "last active" in brief mode.
Use formatTimestamp for detailed mode.

Tests should cover:
- Brief format shows compact list structure
- Detailed format shows full session info
- JSON format is valid parseable JSON
- Quiet format shows just session IDs
- Weight formatting as percentage
- Hops display (direct vs indirect)
- formatEmpty returns helpful message
- formatNoLinks returns suggestion to run sync
- Color is applied when useColor=true
  </action>
  <verify>
Run `bun test related-formatter` - all tests pass
  </verify>
  <done>
Related formatter implements brief/detailed/json/quiet modes with weight and hop display
  </done>
</task>

<task type="auto">
  <name>Task 2: Create related command handler</name>
  <files>
    src/presentation/cli/commands/related.ts
    src/presentation/cli/commands/related.test.ts
  </files>
  <action>
Create related command following list.ts and context.ts patterns.

Command signature: `memory related <id>`

Options:
- `--limit <n>` - Maximum results (default 10)
- `--hops <n>` - Traversal depth 1-3 (default 2)
- `--type <type>` - Entity type: session/message/topic (default: session)
- `--format <type>` - Output format: brief, detailed (default: brief)
- `--json` - JSON output (shorthand for --format json)
- `-v, --verbose` - Verbose output with timing (conflicts with quiet)
- `-q, --quiet` - Minimal output, just session IDs (conflicts with verbose)

```typescript
export function createRelatedCommand(): Command {
  return new Command("related")
    .description("Find sessions related through shared topics/entities")
    .argument("<id>", "Session ID, message ID, or topic name")
    .addOption(
      new Option("--limit <n>", "Maximum results")
        .argParser((val) => {
          const n = parseInt(val, 10);
          if (isNaN(n) || n < 1) throw new Error("Limit must be a positive number");
          return n;
        })
        .default(10)
    )
    .addOption(
      new Option("--hops <n>", "Traversal depth (1-3)")
        .argParser((val) => {
          const n = parseInt(val, 10);
          if (isNaN(n) || n < 1 || n > 3) throw new Error("Hops must be 1, 2, or 3");
          return n;
        })
        .default(2)
    )
    .addOption(
      new Option("--type <type>", "Entity type of the ID")
        .choices(["session", "message", "topic"])
        .default("session")
    )
    .addOption(
      new Option("--format <type>", "Output format")
        .choices(["brief", "detailed"])
        .default("brief")
    )
    .option("--json", "Output as JSON")
    .addOption(
      new Option("-v, --verbose", "Show detailed output with timing")
        .conflicts("quiet")
    )
    .addOption(
      new Option("-q, --quiet", "Minimal output (session IDs only)")
        .conflicts("verbose")
    )
    .action(async (id: string, options) => {
      await executeRelatedCommand(id, options);
    });
}
```

executeRelatedCommand implementation:
1. Initialize database (getDefaultDbPath, initializeDatabase)
2. Create SqliteLinkRepository and SqliteSessionRepository
3. Call linkRepo.findRelated(entityType, id, options.hops)
4. Handle empty results (no links found)
5. Group links by target session and take max weight per session
6. Sort by weight descending, limit results
7. Fetch full session details for each related session ID
8. Determine output mode from options
9. Format and output
10. Close database in finally block

Implementation pattern (from research):
```typescript
// Group by target session, take max weight
const sessionWeights = new Map<string, { weight: number; hops: number }>();
for (const link of links) {
  if (link.targetType === "session") {
    const existing = sessionWeights.get(link.targetId);
    if (!existing || link.weight > existing.weight) {
      sessionWeights.set(link.targetId, {
        weight: link.weight,
        hops: (link as any).hop ?? 1,  // Extended from findRelated
      });
    }
  }
}

// Sort by weight descending, then by hops ascending
const sorted = Array.from(sessionWeights.entries())
  .sort((a, b) => b[1].weight - a[1].weight || a[1].hops - b[1].hops)
  .slice(0, options.limit);
```

Error handling:
- ID not found in links: "No relationships found for '<id>'"
- Links table empty: "No relationships extracted yet. Run 'memory sync' to extract session data."
- Database error: Standard error format with exit code 2

Tests should cover:
- Command registered with correct options
- ID argument is required
- --limit validates positive number
- --hops validates 1-3 range
- --type accepts session/message/topic
- --format accepts brief/detailed
- --json sets json output mode
- --verbose and --quiet conflict
- Exit code 1 for user errors (ID not found)
- Exit code 2 for internal errors
- Results sorted by weight descending
- Results limited to --limit count
  </action>
  <verify>
Run `bun test related.test` - all command tests pass
  </verify>
  <done>
Related command handler wired to repositories with weight-based ranking and all CLI options working
  </done>
</task>

</tasks>

<verification>
1. `bun test related` passes all related-specific tests
2. `bun test` passes all tests (no regressions)
3. Coverage meets 95%+ threshold for new files
4. Manual verification: `bun run src/index.ts related <session-id>` shows related sessions
5. Manual verification: `bun run src/index.ts related <session-id> --hops 1` limits to direct connections
6. Manual verification: `bun run src/index.ts related <session-id> --format detailed` shows detailed output
</verification>

<success_criteria>
1. `memory related <id>` command shows related sessions
2. Results ranked by weight (higher first)
3. 1-hop and 2-hop relationships both shown
4. 2-hop relationships have decayed weight
5. --limit N restricts result count
6. --hops N controls traversal depth
7. --format brief shows compact output
8. --format detailed shows full session info
9. --json outputs valid JSON
10. All tests pass with 95%+ coverage
</success_criteria>

<output>
After completion, create `.planning/phases/09-context-and-related-commands/09-03-SUMMARY.md`
</output>
