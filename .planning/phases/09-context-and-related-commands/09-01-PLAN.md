---
phase: 09-context-and-related-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/database/repositories/link-repository.ts
  - src/infrastructure/database/repositories/link-repository.test.ts
  - src/infrastructure/database/repositories/index.ts
autonomous: true

must_haves:
  truths:
    - "Link repository can save links to database"
    - "Link repository can find links by source entity"
    - "Link repository can find links by target entity"
    - "Link repository can traverse 2-hop relationships using recursive CTE"
    - "Multi-hop results are ranked by weight with decay"
  artifacts:
    - path: "src/infrastructure/database/repositories/link-repository.ts"
      provides: "SqliteLinkRepository implementing ILinkRepository"
      exports: ["SqliteLinkRepository"]
    - path: "src/infrastructure/database/repositories/link-repository.test.ts"
      provides: "Unit and integration tests for link repository"
      min_lines: 100
  key_links:
    - from: "link-repository.ts"
      to: "ILinkRepository"
      via: "implements interface"
      pattern: "implements ILinkRepository"
    - from: "link-repository.ts"
      to: "bun:sqlite"
      via: "Database injection"
      pattern: "private readonly db: Database"
    - from: "link-repository.ts findRelated"
      to: "links table"
      via: "WITH RECURSIVE CTE"
      pattern: "WITH RECURSIVE"
---

<objective>
Implement SqliteLinkRepository with graph traversal capability for relationship queries.

Purpose: This repository is the foundation for the "related" command, enabling multi-hop relationship discovery using SQLite's WITH RECURSIVE CTE. It supports finding entities related through shared topics/sessions with weight-based ranking and cycle prevention.

Output: Working SqliteLinkRepository with all ILinkRepository methods implemented, including the critical findRelated() method for 2-hop graph traversal.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-context-and-related-commands/09-RESEARCH.md

@src/domain/ports/repositories.ts
@src/domain/entities/link.ts
@src/infrastructure/database/repositories/session-repository.ts
@src/infrastructure/database/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SqliteLinkRepository with basic CRUD operations</name>
  <files>
    src/infrastructure/database/repositories/link-repository.ts
    src/infrastructure/database/repositories/link-repository.test.ts
  </files>
  <action>
Create SqliteLinkRepository implementing ILinkRepository with these methods:

1. Constructor takes Database instance (follows existing repository pattern)
2. `save(link: Link)` - INSERT OR REPLACE using unique constraint on (source_type, source_id, target_type, target_id, relationship)
3. `saveMany(links: Link[])` - Batch insert using db.transaction()
4. `findBySource(sourceType, sourceId)` - SELECT WHERE source_type = ? AND source_id = ?
5. `findByTarget(targetType, targetId)` - SELECT WHERE target_type = ? AND target_id = ?

Row mapping pattern:
```typescript
interface LinkRow {
  source_type: string;
  source_id: string;
  target_type: string;
  target_id: string;
  relationship: string;
  weight: number;
}
```

Convert rows to Link entities using Link.create().

Tests should cover:
- save() creates new link
- save() updates existing link (same source/target/relationship)
- saveMany() batch inserts multiple links
- findBySource() returns all links from a source
- findByTarget() returns all links to a target
- Empty results return empty arrays (not null)
- Invalid entity types handled by Link.create() validation

Follow existing test patterns from session-repository.test.ts (temporary database, setup/teardown).
  </action>
  <verify>
Run `bun test link-repository` - all tests pass
  </verify>
  <done>
SqliteLinkRepository implements save, saveMany, findBySource, findByTarget with passing tests
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement findRelated with recursive CTE for 2-hop traversal</name>
  <files>
    src/infrastructure/database/repositories/link-repository.ts
    src/infrastructure/database/repositories/link-repository.test.ts
  </files>
  <action>
Add findRelated method to SqliteLinkRepository:

```typescript
async findRelated(
  entityType: EntityType,
  entityId: string,
  maxHops: number = 2
): Promise<Link[]>
```

Implementation uses WITH RECURSIVE CTE (from research):

```sql
WITH RECURSIVE related(
  source_type, source_id, target_type, target_id,
  relationship, weight, hop, path
) AS (
  -- Base case: direct connections (1-hop)
  SELECT
    source_type, source_id, target_type, target_id,
    relationship, weight, 1 as hop,
    source_type || ':' || source_id || '->' || target_type || ':' || target_id as path
  FROM links
  WHERE source_type = $entityType AND source_id = $entityId

  UNION ALL

  -- Recursive case: next level connections
  SELECT
    l.source_type, l.source_id, l.target_type, l.target_id,
    l.relationship, l.weight * r.weight, r.hop + 1,
    r.path || '->' || l.target_type || ':' || l.target_id
  FROM links l
  JOIN related r ON l.source_type = r.target_type AND l.source_id = r.target_id
  WHERE r.hop < $maxHops
    -- Prevent cycles: don't revisit nodes in current path
    AND r.path NOT LIKE '%' || l.target_type || ':' || l.target_id || '%'
)
SELECT DISTINCT source_type, source_id, target_type, target_id, relationship, weight, hop
FROM related
ORDER BY hop ASC, weight DESC
```

Key implementation details:
- Weight decay: Multiply weights through path (0.8 * 0.8 = 0.64 for 2-hop)
- Cycle prevention: Path string LIKE check
- Distinct results: Same target via different paths appears once
- Order: Closer relationships first (lower hop), then by weight descending

Extended Link type for results (add hop to result):
```typescript
interface RelatedLink extends Link {
  hop: number;
}
```

Note: The port returns Link[], but internally track hop count. Store hop in the Link's relationship or create a wrapper. Simplest: return Links with a custom property, but since Link is immutable, create a result tuple type or extend the row mapper.

IMPORTANT: The ILinkRepository interface returns Link[]. For findRelated, we need hop information. Options:
1. Return Link[] and lose hop info (simplest but loses context)
2. Add hop as optional property on Link (breaks immutability principle)
3. Create RelatedLink type extending Link (cleanest)

Recommend option 3: Create a separate type for findRelated results that includes hop count. Update the interface in repositories.ts to return RelatedLink[] from findRelated.

Tests should cover:
- No relationships returns empty array
- 1-hop relationships returned with hop=1
- 2-hop relationships returned with hop=2 and decayed weight
- Cycles are prevented (A->B->A does not loop)
- maxHops=1 limits to direct connections only
- Results sorted by hop then weight
  </action>
  <verify>
Run `bun test link-repository` - all tests including findRelated pass
  </verify>
  <done>
findRelated method implements 2-hop graph traversal with weight decay, cycle prevention, and proper ordering
  </done>
</task>

<task type="auto">
  <name>Task 3: Export SqliteLinkRepository from index files</name>
  <files>
    src/infrastructure/database/repositories/index.ts
    src/infrastructure/database/index.ts
  </files>
  <action>
Update repository index to export SqliteLinkRepository:

```typescript
// In repositories/index.ts
export { SqliteLinkRepository } from "./link-repository.js";
```

Update database index to re-export:

```typescript
// In database/index.ts - add to existing exports
export { SqliteLinkRepository } from "./repositories/index.js";
```

If RelatedLink type was created, export it from domain/ports/repositories.ts and re-export through appropriate index files.
  </action>
  <verify>
Run `bun test` - all tests pass
Import works: `import { SqliteLinkRepository } from "../../../infrastructure/database/index.js"`
  </verify>
  <done>
SqliteLinkRepository exported from index files and importable from database/index.js
  </done>
</task>

</tasks>

<verification>
1. `bun test link-repository` passes all tests
2. `bun test` passes all existing tests (no regressions)
3. Coverage for link-repository.ts meets 95%+ threshold
4. WITH RECURSIVE CTE is used (grep for pattern in link-repository.ts)
5. Cycle prevention implemented (grep for "NOT LIKE" in SQL)
</verification>

<success_criteria>
1. SqliteLinkRepository fully implements ILinkRepository interface
2. save() persists links with proper upsert behavior
3. findBySource() and findByTarget() return correct links
4. findRelated() traverses up to 2 hops with recursive CTE
5. Weight decay occurs on multi-hop paths (0.8 * 0.8 = 0.64)
6. Cycles are prevented in graph traversal
7. Results ordered by hop count then weight
8. All tests pass with 95%+ coverage
</success_criteria>

<output>
After completion, create `.planning/phases/09-context-and-related-commands/09-01-SUMMARY.md`
</output>
