---
phase: 09-context-and-related-commands
plan: 04
type: execute
wave: 3
depends_on: ["09-01", "09-02", "09-03"]
files_modified:
  - src/infrastructure/database/index.ts
  - src/presentation/cli/index.ts
  - src/presentation/cli/formatters/index.ts
autonomous: true

must_haves:
  truths:
    - "User can run 'memory context <project>' from CLI"
    - "User can run 'memory related <id>' from CLI"
    - "SqliteLinkRepository is importable from infrastructure/database"
    - "Context and related formatters are importable from presentation/cli/formatters"
    - "All Phase 9 commands appear in 'memory --help'"
  artifacts:
    - path: "src/infrastructure/database/index.ts"
      provides: "Re-exports SqliteLinkRepository"
      contains: "SqliteLinkRepository"
    - path: "src/presentation/cli/index.ts"
      provides: "Wires context and related commands to CLI"
      contains: ["contextCommand", "relatedCommand"]
    - path: "src/presentation/cli/formatters/index.ts"
      provides: "Re-exports context and related formatters"
      contains: ["createContextFormatter", "createRelatedFormatter"]
  key_links:
    - from: "cli/index.ts"
      to: "context.ts"
      via: "addCommand"
      pattern: ".addCommand\\(createContextCommand"
    - from: "cli/index.ts"
      to: "related.ts"
      via: "addCommand"
      pattern: ".addCommand\\(createRelatedCommand"
    - from: "database/index.ts"
      to: "link-repository.ts"
      via: "export"
      pattern: "export.*SqliteLinkRepository"
---

<objective>
Wire all Phase 9 components into the CLI and export from index files.

Purpose: This integration plan ensures all newly created services, commands, and formatters are accessible through standard import paths and the CLI entry point. Without this wiring, the implementations from Plans 01-03 would be orphaned.

Output: Fully integrated context and related commands accessible via `memory context` and `memory related`.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-context-and-related-commands/09-01-SUMMARY.md
@.planning/phases/09-context-and-related-commands/09-02-SUMMARY.md
@.planning/phases/09-context-and-related-commands/09-03-SUMMARY.md

@src/infrastructure/database/index.ts
@src/presentation/cli/index.ts
@src/presentation/cli/formatters/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export SqliteLinkRepository and SqliteContextService from database index</name>
  <files>
    src/infrastructure/database/index.ts
    src/infrastructure/database/repositories/index.ts
    src/infrastructure/database/services/index.ts
  </files>
  <action>
Update repository and service index files to export new implementations.

In `src/infrastructure/database/repositories/index.ts`, add:
```typescript
export { SqliteLinkRepository } from "./link-repository.js";
```

Create or update `src/infrastructure/database/services/index.ts`:
```typescript
export { SqliteStatsService } from "./stats-service.js";
export { SqliteContextService, type ProjectContext, type ContextOptions } from "./context-service.js";
```

In `src/infrastructure/database/index.ts`, ensure re-exports:
```typescript
// Repositories
export {
  SqliteSessionRepository,
  SqliteMessageRepository,
  SqliteToolUseRepository,
  SqliteExtractionStateRepository,
  SqliteLinkRepository,  // Add this
} from "./repositories/index.js";

// Services
export {
  SqliteStatsService,
  SqliteContextService,  // Add this
  type ProjectContext,   // Add type export
  type ContextOptions,   // Add type export
} from "./services/index.js";
```

Verify imports work:
```typescript
// Should work after changes
import { SqliteLinkRepository, SqliteContextService } from "./infrastructure/database/index.js";
```
  </action>
  <verify>
Run `bun test` - all tests pass (no import errors)
Import check: Create a quick script that imports from database/index.ts and verify no errors
  </verify>
  <done>
SqliteLinkRepository and SqliteContextService exported from infrastructure/database/index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Export formatters from presentation/cli/formatters index</name>
  <files>
    src/presentation/cli/formatters/index.ts
  </files>
  <action>
Update formatters index to export new formatter factories and types.

In `src/presentation/cli/formatters/index.ts`, add exports:
```typescript
// Existing exports
export { OutputFormatter, createOutputFormatter } from "./output-formatter.js";
export { ListFormatter, createListFormatter } from "./list-formatter.js";

// Add new exports
export {
  ContextFormatter,
  createContextFormatter,
  type ContextOutputMode,
  type ContextFormatOptions,
} from "./context-formatter.js";

export {
  RelatedFormatter,
  createRelatedFormatter,
  type RelatedOutputMode,
  type RelatedFormatOptions,
  type RelatedSession,
} from "./related-formatter.js";
```

Verify imports work:
```typescript
// Should work after changes
import {
  createContextFormatter,
  createRelatedFormatter,
} from "./presentation/cli/formatters/index.js";
```
  </action>
  <verify>
Run `bun test` - all tests pass (no import errors)
  </verify>
  <done>
Context and related formatters exported from presentation/cli/formatters/index.ts
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire context and related commands into CLI entry point</name>
  <files>
    src/presentation/cli/index.ts
  </files>
  <action>
Add context and related commands to the CLI program.

In `src/presentation/cli/index.ts`:

1. Add imports at top:
```typescript
import { createContextCommand } from "./commands/context.js";
import { createRelatedCommand } from "./commands/related.js";
```

2. Add commands to program (follow existing pattern for stats, list):
```typescript
// Find where other commands are added, likely:
// program.addCommand(createStatsCommand());
// program.addCommand(createListCommand());

// Add after existing commands:
program.addCommand(createContextCommand());
program.addCommand(createRelatedCommand());
```

3. Verify command order makes sense (group navigation commands together):
   - sync
   - search
   - stats
   - list
   - context  (new)
   - related  (new)

Test CLI help shows new commands:
```bash
bun run src/index.ts --help
# Should show:
# Commands:
#   sync       Sync Claude Code sessions to database
#   search     Search across all sessions
#   stats      Show database statistics
#   list       List sessions
#   context    Show aggregated context for a project
#   related    Find sessions related through shared topics/entities
```
  </action>
  <verify>
Run `bun run src/index.ts --help` - context and related commands appear
Run `bun run src/index.ts context --help` - shows context command options
Run `bun run src/index.ts related --help` - shows related command options
  </verify>
  <done>
Context and related commands wired into CLI and appear in help output
  </done>
</task>

</tasks>

<verification>
1. `bun test` passes all tests (no import errors, no regressions)
2. `bun run src/index.ts --help` shows context and related commands
3. `bun run src/index.ts context --help` shows correct options
4. `bun run src/index.ts related --help` shows correct options
5. Import from index files works:
   - `import { SqliteLinkRepository } from "./infrastructure/database/index.js"`
   - `import { createContextFormatter } from "./presentation/cli/formatters/index.js"`
</verification>

<success_criteria>
1. All Phase 9 components properly exported from index files
2. Context command accessible via `memory context <project>`
3. Related command accessible via `memory related <id>`
4. Both commands appear in `memory --help`
5. No import errors when importing from index paths
6. All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-context-and-related-commands/09-04-SUMMARY.md`
</output>
