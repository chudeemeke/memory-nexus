---
phase: 09-context-and-related-commands
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/database/services/context-service.ts
  - src/infrastructure/database/services/context-service.test.ts
  - src/presentation/cli/commands/context.ts
  - src/presentation/cli/commands/context.test.ts
  - src/presentation/cli/formatters/context-formatter.ts
  - src/presentation/cli/formatters/context-formatter.test.ts
autonomous: true

must_haves:
  truths:
    - "User can run 'memory context <project>' and see aggregated context"
    - "Context shows session count, message count, recent tool usage"
    - "Context shows recent topics when links exist"
    - "--days N filters to sessions within time window"
    - "--format brief shows compact output"
    - "--format detailed shows full breakdown"
  artifacts:
    - path: "src/infrastructure/database/services/context-service.ts"
      provides: "ContextService for project aggregation queries"
      exports: ["SqliteContextService", "ProjectContext"]
    - path: "src/presentation/cli/commands/context.ts"
      provides: "CLI command handler for context"
      exports: ["createContextCommand"]
    - path: "src/presentation/cli/formatters/context-formatter.ts"
      provides: "Formatter strategy for context output"
      exports: ["createContextFormatter", "ContextFormatter"]
  key_links:
    - from: "context.ts command"
      to: "SqliteContextService"
      via: "dependency injection"
      pattern: "new SqliteContextService"
    - from: "context.ts command"
      to: "context-formatter.ts"
      via: "factory function"
      pattern: "createContextFormatter"
    - from: "context-service.ts"
      to: "sessions table"
      via: "SQL aggregation"
      pattern: "FROM sessions"
---

<objective>
Implement the context command for aggregating project-wide information from recent sessions.

Purpose: The context command helps Claude (and users) quickly understand what has been discussed in a project recently. It aggregates session counts, message counts, tool usage, and topics from recent sessions for a specific project.

Output: Working `memory context <project>` command with --days filter and --format brief/detailed options.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-context-and-related-commands/09-RESEARCH.md

@src/infrastructure/database/services/stats-service.ts
@src/presentation/cli/commands/stats.ts
@src/presentation/cli/commands/list.ts
@src/presentation/cli/formatters/list-formatter.ts
@src/domain/value-objects/project-path.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SqliteContextService with aggregation queries</name>
  <files>
    src/infrastructure/database/services/context-service.ts
    src/infrastructure/database/services/context-service.test.ts
  </files>
  <action>
Create SqliteContextService following stats-service.ts pattern.

Define ProjectContext interface:
```typescript
export interface ProjectContext {
  projectName: string;
  projectPathDecoded: string;
  sessionCount: number;
  totalMessages: number;
  userMessages: number;
  assistantMessages: number;
  recentTopics: string[];          // From links table (may be empty)
  recentToolUses: ToolUsage[];     // Top tools with counts
  lastActivity: Date | null;
}

interface ToolUsage {
  name: string;
  count: number;
}
```

Define ContextOptions interface:
```typescript
export interface ContextOptions {
  days?: number;          // Filter to last N days
  topicsLimit?: number;   // Max topics to return (default 10)
  toolsLimit?: number;    // Max tools to return (default 10)
}
```

Implement getProjectContext method:

```typescript
async getProjectContext(
  projectFilter: string,
  options: ContextOptions = {}
): Promise<ProjectContext | null>
```

Implementation steps:

1. Calculate sinceDate from options.days (follow list.ts pattern):
   ```typescript
   let sinceDate: Date | undefined;
   if (options.days) {
     const now = new Date();
     const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
     sinceDate = new Date(startOfToday.getTime() - (options.days - 1) * 24 * 60 * 60 * 1000);
   }
   ```

2. Find project by name (LIKE match for substring):
   ```sql
   SELECT DISTINCT project_name, project_path_decoded, project_path_encoded
   FROM sessions
   WHERE project_name LIKE '%' || $projectFilter || '%'
   LIMIT 1
   ```

3. Aggregate session and message counts:
   ```sql
   SELECT
     COUNT(DISTINCT s.id) as sessionCount,
     MAX(s.start_time) as lastActivity,
     COUNT(CASE WHEN m.role = 'user' THEN 1 END) as userMessages,
     COUNT(CASE WHEN m.role = 'assistant' THEN 1 END) as assistantMessages
   FROM sessions s
   LEFT JOIN messages_meta m ON m.session_id = s.id
   WHERE s.project_path_encoded = $projectPathEncoded
     ${sinceDate ? "AND s.start_time >= $sinceDate" : ""}
   ```

4. Get tool usage breakdown:
   ```sql
   SELECT name, COUNT(*) as count
   FROM tool_uses t
   JOIN sessions s ON t.session_id = s.id
   WHERE s.project_path_encoded = $projectPathEncoded
     ${sinceDate ? "AND t.timestamp >= $sinceDate" : ""}
   GROUP BY name
   ORDER BY count DESC
   LIMIT $toolsLimit
   ```

5. Get topics from links (handle empty gracefully):
   ```sql
   SELECT DISTINCT l.target_id as topic
   FROM links l
   JOIN sessions s ON l.source_type = 'session' AND l.source_id = s.id
   WHERE s.project_path_encoded = $projectPathEncoded
     AND l.target_type = 'topic'
   ORDER BY l.weight DESC
   LIMIT $topicsLimit
   ```

Return null if no sessions found for project.

Tests should cover:
- Returns null for unknown project
- Returns context with correct session/message counts
- User/assistant message breakdown is correct
- Tool usage sorted by count descending
- Topics returned (when links exist)
- Empty topics handled gracefully (empty array, not null)
- --days filter excludes old sessions
- Multiple projects matching filter returns first match
  </action>
  <verify>
Run `bun test context-service` - all tests pass
  </verify>
  <done>
SqliteContextService aggregates project data with session counts, message breakdown, tool usage, and topics
  </done>
</task>

<task type="auto">
  <name>Task 2: Create context formatter with brief/detailed modes</name>
  <files>
    src/presentation/cli/formatters/context-formatter.ts
    src/presentation/cli/formatters/context-formatter.test.ts
  </files>
  <action>
Create context formatter following list-formatter.ts strategy pattern.

Define types:
```typescript
export type ContextOutputMode = "default" | "json" | "brief" | "detailed" | "quiet";

export interface ContextFormatOptions {
  executionTimeMs?: number;
  filtersApplied?: string[];
}

export interface ContextFormatter {
  formatContext(context: ProjectContext, options?: ContextFormatOptions): string;
  formatError(error: Error): string;
  formatEmpty(projectName: string): string;
  formatNoTopics(): string;  // Message when no topics extracted yet
}
```

Factory function:
```typescript
export function createContextFormatter(
  mode: ContextOutputMode,
  useColor: boolean
): ContextFormatter
```

Implement formatters:

**BriefContextFormatter** (default for --format brief):
```
wow-system Context
Sessions: 15 | Messages: 2,340 | Last active: 2 hours ago
Topics: authentication, testing, refactoring (3 more)
Tools: Read (45), Write (23), Bash (12)
```

**DetailedContextFormatter** (for --format detailed):
```
wow-system Context
========================================

Project: C:\Users\Destiny\Projects\wow-system
Sessions: 15
Messages: 2,340 (user: 980, assistant: 1,360)
Last active: 2026-01-30 14:23:45

Topics:
  - authentication
  - testing
  - refactoring
  - database design
  - api development

Tool Usage:
  - Read: 45 times
  - Write: 23 times
  - Bash: 12 times
  - Grep: 8 times
```

**JsonContextFormatter**:
```json
{
  "projectName": "wow-system",
  "projectPath": "C:\\Users\\Destiny\\Projects\\wow-system",
  "sessionCount": 15,
  "totalMessages": 2340,
  "userMessages": 980,
  "assistantMessages": 1360,
  "lastActivity": "2026-01-30T14:23:45.000Z",
  "topics": ["authentication", "testing", ...],
  "toolUsage": [{"name": "Read", "count": 45}, ...]
}
```

**QuietContextFormatter**:
- Just project name and counts on single line: `wow-system: 15 sessions, 2340 messages`

**VerboseContextFormatter** (extends detailed with timing):
- Same as detailed but with execution details header

Use Intl.NumberFormat for number formatting (follows stats-formatter pattern).
Use formatRelativeTime for "last active" in brief mode.
Use formatTimestamp for detailed mode.

Tests should cover:
- Brief format shows compact single-line structure
- Detailed format shows full breakdown
- JSON format is valid parseable JSON
- Quiet format shows minimal info
- Empty topics shows appropriate message
- formatEmpty returns helpful message
- Color is applied when useColor=true
  </action>
  <verify>
Run `bun test context-formatter` - all tests pass
  </verify>
  <done>
Context formatter implements brief/detailed/json/quiet modes with proper formatting
  </done>
</task>

<task type="auto">
  <name>Task 3: Create context command handler</name>
  <files>
    src/presentation/cli/commands/context.ts
    src/presentation/cli/commands/context.test.ts
  </files>
  <action>
Create context command following list.ts and stats.ts patterns.

Command signature: `memory context <project>`

Options:
- `--days <n>` - Filter to last N days (follows list.ts argParser pattern)
- `--format <type>` - Output format: brief, detailed (default: brief)
- `--json` - JSON output (shorthand for --format json)
- `-v, --verbose` - Verbose output with timing (conflicts with quiet)
- `-q, --quiet` - Minimal output (conflicts with verbose)

```typescript
export function createContextCommand(): Command {
  return new Command("context")
    .description("Show aggregated context for a project")
    .argument("<project>", "Project name or substring to filter by")
    .addOption(
      new Option("--days <n>", "Sessions from last N days (includes today)")
        .argParser((val) => {
          const n = parseInt(val, 10);
          if (isNaN(n) || n < 1) throw new Error("Days must be a positive number");
          return n;
        })
    )
    .addOption(
      new Option("--format <type>", "Output format")
        .choices(["brief", "detailed"])
        .default("brief")
    )
    .option("--json", "Output as JSON")
    .addOption(
      new Option("-v, --verbose", "Show detailed output with timing")
        .conflicts("quiet")
    )
    .addOption(
      new Option("-q, --quiet", "Minimal output")
        .conflicts("verbose")
    )
    .action(async (project: string, options) => {
      await executeContextCommand(project, options);
    });
}
```

executeContextCommand implementation:
1. Initialize database (getDefaultDbPath, initializeDatabase)
2. Create SqliteContextService
3. Build ContextOptions from CLI options
4. Call getProjectContext(project, options)
5. Handle null return (project not found)
6. Determine output mode from options
7. Format and output
8. Close database in finally block

Error handling:
- Project not found: "No sessions found for project matching '<project>'"
- Database error: Standard error format with exit code 2

Tests should cover:
- Command registered with correct options
- Project argument is required
- --days validates positive number
- --format accepts brief/detailed
- --json sets json output mode
- --verbose and --quiet conflict
- Exit code 1 for user errors (project not found)
- Exit code 2 for internal errors
  </action>
  <verify>
Run `bun test context.test` - all command tests pass
  </verify>
  <done>
Context command handler wired to service with all CLI options working
  </done>
</task>

</tasks>

<verification>
1. `bun test context` passes all context-related tests
2. `bun test` passes all tests (no regressions)
3. Coverage meets 95%+ threshold for new files
4. Manual verification: `bun run src/index.ts context wow-system` shows context
5. Manual verification: `bun run src/index.ts context wow-system --days 7` filters
6. Manual verification: `bun run src/index.ts context wow-system --format detailed` shows detailed
</verification>

<success_criteria>
1. `memory context <project>` command shows aggregated context
2. Session count, message counts (total, user, assistant) correct
3. Tool usage shows top tools with counts
4. Topics shown when links exist, graceful empty state otherwise
5. --days N filters to recent sessions
6. --format brief shows compact output
7. --format detailed shows full breakdown
8. --json outputs valid JSON
9. All tests pass with 95%+ coverage
</success_criteria>

<output>
After completion, create `.planning/phases/09-context-and-related-commands/09-02-SUMMARY.md`
</output>
