---
phase: 04-storage-adapters
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/database/repositories/tool-use-repository.ts
  - src/infrastructure/database/repositories/tool-use-repository.test.ts
  - src/infrastructure/database/repositories/index.ts
autonomous: true

must_haves:
  truths:
    - "Tool uses can be saved with session association"
    - "Tool uses can be queried by session"
    - "Tool use inputs are stored as JSON"
    - "Batch insert follows same pattern as messages"
  artifacts:
    - path: "src/infrastructure/database/repositories/tool-use-repository.ts"
      provides: "IToolUseRepository implementation"
      exports: ["SqliteToolUseRepository"]
  key_links:
    - from: "SqliteToolUseRepository"
      to: "tool_uses table"
      via: "prepared statements with INSERT OR IGNORE"
      pattern: "INSERT OR IGNORE INTO tool_uses"
---

<objective>
Implement SqliteToolUseRepository for persisting tool invocation records.

Purpose: Tool uses track what tools Claude invoked during sessions. This enables queries like "what files were edited?" and "what commands were run?".

Output: Tool use repository implementing IToolUseRepository with batch support.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-storage-adapters/04-CONTEXT.md

@src/domain/ports/repositories.ts
@src/domain/entities/tool-use.ts
@src/infrastructure/database/schema.ts
@src/infrastructure/database/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SqliteToolUseRepository</name>
  <files>
    src/infrastructure/database/repositories/tool-use-repository.ts
    src/infrastructure/database/repositories/tool-use-repository.test.ts
  </files>
  <action>
Create SqliteToolUseRepository implementing IToolUseRepository:

1. Constructor accepts Database instance, creates prepared statements:
   - findByIdStmt: SELECT by id
   - findBySessionStmt: SELECT WHERE session_id ORDER BY timestamp
   - insertStmt: INSERT OR IGNORE

2. Implement interface methods:
   - findById(id): Returns ToolUse | null
   - findBySession(sessionId): Returns ToolUse[], ordered by timestamp
   - save(toolUse, sessionId): Single insert with INSERT OR IGNORE
   - saveMany(toolUses): Batch insert using db.transaction().immediate()

3. Row mapping:
   - ToolUse entity properties: id, name, timestamp, inputs (Record), status, result (optional)
   - DB columns: id, session_id, name, input (JSON string), timestamp, status, result (nullable)
   - Parse input from JSON on read, stringify on write

4. Status values: 'pending', 'success', 'error' (per schema constraint)

Write tests covering:
- save and findById round-trip
- findBySession returns tool uses in timestamp order
- INSERT OR IGNORE on duplicate ID
- JSON serialization of input object
- Status constraint enforcement
- saveMany batch insert (50+ tool uses)
  </action>
  <verify>
Run `bun test src/infrastructure/database/repositories/tool-use-repository.test.ts` - all tests pass.
  </verify>
  <done>
SqliteToolUseRepository implements all IToolUseRepository methods with proper JSON handling and batch support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update repository index exports</name>
  <files>
    src/infrastructure/database/repositories/index.ts
  </files>
  <action>
Update the repository index to include new exports:

1. Add to src/infrastructure/database/repositories/index.ts:
   - Export SqliteToolUseRepository
   - Export SqliteMessageRepository (from previous plan)

2. Run full test suite to verify no import/export issues.
  </action>
  <verify>
Run `bun test` - all tests pass including new repository tests.
  </verify>
  <done>
All repository implementations exported and accessible via barrel file.
  </done>
</task>

</tasks>

<verification>
Phase requirements addressed:
- Tool use persistence (supporting STOR-02 pattern)
- Batch writes following STOR-06 pattern

Run verification commands:
```bash
# Repository tests pass
bun test src/infrastructure/database/repositories/tool-use-repository.test.ts

# Full suite passes
bun test
```
</verification>

<success_criteria>
1. SqliteToolUseRepository passes all interface contract tests
2. JSON serialization/deserialization of input works correctly
3. saveMany batch insert works efficiently
4. INSERT OR IGNORE handles duplicates
5. All exports configured correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-storage-adapters/04-03-SUMMARY.md`
</output>
