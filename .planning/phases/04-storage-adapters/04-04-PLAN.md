---
phase: 04-storage-adapters
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - src/infrastructure/database/services/search-service.ts
  - src/infrastructure/database/services/search-service.test.ts
  - src/infrastructure/database/services/index.ts
  - src/infrastructure/database/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Full-text search finds messages by content"
    - "Results are ranked by BM25 relevance"
    - "Search uses MATCH operator (verified via EXPLAIN QUERY PLAN)"
    - "WAL checkpoint reduces WAL file size after bulk operations"
    - "Interrupted extraction leaves no partial state"
  artifacts:
    - path: "src/infrastructure/database/services/search-service.ts"
      provides: "ISearchService implementation with BM25"
      exports: ["Fts5SearchService"]
  key_links:
    - from: "Fts5SearchService.search"
      to: "messages_fts"
      via: "FTS5 MATCH with bm25()"
      pattern: "WHERE messages_fts MATCH"
    - from: "Search results"
      to: "SearchResult value object"
      via: "BM25 score normalization (0-1)"
      pattern: "SearchResult\\.create"
---

<objective>
Implement Fts5SearchService with BM25 ranking and complete Phase 4 with integration tests.

Purpose: Search is the core value proposition - users need to find relevant messages across all sessions. This plan delivers the search implementation and validates the complete storage layer.

Output: Search service implementing ISearchService, WAL checkpoint utility function, and integration tests proving transaction safety.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-storage-adapters/04-CONTEXT.md
@.planning/phases/04-storage-adapters/04-RESEARCH.md

@src/domain/ports/services.ts
@src/domain/value-objects/search-query.ts
@src/domain/value-objects/search-result.ts
@src/infrastructure/database/schema.ts
@src/infrastructure/database/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Fts5SearchService</name>
  <files>
    src/infrastructure/database/services/search-service.ts
    src/infrastructure/database/services/search-service.test.ts
  </files>
  <action>
Create Fts5SearchService implementing ISearchService:

1. Constructor accepts Database instance, creates prepared statements:
   - searchStmt: SELECT with FTS5 MATCH, bm25(), and snippet()

2. Search query (CRITICAL - must use MATCH, never =):
```sql
SELECT
  m.id,
  m.session_id,
  m.content,
  m.timestamp,
  bm25(messages_fts) as score,
  snippet(messages_fts, 0, '<mark>', '</mark>', '...', 32) as snippet
FROM messages_fts f
JOIN messages_meta m ON f.rowid = m.rowid
WHERE messages_fts MATCH $query
ORDER BY score  -- Ascending: more negative = better
LIMIT $limit
```

3. Implement search(query, options?):
   - Extract query.value for FTS5 MATCH
   - Apply options.limit (default 20)
   - Apply filters via additional WHERE clauses (joined to sessions if needed):
     - projectFilter: JOIN sessions, WHERE project_path_encoded
     - roleFilter: WHERE m.role = ?
     - sinceDate: WHERE m.timestamp >= ?
     - beforeDate: WHERE m.timestamp <= ?
   - Normalize BM25 scores to 0-1 range
   - Map results to SearchResult value objects

4. BM25 normalization (per RESEARCH.md):
   - BM25 returns negative values (more negative = better)
   - Find min/max scores in result set
   - Normalize: score = 1 - ((raw - min) / (max - min))
   - Handle single-result case (score = 1.0)

Write tests covering:
- Basic search finds matching content
- BM25 ranking orders relevant results first
- Snippet extraction includes match context
- Project filter limits to specific project
- Role filter limits to user/assistant
- Date filters work correctly
- Empty results return empty array
- EXPLAIN QUERY PLAN shows FTS5 usage (":M1" in plan)
  </action>
  <verify>
Run `bun test src/infrastructure/database/services/search-service.test.ts` - all tests pass.
  </verify>
  <done>
Fts5SearchService implements ISearchService with BM25 ranking, snippet extraction, and all filter options. MATCH operator verified via EXPLAIN QUERY PLAN.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add WAL checkpoint utility and transaction safety tests</name>
  <files>
    src/infrastructure/database/connection.ts
    src/infrastructure/database/integration.test.ts
  </files>
  <action>
1. Enhance connection.ts (verify existing functions or add):
   - checkpointDatabase(db): PRAGMA wal_checkpoint(PASSIVE) - non-blocking
   - closeDatabase(db): PRAGMA wal_checkpoint(TRUNCATE) then close - blocking

2. Add bulkOperationCheckpoint(db) function:
   - Call PRAGMA wal_checkpoint(TRUNCATE) after bulk operations
   - Returns checkpoint result: { busy: number, log: number, checkpointed: number }

3. Add integration tests to existing integration.test.ts:

Test: "WAL checkpoint reduces WAL file size after bulk insert"
   - Get initial WAL file size
   - Insert 500+ messages via repository
   - Get WAL file size (should be larger)
   - Call bulkOperationCheckpoint()
   - Get WAL file size (should be smaller or zero)

Test: "Transaction rollback leaves no partial state"
   - Start extraction state as 'in_progress'
   - Insert some messages
   - Simulate error (throw) before commit
   - Verify: extraction state not changed to 'complete'
   - Verify: messages not in database
   - This validates per-session transaction boundary
  </action>
  <verify>
Run `bun test src/infrastructure/database/integration.test.ts` - WAL and transaction tests pass.
  </verify>
  <done>
WAL checkpoint utility function reduces WAL file after bulk operations. Transaction safety verified: rollback leaves no partial state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create services index and final integration validation</name>
  <files>
    src/infrastructure/database/services/index.ts
    src/infrastructure/database/index.ts
  </files>
  <action>
1. Create src/infrastructure/database/services/index.ts:
   - Export Fts5SearchService

2. Update src/infrastructure/database/index.ts:
   - Add export * from "./services/index.js"
   - Ensure all repositories and services exported

3. Add comprehensive integration test:

Test: "Full extraction pipeline with search verification"
   - Create session via SqliteSessionRepository
   - Insert 50 messages via SqliteMessageRepository
   - Update extraction state to 'complete' via SqliteExtractionStateRepository
   - Search for content via Fts5SearchService
   - Verify: session findById returns session
   - Verify: messages findBySession returns all 50
   - Verify: search returns relevant results with snippets
   - Verify: extraction state shows 'complete'

4. Run full test suite with coverage report.
  </action>
  <verify>
Run `bun test` - all tests pass. Coverage remains above 95%.
  </verify>
  <done>
All Phase 4 components integrated and validated. Full extraction pipeline works end-to-end from session creation through search.
  </done>
</task>

</tasks>

<verification>
Phase requirements addressed:
- STOR-03: Fts5SearchService implementing ISearchService with BM25 ranking (Task 1)
- STOR-08: WAL checkpoint after bulk operations (Task 2)
- STOR-07: Transaction-based extraction state updates verified (Task 2)

Run verification commands:
```bash
# Search service tests
bun test src/infrastructure/database/services/search-service.test.ts

# Integration tests
bun test src/infrastructure/database/integration.test.ts

# Full suite with coverage
bun test --coverage

# Verify FTS5 MATCH usage
bun test --test-name-pattern "EXPLAIN"
```
</verification>

<success_criteria>
1. Search finds messages by content using FTS5 MATCH
2. Results ranked by BM25 (most relevant first)
3. EXPLAIN QUERY PLAN shows FTS5 usage (not full table scan)
4. WAL checkpoint reduces file size after bulk operations
5. Transaction rollback leaves database in consistent state
6. Full pipeline integration test passes
7. All tests pass with 95%+ coverage at each metric
</success_criteria>

<output>
After completion, create `.planning/phases/04-storage-adapters/04-04-SUMMARY.md`
</output>
