---
phase: 08-stats-and-list-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/ports/services.ts
  - src/infrastructure/database/services/stats-service.ts
  - src/infrastructure/database/services/stats-service.test.ts
  - src/infrastructure/database/services/index.ts
  - src/presentation/cli/commands/stats.ts
  - src/presentation/cli/commands/stats.test.ts
  - src/presentation/cli/commands/index.ts
  - src/presentation/cli/formatters/stats-formatter.ts
  - src/presentation/cli/formatters/stats-formatter.test.ts
  - src/presentation/cli/formatters/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can run `memory stats` and see total session/message/tool-use counts"
    - "Stats shows per-project breakdown with session and message counts"
    - "Stats shows database size in human-readable format (KB/MB)"
    - "Empty database shows explicit 'no data synced' message"
  artifacts:
    - path: "src/domain/ports/services.ts"
      provides: "IStatsService interface and StatsResult type"
      contains: "interface IStatsService"
    - path: "src/infrastructure/database/services/stats-service.ts"
      provides: "SqliteStatsService implementation"
      exports: ["SqliteStatsService"]
    - path: "src/presentation/cli/commands/stats.ts"
      provides: "Stats CLI command"
      exports: ["createStatsCommand"]
    - path: "src/presentation/cli/formatters/stats-formatter.ts"
      provides: "Stats output formatting with default/json/quiet/verbose modes"
      exports: ["createStatsFormatter", "StatsFormatter"]
  key_links:
    - from: "src/presentation/cli/commands/stats.ts"
      to: "SqliteStatsService"
      via: "dependency injection in command handler"
      pattern: "new SqliteStatsService\\(db\\)"
    - from: "src/infrastructure/database/services/stats-service.ts"
      to: "bun:sqlite"
      via: "prepared statement queries"
      pattern: "db\\.prepare"
    - from: "src/presentation/cli/commands/stats.ts"
      to: "stats-formatter"
      via: "formatter factory function"
      pattern: "createStatsFormatter"
---

<objective>
Implement statistics command showing database-wide counts and per-project breakdown.

Purpose: Enable users to quickly understand their memory database scope - how many sessions, messages, and tool uses are stored, and how data is distributed across projects.

Output: Working `memory stats` command with formatted output showing totals and per-project breakdown.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stats-and-list-commands/08-RESEARCH.md

# Existing patterns to follow
@src/domain/ports/services.ts (ISearchService pattern for new IStatsService)
@src/infrastructure/database/services/search-service.ts (SqliteStatsService pattern)
@src/presentation/cli/commands/search.ts (stats command pattern)
@src/presentation/cli/formatters/output-formatter.ts (stats-formatter pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatsService port interface and implementation</name>
  <files>
    src/domain/ports/services.ts
    src/infrastructure/database/services/stats-service.ts
    src/infrastructure/database/services/stats-service.test.ts
    src/infrastructure/database/services/index.ts
  </files>
  <action>
1. In `src/domain/ports/services.ts`, add after ISearchService:

```typescript
/**
 * Database statistics result.
 */
export interface StatsResult {
  totalSessions: number;
  totalMessages: number;
  totalToolUses: number;
  databaseSizeBytes: number;
  projectBreakdown: ProjectStats[];
}

/**
 * Per-project statistics.
 */
export interface ProjectStats {
  projectName: string;
  sessionCount: number;
  messageCount: number;
}

/**
 * Service for database statistics queries.
 */
export interface IStatsService {
  /**
   * Get database-wide statistics with per-project breakdown.
   * @param projectLimit Maximum projects to include in breakdown (default 10)
   */
  getStats(projectLimit?: number): Promise<StatsResult>;
}
```

2. Create `src/infrastructure/database/services/stats-service.ts`:
   - Import Database from "bun:sqlite" and types from ports
   - Use single query with subqueries for totals (see research pattern):
     ```sql
     SELECT
       (SELECT COUNT(*) FROM sessions) as totalSessions,
       (SELECT COUNT(*) FROM messages_meta) as totalMessages,
       (SELECT COUNT(*) FROM tool_uses) as totalToolUses
     ```
   - Use table-valued PRAGMA for database size:
     ```sql
     SELECT page_size * page_count as size
     FROM pragma_page_count(), pragma_page_size()
     ```
   - Use GROUP BY with COUNT(m.id) NOT COUNT(*) for project breakdown:
     ```sql
     SELECT
       s.project_name as projectName,
       COUNT(DISTINCT s.id) as sessionCount,
       COUNT(m.id) as messageCount
     FROM sessions s
     LEFT JOIN messages_meta m ON m.session_id = s.id
     GROUP BY s.project_name
     ORDER BY sessionCount DESC
     LIMIT $limit
     ```
   - Return Promise (async interface even though bun:sqlite is sync)

3. Create `src/infrastructure/database/services/stats-service.test.ts`:
   - Test empty database returns zeros
   - Test with sessions, messages, tool_uses returns correct counts
   - Test per-project breakdown groups correctly
   - Test projectLimit parameter limits results
   - Test database size is positive number
   - Use in-memory database with createSchema for isolation

4. Update `src/infrastructure/database/services/index.ts`:
   - Export SqliteStatsService
  </action>
  <verify>
    Run `bun test src/infrastructure/database/services/stats-service.test.ts` - all tests pass (expect ~8-10 tests)
  </verify>
  <done>
    IStatsService interface defined. SqliteStatsService returns correct totals, database size, and per-project breakdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stats output formatter</name>
  <files>
    src/presentation/cli/formatters/stats-formatter.ts
    src/presentation/cli/formatters/stats-formatter.test.ts
    src/presentation/cli/formatters/index.ts
  </files>
  <action>
1. Create `src/presentation/cli/formatters/stats-formatter.ts`:

```typescript
/**
 * Stats Formatter
 *
 * Strategy pattern for formatting stats results.
 * Supports default, JSON, quiet, and verbose modes.
 */

import type { StatsResult, ProjectStats } from "../../../domain/ports/services.js";

export type StatsOutputMode = "default" | "json" | "quiet" | "verbose";

export interface StatsFormatOptions {
  executionTimeMs?: number;
}

export interface StatsFormatter {
  formatStats(stats: StatsResult, options?: StatsFormatOptions): string;
  formatError(error: Error): string;
  formatEmpty(): string;
}

export function createStatsFormatter(mode: StatsOutputMode, useColor: boolean): StatsFormatter {
  switch (mode) {
    case "json":
      return new JsonStatsFormatter();
    case "quiet":
      return new QuietStatsFormatter();
    case "verbose":
      return new VerboseStatsFormatter(useColor);
    default:
      return new DefaultStatsFormatter(useColor);
  }
}
```

2. Implement formatters:
   - Use Intl.NumberFormat("en-US") for number formatting with commas
   - Create formatBytes() helper: B, KB, MB, GB thresholds at 1024
   - DefaultStatsFormatter: Header, totals table, project breakdown list
   - JsonStatsFormatter: JSON.stringify with camelCase keys
   - QuietStatsFormatter: Just numbers on lines (sessions, messages, tools, size)
   - VerboseStatsFormatter: Add execution time header, full details

3. Handle empty state:
   - formatEmpty() returns "No sessions synced. Run 'memory sync' to import data."

4. Create `src/presentation/cli/formatters/stats-formatter.test.ts`:
   - Test default format includes headers and sections
   - Test JSON format is valid JSON
   - Test quiet format is minimal
   - Test verbose format includes timing
   - Test empty state message
   - Test number formatting (thousands separators)
   - Test bytes formatting (KB, MB thresholds)

5. Update `src/presentation/cli/formatters/index.ts`:
   - Export createStatsFormatter, StatsFormatter, StatsOutputMode
  </action>
  <verify>
    Run `bun test src/presentation/cli/formatters/stats-formatter.test.ts` - all tests pass (expect ~12-15 tests)
  </verify>
  <done>
    Stats formatter supports all output modes with proper number and byte formatting.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create stats CLI command</name>
  <files>
    src/presentation/cli/commands/stats.ts
    src/presentation/cli/commands/stats.test.ts
    src/presentation/cli/commands/index.ts
  </files>
  <action>
1. Create `src/presentation/cli/commands/stats.ts`:

```typescript
/**
 * Stats Command Handler
 *
 * CLI command for database statistics overview.
 */

import { Command, Option } from "commander";
import {
  initializeDatabase,
  closeDatabase,
  getDefaultDbPath,
  SqliteStatsService,
} from "../../../infrastructure/database/index.js";
import { createStatsFormatter, type StatsOutputMode } from "../formatters/stats-formatter.js";
import { shouldUseColor } from "../formatters/color.js";

interface StatsCommandOptions {
  json?: boolean;
  verbose?: boolean;
  quiet?: boolean;
  projects?: string;
}

export function createStatsCommand(): Command {
  return new Command("stats")
    .description("Show database statistics")
    .option("--json", "Output as JSON")
    .addOption(
      new Option("-v, --verbose", "Show detailed output with timing")
        .conflicts("quiet")
    )
    .addOption(
      new Option("-q, --quiet", "Minimal output")
        .conflicts("verbose")
    )
    .option("--projects <count>", "Number of projects to show in breakdown", "10")
    .action(async (options: StatsCommandOptions) => {
      await executeStatsCommand(options);
    });
}

export async function executeStatsCommand(options: StatsCommandOptions): Promise<void> {
  const startTime = performance.now();

  const dbPath = getDefaultDbPath();
  const { db } = initializeDatabase({ path: dbPath });

  try {
    const statsService = new SqliteStatsService(db);

    // Parse project limit
    const projectLimit = parseInt(options.projects ?? "10", 10);
    if (isNaN(projectLimit) || projectLimit < 1) {
      console.error("Error: Projects count must be a positive number");
      process.exitCode = 1;
      return;
    }

    // Get stats
    const stats = await statsService.getStats(projectLimit);

    // Determine output mode
    let outputMode: StatsOutputMode = "default";
    if (options.json) outputMode = "json";
    else if (options.verbose) outputMode = "verbose";
    else if (options.quiet) outputMode = "quiet";

    const useColor = shouldUseColor();
    const formatter = createStatsFormatter(outputMode, useColor);

    // Check for empty database
    if (stats.totalSessions === 0) {
      console.log(formatter.formatEmpty());
      return;
    }

    // Format and output
    const endTime = performance.now();
    const output = formatter.formatStats(stats, {
      executionTimeMs: Math.round(endTime - startTime),
    });
    console.log(output);

  } catch (error) {
    const message = error instanceof Error ? error.message : String(error);
    console.error(`Error: ${message}`);
    process.exitCode = 2;
  } finally {
    closeDatabase(db);
  }
}
```

2. Create `src/presentation/cli/commands/stats.test.ts`:
   - Test command creation
   - Test help text includes options
   - Test --json flag sets output mode
   - Test --verbose and --quiet conflict
   - Test --projects option parsing
   - Test invalid --projects value handling

3. Update `src/presentation/cli/commands/index.ts`:
   - Export createStatsCommand
  </action>
  <verify>
    Run `bun test src/presentation/cli/commands/stats.test.ts` - all tests pass (expect ~8-10 tests)
  </verify>
  <done>
    Stats command works with all output modes and project limit option.
  </done>
</task>

</tasks>

<verification>
1. Run all new tests: `bun test stats` - expect ~30 tests to pass
2. Run full test suite: `bun test` - all existing tests still pass
3. Manual smoke test (if database has data):
   - `bun run src/index.ts stats` - shows totals and breakdown
   - `bun run src/index.ts stats --json` - outputs valid JSON
   - `bun run src/index.ts stats --verbose` - shows timing
   - `bun run src/index.ts stats --quiet` - minimal output
</verification>

<success_criteria>
1. `memory stats` shows total sessions, messages, tool uses, and database size
2. Per-project breakdown shows session and message counts per project
3. All output modes work (default, json, verbose, quiet)
4. Empty database shows helpful "run sync first" message
5. ~30 new tests added and passing
</success_criteria>

<output>
After completion, create `.planning/phases/08-stats-and-list-commands/08-01-SUMMARY.md`
</output>
