---
phase: 08-stats-and-list-commands
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/presentation/cli/formatters/stats-formatter.ts
  - src/presentation/cli/formatters/stats-formatter.test.ts
  - src/infrastructure/database/services/stats-service.ts
  - src/infrastructure/database/services/stats-service.test.ts
  - src/domain/entities/session.ts
  - src/domain/entities/session.test.ts
  - src/infrastructure/database/repositories/session-repository.ts
  - src/infrastructure/database/repositories/session-repository.test.ts
  - src/presentation/cli/formatters/list-formatter.ts
  - src/presentation/cli/formatters/list-formatter.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Quiet mode outputs labeled format (Sessions: X, Messages: X)"
    - "Stats --projects N shows totals only for those N projects"
    - "List command shows actual message counts per session"
  artifacts:
    - path: "src/presentation/cli/formatters/stats-formatter.ts"
      provides: "Labeled quiet output"
      contains: "Sessions:"
    - path: "src/infrastructure/database/services/stats-service.ts"
      provides: "Filtered totals from project breakdown"
      contains: "reduce"
    - path: "src/domain/entities/session.ts"
      provides: "messageCount property"
      contains: "messageCount"
  key_links:
    - from: "src/infrastructure/database/repositories/session-repository.ts"
      to: "Session.create"
      via: "messageCount from row.message_count"
      pattern: "messageCount.*row\\.message_count"
    - from: "src/presentation/cli/formatters/list-formatter.ts"
      to: "session.messageCount"
      via: "display message count"
      pattern: "session\\.messageCount"
---

<objective>
Close three UAT gaps from Phase 8 User Acceptance Testing:

1. **Quiet mode labels** - Add labels to quiet stats output so numbers are understandable
2. **Stats filtered totals** - When --projects N is used, show totals only for those N projects
3. **List message count** - Display actual message counts from database, not from empty messages array

Purpose: Make CLI output understandable and accurate for both humans and Claude agents
Output: Updated formatters, stats service, and session entity with passing tests
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-stats-and-list-commands/08-UAT.md
@src/presentation/cli/formatters/stats-formatter.ts
@src/infrastructure/database/services/stats-service.ts
@src/domain/entities/session.ts
@src/infrastructure/database/repositories/session-repository.ts
@src/presentation/cli/formatters/list-formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add labels to quiet stats output</name>
  <files>
    src/presentation/cli/formatters/stats-formatter.ts
    src/presentation/cli/formatters/stats-formatter.test.ts
  </files>
  <action>
Update QuietStatsFormatter.formatStats() to output labeled format instead of raw numbers.

**Current behavior (lines 208-227):**
```typescript
formatStats(stats: ExtendedStatsResult, _options?: StatsFormatOptions): string {
  return [
    String(stats.totalSessions),
    String(stats.totalMessages),
    String(stats.totalToolUses),
    String(stats.databaseSizeBytes),
  ].join("\n");
}
```

**Required change:**
```typescript
formatStats(stats: ExtendedStatsResult, _options?: StatsFormatOptions): string {
  return [
    `Sessions: ${stats.totalSessions}`,
    `Messages: ${stats.totalMessages}`,
    `Tool uses: ${stats.totalToolUses}`,
    `Size: ${stats.databaseSizeBytes}`,
  ].join("\n");
}
```

Also update formatEmpty():
```typescript
formatEmpty(): string {
  return "Sessions: 0\nMessages: 0\nTool uses: 0\nSize: 0";
}
```

**Update tests** (lines 135-158):
- Change test "outputs just numbers on lines" to expect labeled format
- Change test "has no header" to verify no "===" header but labels are present
- Change formatEmpty test to expect labeled format
  </action>
  <verify>
```bash
bun test src/presentation/cli/formatters/stats-formatter.test.ts --grep "quiet mode"
```
All quiet mode tests pass with new labeled format.
  </verify>
  <done>
Quiet mode outputs "Sessions: X\nMessages: X\nTool uses: X\nSize: X" format.
Tests updated and passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compute filtered totals from project breakdown</name>
  <files>
    src/infrastructure/database/services/stats-service.ts
    src/infrastructure/database/services/stats-service.test.ts
  </files>
  <action>
Modify SqliteStatsService.getStats() to compute totals from project breakdown when projectLimit is applied.

**Current behavior:**
- Lines 68-77: Totals query counts entire database
- Lines 90-104: Project breakdown uses LIMIT
- Result: Totals always show full database, even when only N projects displayed

**Required change:**
1. Keep the totals query for database size (this is always total)
2. After fetching project breakdown, compute session/message totals by summing breakdown

```typescript
async getStats(projectLimit = 10): Promise<StatsResult> {
  // Get database size (always total)
  const sizeRow = this.db
    .prepare<SizeRow, []>(
      `SELECT page_size * page_count as size
       FROM pragma_page_count(), pragma_page_size()`
    )
    .get();

  // Get per-project breakdown (limited)
  const projectRows = this.db
    .prepare<ProjectStatsRow, [number]>(
      `SELECT
        s.project_name as projectName,
        COUNT(DISTINCT s.id) as sessionCount,
        COUNT(m.id) as messageCount
      FROM sessions s
      LEFT JOIN messages_meta m ON m.session_id = s.id
      GROUP BY s.project_name
      ORDER BY sessionCount DESC
      LIMIT ?`
    )
    .all(projectLimit);

  // Compute totals from filtered breakdown
  const totalSessions = projectRows.reduce((sum, row) => sum + row.sessionCount, 0);
  const totalMessages = projectRows.reduce((sum, row) => sum + row.messageCount, 0);

  // Get total tool uses (still from full database - not per-project breakdown)
  const toolUsesRow = this.db
    .prepare<{ totalToolUses: number }, []>(
      `SELECT COUNT(*) as totalToolUses FROM tool_uses`
    )
    .get();

  return {
    totalSessions,
    totalMessages,
    totalToolUses: toolUsesRow?.totalToolUses ?? 0,
    databaseSizeBytes: sizeRow?.size ?? 0,
    projectBreakdown: projectRows.map((row) => ({
      projectName: row.projectName,
      sessionCount: row.sessionCount,
      messageCount: row.messageCount,
    })),
  };
}
```

**Add/update tests:**
- Test that totals match sum of displayed projects when limit applied
- Test that database size is still total (not filtered)
  </action>
  <verify>
```bash
bun test src/infrastructure/database/services/stats-service.test.ts
```
All stats service tests pass, including new filtered totals test.
  </verify>
  <done>
Stats with --projects N shows totals as sum of displayed N projects.
Database size remains total (unfiltered).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add messageCount to Session entity and populate from DB</name>
  <files>
    src/domain/entities/session.ts
    src/domain/entities/session.test.ts
    src/infrastructure/database/repositories/session-repository.ts
    src/infrastructure/database/repositories/session-repository.test.ts
    src/presentation/cli/formatters/list-formatter.ts
    src/presentation/cli/formatters/list-formatter.test.ts
  </files>
  <action>
The Session entity has messages array but messages are NOT loaded when listing sessions.
The database stores message_count but rowToSession() ignores it.
Add messageCount property to Session for display purposes.

**Step 1: Update Session entity (session.ts)**

Add messageCount to SessionParams interface:
```typescript
interface SessionParams {
  id: string;
  projectPath: ProjectPath;
  startTime: Date;
  endTime?: Date | undefined;
  messages?: readonly Message[] | undefined;
  summary?: string | undefined;
  messageCount?: number | undefined;  // Add this
}
```

Add private field and getter:
```typescript
private readonly _messageCount?: number | undefined;

// In constructor:
this._messageCount = params.messageCount;

// Add getter:
get messageCount(): number {
  // Return explicit messageCount if set, otherwise fall back to messages.length
  return this._messageCount ?? this._messages.length;
}
```

Update mutation methods (addMessage, complete, withSummary) to preserve messageCount.

**Step 2: Update session-repository.ts rowToSession()**

Change line 98-107 to include messageCount:
```typescript
private rowToSession(row: SessionRow): Session {
  const projectPath = ProjectPath.fromDecoded(row.project_path_decoded);
  return Session.create({
    id: row.id,
    projectPath,
    startTime: new Date(row.start_time),
    endTime: row.end_time ? new Date(row.end_time) : undefined,
    summary: row.summary ?? undefined,
    messageCount: row.message_count,  // Add this line
  });
}
```

**Step 3: Update list-formatter.ts**

Replace all `session.messages.length` with `session.messageCount`:
- Line 98: DefaultListFormatter
- Line 130: JsonListFormatter
- Line 204: VerboseListFormatter

**Step 4: Add tests**

Session entity test:
- Test messageCount getter returns provided value
- Test messageCount falls back to messages.length when not provided
- Test mutation methods preserve messageCount

Repository test:
- Test rowToSession populates messageCount from row

Formatter test:
- Verify formatters use session.messageCount
  </action>
  <verify>
```bash
bun test src/domain/entities/session.test.ts
bun test src/infrastructure/database/repositories/session-repository.test.ts
bun test src/presentation/cli/formatters/list-formatter.test.ts
```
All tests pass. Session.messageCount property works correctly.
  </verify>
  <done>
List command shows accurate message counts from database.
Session entity supports both explicit messageCount and messages.length fallback.
  </done>
</task>

</tasks>

<verification>
Run full test suite for affected files:
```bash
bun test src/presentation/cli/formatters/stats-formatter.test.ts
bun test src/infrastructure/database/services/stats-service.test.ts
bun test src/domain/entities/session.test.ts
bun test src/infrastructure/database/repositories/session-repository.test.ts
bun test src/presentation/cli/formatters/list-formatter.test.ts
```

Manual verification:
```bash
# Quiet mode should show labels
bun run src/presentation/cli/index.ts stats --quiet

# Totals should match project breakdown
bun run src/presentation/cli/index.ts stats --projects 3

# List should show non-zero message counts
bun run src/presentation/cli/index.ts list --limit 5
```
</verification>

<success_criteria>
1. `stats --quiet` outputs "Sessions: X\nMessages: X\nTool uses: X\nSize: X"
2. `stats --projects 3` shows totals that equal sum of displayed 3 projects
3. `list` shows actual message counts per session (not 0)
4. All existing tests continue to pass
5. New tests added for gap closure functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-stats-and-list-commands/08-03-SUMMARY.md`
</output>
