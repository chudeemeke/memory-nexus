# Phase 08 Plan 04: Final Gap Closure - Message Count in Sync

**One-liner:** Pass messageCount to Session.create() during sync extraction

## Context

08-03 added `messageCount` property to Session entity and updated rowToSession() to read it from the database. However, SyncService.extractSession() doesn't pass messageCount when creating sessions during sync, so all sessions are stored with message_count = 0.

## Gap

- **Test 6:** List command shows accurate message count per session
- **Root cause:** Session.create() call in sync-service.ts missing messageCount parameter
- **Severity:** Major

## Tasks

### Task 1: Add messageCount to Session.create() in extractSession

**File:** `src/application/services/sync-service.ts`

**Change:** Line 279-284, add `messageCount: messages.length` to Session.create()

```typescript
// Before
const sessionEntity = Session.create({
  id: session.id,
  projectPath: session.projectPath,
  startTime: firstTimestamp ?? new Date(),
  endTime: lastTimestamp,
});

// After
const sessionEntity = Session.create({
  id: session.id,
  projectPath: session.projectPath,
  startTime: firstTimestamp ?? new Date(),
  endTime: lastTimestamp,
  messageCount: messages.length,
});
```

**Test:** Existing sync-service tests should still pass. No new test needed - the messageCount parameter is already tested at the Session entity level.

### Task 2: Add sync-service test for messageCount population

**File:** `src/application/services/sync-service.test.ts`

Add a test that verifies synced sessions have correct messageCount stored in the database.

## Verification

1. Run `bun test src/application/services/sync-service.test.ts` - all tests pass
2. Run `bun run src/presentation/cli/index.ts sync --force --project nexus` - re-sync a project
3. Run `bun run src/presentation/cli/index.ts list --project nexus --limit 5` - verify message counts > 0

## Success Criteria

- [ ] Session.create() includes messageCount in sync-service.ts
- [ ] Sync-service test verifies messageCount is populated
- [ ] Re-synced sessions show correct message counts in list command
