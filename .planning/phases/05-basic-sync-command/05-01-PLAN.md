# Phase 5 Plan 01: ExtractionState File Metadata Extension

```yaml
wave: 1
depends_on: []
files_modified:
  - src/domain/entities/extraction-state.ts
  - src/domain/entities/extraction-state.test.ts
  - src/infrastructure/database/repositories/extraction-state-repository.ts
  - src/infrastructure/database/repositories/extraction-state-repository.test.ts
autonomous: true
must_haves:
  truths:
    - ExtractionState entity has fileMtime and fileSize properties
    - Repository saves and retrieves file metadata
    - Incremental sync detection compares mtime and size
  artifacts:
    - Updated ExtractionState entity with file metadata
    - Updated repository with metadata persistence
    - Tests verifying metadata round-trip
  key_links:
    - 05-RESEARCH.md Pattern 3 (Incremental Sync Detection)
    - ROADMAP.md SYNC-02 (Incremental sync)
```

## Objective

Extend ExtractionState entity and repository to track file modification time and size, enabling incremental sync detection in subsequent plans.

## Execution Context

**Phase:** 05 - Basic Sync Command
**Wave:** 1 (No dependencies)
**Parallelizable with:** Nothing (foundation task)

## Context References

- @.planning/phases/05-basic-sync-command/05-RESEARCH.md - Pattern 3: Incremental Sync Detection
- @src/domain/entities/extraction-state.ts - Current entity (lacks fileMtime/fileSize)
- @src/infrastructure/database/repositories/extraction-state-repository.ts - Current repository (sets columns to NULL)
- @src/infrastructure/database/schema.ts - Schema has file_mtime and file_size columns

## Existing Infrastructure

The schema already has the columns:
```sql
file_mtime INTEGER,  -- Unix timestamp (seconds)
file_size INTEGER,   -- File size in bytes
```

The repository currently saves NULL for these values. This plan adds the properties to the entity and updates the repository to persist them.

## Tasks

<task id="1">
<title>Add file metadata properties to ExtractionState entity</title>
<files>
- src/domain/entities/extraction-state.ts
- src/domain/entities/extraction-state.test.ts
</files>
<action>
1. Add optional properties to ExtractionStateParams interface:
   ```typescript
   fileMtime?: Date | undefined;
   fileSize?: number | undefined;
   ```

2. Add private readonly fields and getters to ExtractionState class:
   ```typescript
   private readonly _fileMtime?: Date | undefined;
   private readonly _fileSize?: number | undefined;

   get fileMtime(): Date | undefined { ... }
   get fileSize(): number | undefined { ... }
   ```

3. Add validation in create():
   - fileSize must be non-negative if provided
   - fileMtime should be defensive copied like other dates

4. Update all state transition methods (startProcessing, complete, fail, incrementMessages) to preserve file metadata

5. Add withFileMetadata() method for setting metadata:
   ```typescript
   withFileMetadata(mtime: Date, size: number): ExtractionState
   ```

6. Write unit tests:
   - Can create with file metadata
   - File metadata is preserved across state transitions
   - withFileMetadata returns new instance with metadata
   - Negative fileSize throws error
</action>
<verify>
```bash
bun test src/domain/entities/extraction-state.test.ts
```
All tests pass including new file metadata tests.
</verify>
<done>
ExtractionState entity has fileMtime, fileSize properties and withFileMetadata() method. All state transitions preserve metadata.
</done>
</task>

<task id="2">
<title>Update ExtractionStateRepository to persist file metadata</title>
<files>
- src/infrastructure/database/repositories/extraction-state-repository.ts
- src/infrastructure/database/repositories/extraction-state-repository.test.ts
</files>
<action>
1. Update prepared INSERT statement to include file_mtime and file_size:
   ```typescript
   INSERT OR REPLACE INTO extraction_state (
     id, session_path, started_at, status, completed_at,
     messages_extracted, error_message, file_mtime, file_size
   ) VALUES (
     $id, $sessionPath, $startedAt, $status, $completedAt,
     $messagesExtracted, $errorMessage, $fileMtime, $fileSize
   )
   ```

2. Update rowToEntity() to reconstruct fileMtime and fileSize:
   ```typescript
   fileMtime: row.file_mtime ? new Date(row.file_mtime * 1000) : undefined,
   fileSize: row.file_size ?? undefined,
   ```

3. Update save() to extract and convert metadata:
   ```typescript
   $fileMtime: state.fileMtime ? Math.floor(state.fileMtime.getTime() / 1000) : null,
   $fileSize: state.fileSize ?? null,
   ```

4. Write unit tests:
   - Save state with file metadata, retrieve and verify values match
   - File metadata survives round-trip (save then find)
   - Null metadata is handled correctly (optional fields)
   - findBySessionPath returns state with file metadata
</action>
<verify>
```bash
bun test src/infrastructure/database/repositories/extraction-state-repository.test.ts
```
All tests pass including new file metadata persistence tests.
</verify>
<done>
Repository persists and retrieves file metadata. Round-trip test confirms no data loss.
</done>
</task>

<task id="3">
<title>Run full test suite and verify no regressions</title>
<files>
- All test files
</files>
<action>
1. Run full test suite:
   ```bash
   bun test
   ```

2. Verify test count is higher than before (was 591)

3. Check that no existing tests fail

4. Verify file metadata flows through entire stack:
   - Create ExtractionState with metadata
   - Save via repository
   - Retrieve via findBySessionPath
   - Confirm fileMtime and fileSize match original
</action>
<verify>
```bash
bun test
```
All tests pass. Test count increased from 591.
</verify>
<done>
All tests pass. ExtractionState now supports file metadata for incremental sync detection.
</done>
</task>

## Verification

```bash
# All tests pass
bun test

# New metadata tests exist and pass
bun test --grep "file metadata"
bun test --grep "fileMtime"
bun test --grep "fileSize"
```

## Success Criteria

- [ ] ExtractionState entity has fileMtime and fileSize optional properties
- [ ] withFileMetadata() method creates new instance with metadata
- [ ] All state transitions preserve file metadata
- [ ] Repository saves fileMtime as Unix timestamp (seconds)
- [ ] Repository saves fileSize as integer
- [ ] Round-trip test confirms metadata integrity
- [ ] All 591+ tests pass
