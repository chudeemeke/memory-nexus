# Phase 5 Plan 04: Integration Tests and Final Verification

```yaml
wave: 4
depends_on:
  - 05-03
files_modified:
  - src/application/services/sync-service.integration.test.ts
  - src/presentation/cli/commands/sync.integration.test.ts
autonomous: true
must_haves:
  truths:
    - Full sync pipeline works end-to-end with real JSONL files
    - Incremental sync behavior verified (skip unchanged, process changed)
    - CLI command executes successfully against test data
    - WAL checkpoint occurs after bulk operations
  artifacts:
    - Integration tests with real file I/O
    - End-to-end CLI smoke tests
  key_links:
    - ROADMAP.md Phase 5 Success Criteria
    - 04-CONTEXT.md Integration testing patterns
```

## Objective

Create integration tests that verify the complete sync pipeline works end-to-end, from session discovery to database persistence, with real file I/O.

## Execution Context

**Phase:** 05 - Basic Sync Command
**Wave:** 4 (Depends on 05-03 CLI completion)
**Parallelizable with:** Nothing in wave 4

## Context References

- @.planning/ROADMAP.md - Phase 5 Success Criteria
- @src/infrastructure/database/integration.test.ts - Existing integration test patterns
- @src/infrastructure/parsers/integration.test.ts - Parser integration tests

## Phase 5 Success Criteria (from ROADMAP)

1. User can run `aidev memory sync` and all sessions are extracted to database
2. Running sync twice skips unchanged sessions (incremental behavior verified)
3. Progress indicator shows extraction progress during sync
4. `--force` option re-extracts all sessions regardless of state
5. `--project` option syncs only sessions from specified project

## Tasks

<task id="1">
<title>Create SyncService integration tests</title>
<files>
- src/application/services/sync-service.integration.test.ts
</files>
<action>
1. Create integration test file with real file fixtures:
   ```typescript
   import { describe, test, expect, beforeEach, afterEach } from "bun:test";
   import { mkdirSync, writeFileSync, rmSync } from "node:fs";
   import { join } from "node:path";
   import { tmpdir } from "node:os";
   import { SyncService } from "./sync-service.js";
   import { initializeDatabase, closeDatabase, bulkOperationCheckpoint } from "../../infrastructure/database/index.js";
   import { FileSystemSessionSource } from "../../infrastructure/sources/index.js";
   import { JsonlEventParser } from "../../infrastructure/parsers/index.js";
   import { SqliteSessionRepository, SqliteMessageRepository, SqliteToolUseRepository, SqliteExtractionStateRepository } from "../../infrastructure/database/repositories/index.js";

   describe("SyncService Integration", () => {
     let tempDir: string;
     let db: Database;

     beforeEach(() => {
       tempDir = join(tmpdir(), `sync-test-${Date.now()}`);
       mkdirSync(tempDir, { recursive: true });

       const { db: database } = initializeDatabase({ path: ":memory:" });
       db = database;
     });

     afterEach(() => {
       closeDatabase(db);
       rmSync(tempDir, { recursive: true, force: true });
     });

     // Test helpers
     function createTestSession(projectDir: string, sessionId: string, events: object[]): string {
       const encodedPath = encodeProjectPath(projectDir);
       const sessionDir = join(tempDir, encodedPath, sessionId);
       mkdirSync(sessionDir, { recursive: true });

       const jsonlPath = join(sessionDir, "session.jsonl");
       const content = events.map(e => JSON.stringify(e)).join("\n");
       writeFileSync(jsonlPath, content);

       return jsonlPath;
     }

     test("syncs sessions from filesystem to database", async () => {
       // Create test session
       createTestSession("/test/project", "session-1", [
         { type: "user", message: { role: "user", content: "Hello" }, timestamp: "2024-01-01T10:00:00Z" },
         { type: "assistant", message: { role: "assistant", content: "Hi!" }, timestamp: "2024-01-01T10:00:01Z" },
       ]);

       // Create sync service with tempDir as root
       const sessionSource = new FileSystemSessionSource(tempDir);
       const syncService = createSyncService(db, sessionSource);

       const result = await syncService.sync();

       expect(result.sessionsProcessed).toBe(1);
       expect(result.messagesInserted).toBeGreaterThan(0);
     });

     test("incremental sync skips unchanged sessions", async () => {
       createTestSession("/test/project", "session-1", [
         { type: "user", message: { role: "user", content: "Hello" }, timestamp: "2024-01-01T10:00:00Z" },
       ]);

       const sessionSource = new FileSystemSessionSource(tempDir);
       const syncService = createSyncService(db, sessionSource);

       // First sync
       const result1 = await syncService.sync();
       expect(result1.sessionsProcessed).toBe(1);

       // Second sync (should skip)
       const result2 = await syncService.sync();
       expect(result2.sessionsProcessed).toBe(0);
       expect(result2.sessionsSkipped).toBe(1);
     });

     test("incremental sync processes changed sessions", async () => {
       const jsonlPath = createTestSession("/test/project", "session-1", [
         { type: "user", message: { role: "user", content: "Hello" }, timestamp: "2024-01-01T10:00:00Z" },
       ]);

       const sessionSource = new FileSystemSessionSource(tempDir);
       const syncService = createSyncService(db, sessionSource);

       // First sync
       await syncService.sync();

       // Modify file (append new event)
       const newEvent = JSON.stringify({ type: "user", message: { role: "user", content: "More" }, timestamp: "2024-01-01T10:01:00Z" });
       appendFileSync(jsonlPath, "\n" + newEvent);

       // Second sync (should process due to size change)
       const result2 = await syncService.sync();
       expect(result2.sessionsProcessed).toBe(1);
       expect(result2.sessionsSkipped).toBe(0);
     });

     test("--force re-extracts all sessions", async () => {
       createTestSession("/test/project", "session-1", [
         { type: "user", message: { role: "user", content: "Hello" }, timestamp: "2024-01-01T10:00:00Z" },
       ]);

       const sessionSource = new FileSystemSessionSource(tempDir);
       const syncService = createSyncService(db, sessionSource);

       // First sync
       await syncService.sync();

       // Force sync (should process again)
       const result2 = await syncService.sync({ force: true });
       expect(result2.sessionsProcessed).toBe(1);
       expect(result2.sessionsSkipped).toBe(0);
     });

     test("--project filters by project path", async () => {
       createTestSession("/test/project-a", "session-1", [
         { type: "user", message: { role: "user", content: "Hello A" }, timestamp: "2024-01-01T10:00:00Z" },
       ]);
       createTestSession("/test/project-b", "session-2", [
         { type: "user", message: { role: "user", content: "Hello B" }, timestamp: "2024-01-01T10:00:00Z" },
       ]);

       const sessionSource = new FileSystemSessionSource(tempDir);
       const syncService = createSyncService(db, sessionSource);

       const result = await syncService.sync({ projectFilter: "project-a" });

       expect(result.sessionsDiscovered).toBe(2);
       expect(result.sessionsProcessed).toBe(1);
     });

     test("progress callback is invoked", async () => {
       createTestSession("/test/project", "session-1", [
         { type: "user", message: { role: "user", content: "Hello" }, timestamp: "2024-01-01T10:00:00Z" },
       ]);

       const sessionSource = new FileSystemSessionSource(tempDir);
       const syncService = createSyncService(db, sessionSource);

       const progressCalls: any[] = [];
       await syncService.sync({
         onProgress: (p) => progressCalls.push(p),
       });

       expect(progressCalls.length).toBeGreaterThan(0);
       expect(progressCalls.some(p => p.phase === 'extracting')).toBe(true);
     });
   });
   ```

2. Add helper function to create sync service with all dependencies
</action>
<verify>
```bash
bun test src/application/services/sync-service.integration.test.ts
```
All integration tests pass.
</verify>
<done>
SyncService integration tests verify full pipeline.
</done>
</task>

<task id="2">
<title>Create CLI sync command smoke tests</title>
<files>
- src/presentation/cli/commands/sync.integration.test.ts
</files>
<action>
1. Create CLI integration tests:
   ```typescript
   import { describe, test, expect, beforeEach, afterEach } from "bun:test";
   import { spawn } from "bun";
   import { mkdirSync, writeFileSync, rmSync } from "node:fs";
   import { join } from "node:path";
   import { tmpdir } from "node:os";

   describe("CLI sync command", () => {
     let tempDir: string;

     beforeEach(() => {
       tempDir = join(tmpdir(), `cli-test-${Date.now()}`);
       mkdirSync(tempDir, { recursive: true });
     });

     afterEach(() => {
       rmSync(tempDir, { recursive: true, force: true });
     });

     test("--help shows all options", async () => {
       const proc = spawn({
         cmd: ["bun", "run", "src/presentation/cli/index.ts", "sync", "--help"],
         stdout: "pipe",
         stderr: "pipe",
       });

       const output = await new Response(proc.stdout).text();
       await proc.exited;

       expect(output).toContain("--force");
       expect(output).toContain("--project");
       expect(output).toContain("--session");
       expect(output).toContain("--quiet");
       expect(output).toContain("--verbose");
     });

     test("sync executes without error (quiet mode)", async () => {
       const proc = spawn({
         cmd: ["bun", "run", "src/presentation/cli/index.ts", "sync", "--quiet"],
         stdout: "pipe",
         stderr: "pipe",
         env: {
           ...process.env,
           MEMORY_NEXUS_DB_PATH: join(tempDir, "test.db"),
           CLAUDE_PROJECTS_PATH: tempDir,
         },
       });

       const exitCode = await proc.exited;

       // Should exit 0 even with no sessions
       expect(exitCode).toBe(0);
     });

     test("sync shows progress in verbose mode", async () => {
       const proc = spawn({
         cmd: ["bun", "run", "src/presentation/cli/index.ts", "sync", "--verbose"],
         stdout: "pipe",
         stderr: "pipe",
         env: {
           ...process.env,
           MEMORY_NEXUS_DB_PATH: join(tempDir, "test.db"),
           CLAUDE_PROJECTS_PATH: tempDir,
         },
       });

       const output = await new Response(proc.stdout).text();
       await proc.exited;

       // Should show some output
       expect(output.length).toBeGreaterThan(0);
     });
   });
   ```
</action>
<verify>
```bash
bun test src/presentation/cli/commands/sync.integration.test.ts
```
CLI smoke tests pass.
</verify>
<done>
CLI integration tests verify command execution.
</done>
</task>

<task id="3">
<title>Run full test suite and verify success criteria</title>
<files>
- All test files
</files>
<action>
1. Run full test suite:
   ```bash
   bun test
   ```

2. Verify test count increased from 591

3. Check test coverage:
   ```bash
   bun test --coverage
   ```

4. Verify Phase 5 success criteria:
   - [ ] Manual sync command works
   - [ ] Incremental sync skips unchanged (integration test)
   - [ ] Progress indicator works (unit test)
   - [ ] --force re-extracts all (integration test)
   - [ ] --project filters (integration test)

5. Manual verification (optional):
   ```bash
   # Test against real ~/.claude/projects/ if available
   bun run src/presentation/cli/index.ts sync --verbose
   ```
</action>
<verify>
```bash
bun test
bun test --coverage
```
All tests pass. Coverage at 95%+.
</verify>
<done>
Phase 5 complete. All success criteria verified.
</done>
</task>

## Verification

```bash
# All tests pass
bun test

# Integration tests specifically
bun test --grep "Integration"

# Coverage check
bun test --coverage
```

## Success Criteria

- [ ] Integration tests cover full sync pipeline
- [ ] Incremental sync behavior verified end-to-end
- [ ] CLI command executes without error
- [ ] --help shows all options
- [ ] Test count increased from 591
- [ ] Coverage maintained at 95%+
- [ ] All ROADMAP Phase 5 success criteria met
