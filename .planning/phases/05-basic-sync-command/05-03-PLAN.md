# Phase 5 Plan 03: CLI Sync Command with Progress

```yaml
wave: 3
depends_on:
  - 05-02
files_modified:
  - src/presentation/cli/commands/sync.ts
  - src/presentation/cli/commands/sync.test.ts
  - src/presentation/cli/commands/index.ts
  - src/presentation/cli/index.ts
  - package.json
autonomous: true
must_haves:
  truths:
    - CLI sync command invokes SyncService with parsed options
    - Progress bar displays in TTY mode, plain output in non-TTY
    - All options work: --force, --project, --session, --quiet, --verbose
    - Exit codes: 0 success, 1 on errors
  artifacts:
    - sync.ts command handler
    - Progress reporter with TTY detection
    - Updated CLI entry point
  key_links:
    - 05-RESEARCH.md Pattern 2 (CLI Command Thin Wrapper)
    - 05-RESEARCH.md Pitfall 1 (Progress Bar in Non-TTY)
    - ROADMAP.md SYNC-01 through SYNC-08
```

## Objective

Implement the CLI sync command as a thin wrapper around SyncService, with progress reporting that adapts to TTY/non-TTY environments.

## Execution Context

**Phase:** 05 - Basic Sync Command
**Wave:** 3 (Depends on 05-02 SyncService)
**Parallelizable with:** Nothing in wave 3

## Context References

- @.planning/phases/05-basic-sync-command/05-RESEARCH.md - Patterns 2, Pitfall 1
- @src/presentation/cli/index.ts - Current CLI entry point (placeholder sync command)
- @src/application/services/sync-service.ts - SyncService to invoke

## Design

**Requirements from ROADMAP:**
- SYNC-01: Manual sync command: `aidev memory sync`
- SYNC-03: Sync progress indicator during extraction
- SYNC-04: Force re-sync option: `--force`
- SYNC-05: Project-specific sync option: `--project <name>`
- SYNC-06: Session-specific sync option: `--session <id>`
- SYNC-07: Quiet mode for hooks: `--quiet`
- SYNC-08: Verbose mode for debugging: `--verbose`

**Progress Reporter Pattern:**
```typescript
interface ProgressReporter {
  start(total: number): void;
  update(current: number, sessionId: string): void;
  stop(): void;
  log(message: string): void;  // For verbose mode
}
```

## Tasks

<task id="1">
<title>Install cli-progress dependency</title>
<files>
- package.json
- bun.lock
</files>
<action>
1. Add cli-progress and types:
   ```bash
   bun add cli-progress
   bun add -d @types/cli-progress
   ```

2. Verify installation:
   ```bash
   bun run -e "import cliProgress from 'cli-progress'; console.log('ok')"
   ```
</action>
<verify>
```bash
grep "cli-progress" package.json
```
cli-progress is in dependencies.
</verify>
<done>
cli-progress installed and types available.
</done>
</task>

<task id="2">
<title>Create ProgressReporter with TTY detection</title>
<files>
- src/presentation/cli/progress-reporter.ts
- src/presentation/cli/progress-reporter.test.ts
</files>
<action>
1. Create ProgressReporter interface and implementations:
   ```typescript
   import cliProgress from "cli-progress";

   export interface ProgressReporter {
     start(total: number): void;
     update(current: number, sessionId: string): void;
     stop(): void;
     log(message: string): void;
   }

   export class TtyProgressReporter implements ProgressReporter {
     private bar: cliProgress.SingleBar;
     private verbose: boolean;

     constructor(verbose: boolean = false) {
       this.verbose = verbose;
       this.bar = new cliProgress.SingleBar({
         format: "Syncing |{bar}| {percentage}% | {value}/{total} sessions",
         barCompleteChar: "\u2588",
         barIncompleteChar: "\u2591",
         hideCursor: true,
       });
     }

     start(total: number): void {
       this.bar.start(total, 0);
     }

     update(current: number, sessionId: string): void {
       this.bar.update(current);
       if (this.verbose) {
         // Stop bar, log, restart (cli-progress pattern)
         this.bar.stop();
         console.log(`  Processing: ${sessionId}`);
         this.bar.start(this.bar.getTotal(), current);
       }
     }

     stop(): void {
       this.bar.stop();
     }

     log(message: string): void {
       if (this.verbose) {
         this.bar.stop();
         console.log(message);
         this.bar.start(this.bar.getTotal(), this.bar.value);
       }
     }
   }

   export class PlainProgressReporter implements ProgressReporter {
     private verbose: boolean;

     constructor(verbose: boolean = false) {
       this.verbose = verbose;
     }

     start(total: number): void {
       console.log(`Processing ${total} sessions...`);
     }

     update(current: number, sessionId: string): void {
       if (this.verbose) {
         console.log(`  [${current}] Processing: ${sessionId}`);
       }
     }

     stop(): void {
       console.log("Done.");
     }

     log(message: string): void {
       if (this.verbose) {
         console.log(message);
       }
     }
   }

   export class QuietProgressReporter implements ProgressReporter {
     start(_total: number): void {}
     update(_current: number, _sessionId: string): void {}
     stop(): void {}
     log(_message: string): void {}
   }

   export function createProgressReporter(options: {
     quiet?: boolean;
     verbose?: boolean;
   }): ProgressReporter {
     if (options.quiet) {
       return new QuietProgressReporter();
     }

     if (!process.stdout.isTTY) {
       return new PlainProgressReporter(options.verbose);
     }

     return new TtyProgressReporter(options.verbose);
   }
   ```

2. Write tests:
   - createProgressReporter returns QuietProgressReporter when quiet=true
   - createProgressReporter returns PlainProgressReporter when not TTY
   - createProgressReporter returns TtyProgressReporter when TTY
   - TtyProgressReporter.start/update/stop work without error
   - PlainProgressReporter logs to console
   - QuietProgressReporter does nothing
</action>
<verify>
```bash
bun test src/presentation/cli/progress-reporter.test.ts
```
All progress reporter tests pass.
</verify>
<done>
ProgressReporter implementations handle TTY/non-TTY/quiet modes.
</done>
</task>

<task id="3">
<title>Implement sync command handler</title>
<files>
- src/presentation/cli/commands/sync.ts
- src/presentation/cli/commands/sync.test.ts
- src/presentation/cli/commands/index.ts
</files>
<action>
1. Create src/presentation/cli/commands/ directory if needed

2. Create sync command handler:
   ```typescript
   import { Command } from "commander";
   import { SyncService, type SyncOptions } from "../../../application/services/index.js";
   import { createProgressReporter } from "../progress-reporter.js";
   import { initializeDatabase, closeDatabase, bulkOperationCheckpoint } from "../../../infrastructure/database/index.js";
   import { FileSystemSessionSource } from "../../../infrastructure/sources/index.js";
   import { JsonlEventParser } from "../../../infrastructure/parsers/index.js";
   import { SqliteSessionRepository, SqliteMessageRepository, SqliteToolUseRepository, SqliteExtractionStateRepository } from "../../../infrastructure/database/repositories/index.js";

   interface SyncCommandOptions {
     force?: boolean;
     project?: string;
     session?: string;
     quiet?: boolean;
     verbose?: boolean;
   }

   export function createSyncCommand(): Command {
     return new Command("sync")
       .description("Sync sessions from ~/.claude/projects/ to database")
       .option("-f, --force", "Re-extract all sessions regardless of state")
       .option("-p, --project <path>", "Sync only sessions from specific project")
       .option("-s, --session <id>", "Sync a specific session only")
       .option("-q, --quiet", "Suppress progress output")
       .option("-v, --verbose", "Show detailed progress")
       .action(async (options: SyncCommandOptions) => {
         await executeSyncCommand(options);
       });
   }

   async function executeSyncCommand(options: SyncCommandOptions): Promise<void> {
     const startTime = Date.now();
     const reporter = createProgressReporter(options);

     // Initialize database and dependencies
     const { db } = initializeDatabase({ path: getDefaultDbPath() });

     try {
       // Create dependencies
       const sessionSource = new FileSystemSessionSource();
       const eventParser = new JsonlEventParser();
       const sessionRepo = new SqliteSessionRepository(db);
       const messageRepo = new SqliteMessageRepository(db);
       const toolUseRepo = new SqliteToolUseRepository(db);
       const extractionStateRepo = new SqliteExtractionStateRepository(db);

       const syncService = new SyncService(
         sessionSource,
         eventParser,
         sessionRepo,
         messageRepo,
         toolUseRepo,
         extractionStateRepo,
         db
       );

       // Execute sync
       const result = await syncService.sync({
         force: options.force,
         projectFilter: options.project,
         sessionFilter: options.session,
         onProgress: (progress) => {
           if (progress.phase === 'discovering') {
             reporter.log(`Discovering sessions...`);
           } else if (progress.phase === 'extracting') {
             reporter.update(progress.current, progress.sessionId);
           }
         },
       });

       // Checkpoint WAL after bulk operations
       bulkOperationCheckpoint(db);

       reporter.stop();

       // Report results
       if (!options.quiet) {
         console.log(`\nSync complete in ${Date.now() - startTime}ms`);
         console.log(`  Discovered: ${result.sessionsDiscovered}`);
         console.log(`  Processed:  ${result.sessionsProcessed}`);
         console.log(`  Skipped:    ${result.sessionsSkipped}`);
         console.log(`  Messages:   ${result.messagesInserted}`);
         console.log(`  Tool uses:  ${result.toolUsesInserted}`);

         if (result.errors.length > 0) {
           console.log(`\nErrors (${result.errors.length}):`);
           for (const err of result.errors) {
             console.log(`  ${err.sessionPath}: ${err.error}`);
           }
         }
       }

       // Exit with error code if there were failures
       if (result.errors.length > 0) {
         process.exitCode = 1;
       }
     } finally {
       closeDatabase(db);
     }
   }

   export { executeSyncCommand };
   ```

3. Create commands barrel export:
   ```typescript
   // src/presentation/cli/commands/index.ts
   export { createSyncCommand } from "./sync.js";
   ```

4. Write tests (mock SyncService for unit tests):
   - Test --force sets force option
   - Test --project sets projectFilter option
   - Test --session sets sessionFilter option
   - Test --quiet suppresses output
   - Test --verbose enables verbose logging
   - Test exit code 1 when errors occur
</action>
<verify>
```bash
bun test src/presentation/cli/commands/sync.test.ts
```
Sync command tests pass.
</verify>
<done>
Sync command handler parses options and invokes SyncService.
</done>
</task>

<task id="4">
<title>Update CLI entry point to use sync command</title>
<files>
- src/presentation/cli/index.ts
</files>
<action>
1. Update index.ts to use the new sync command:
   ```typescript
   import { Command } from "commander";
   import { createSyncCommand } from "./commands/index.js";

   const program = new Command();

   program
     .name("memory")
     .description("Cross-project context persistence for Claude Code sessions")
     .version("0.1.0");

   // Add sync command from module
   program.addCommand(createSyncCommand());

   // Keep other placeholder commands for now
   program
     .command("search <query>")
     ...
   ```

2. Remove the old placeholder sync command

3. Run CLI to verify:
   ```bash
   bun run src/presentation/cli/index.ts sync --help
   ```
</action>
<verify>
```bash
bun run src/presentation/cli/index.ts sync --help
```
Shows help with all options: --force, --project, --session, --quiet, --verbose
</verify>
<done>
CLI entry point uses new sync command module.
</done>
</task>

<task id="5">
<title>Run full test suite</title>
<files>
- All test files
</files>
<action>
1. Run full test suite:
   ```bash
   bun test
   ```

2. Verify test count increased

3. Manual smoke test:
   ```bash
   # Should work (even if no sessions exist)
   bun run src/presentation/cli/index.ts sync --quiet

   # Should show help
   bun run src/presentation/cli/index.ts sync --help
   ```
</action>
<verify>
```bash
bun test
```
All tests pass.
</verify>
<done>
CLI sync command complete with all options and progress reporting.
</done>
</task>

## Verification

```bash
# All CLI tests pass
bun test src/presentation/

# Full test suite passes
bun test

# CLI help shows all options
bun run src/presentation/cli/index.ts sync --help
```

## Success Criteria

- [ ] cli-progress dependency installed
- [ ] ProgressReporter adapts to TTY/non-TTY/quiet
- [ ] Sync command has all options: --force, --project, --session, --quiet, --verbose
- [ ] Progress bar displays in TTY mode
- [ ] Plain output in non-TTY mode
- [ ] Quiet mode suppresses all output
- [ ] Verbose mode shows per-session details
- [ ] Exit code 0 on success, 1 on errors
- [ ] Results summary printed after sync
