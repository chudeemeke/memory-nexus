---
phase: 07-filtering-and-output-formatting
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-03"]
files_modified:
  - src/presentation/cli/commands/search.ts
  - src/presentation/cli/commands/search.test.ts
  - src/presentation/cli/commands/sync.ts
  - src/presentation/cli/commands/sync.test.ts
autonomous: true

must_haves:
  truths:
    - "Search command uses OutputFormatter for consistent output"
    - "--verbose and --quiet are mutually exclusive"
    - "Exit codes are consistent: 0=success, 1=user error, 2=runtime error"
    - "No results shows suggestion with similar project names"
    - "Summary line shows 'Found N results (showing M)'"
  artifacts:
    - path: "src/presentation/cli/commands/search.ts"
      provides: "Search command with verbose/quiet modes"
      exports: ["createSearchCommand", "executeSearchCommand"]
    - path: "src/presentation/cli/commands/sync.ts"
      provides: "Sync command with verbose/quiet modes"
      exports: ["createSyncCommand", "executeSyncCommand"]
  key_links:
    - from: "src/presentation/cli/commands/search.ts"
      to: "src/presentation/cli/formatters/output-formatter.ts"
      via: "createOutputFormatter for result formatting"
      pattern: "createOutputFormatter"
    - from: "src/presentation/cli/commands/search.ts"
      to: "src/presentation/cli/formatters/timestamp-formatter.ts"
      via: "formatTimestamp for result display"
      pattern: "formatTimestamp"
---

<objective>
Apply output formatting infrastructure to search and sync commands.

Purpose: Integrate the output formatter with actual commands, add verbose/quiet modes, implement consistent exit codes, and add "no results" suggestions. This completes the Phase 7 output formatting requirements.

Output: Search and sync commands with --verbose, --quiet, consistent formatting, and proper exit codes.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-filtering-and-output-formatting/07-CONTEXT.md
@.planning/phases/07-filtering-and-output-formatting/07-RESEARCH.md
@.planning/phases/07-filtering-and-output-formatting/07-01-SUMMARY.md
@.planning/phases/07-filtering-and-output-formatting/07-03-SUMMARY.md

@src/presentation/cli/commands/search.ts (current implementation)
@src/presentation/cli/commands/sync.ts (current implementation)
@src/presentation/cli/formatters/output-formatter.ts (from 07-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verbose/quiet modes to search command</name>
  <files>
    src/presentation/cli/commands/search.ts
    src/presentation/cli/commands/search.test.ts
  </files>
  <action>
1. Import new formatter dependencies:
   ```typescript
   import { Option } from "commander";
   import { createOutputFormatter, type FormatOptions, type OutputMode } from "../formatters/output-formatter.js";
   import { formatTimestamp } from "../formatters/timestamp-formatter.js";
   import { shouldUseColor } from "../formatters/color.js";
   ```

2. Update SearchCommandOptions interface:
   ```typescript
   interface SearchCommandOptions {
     // ... existing options
     verbose?: boolean;
     quiet?: boolean;
   }
   ```

3. Add options with conflicts in createSearchCommand():
   ```typescript
   .addOption(
     new Option("-v, --verbose", "Show detailed output with execution info")
       .conflicts("quiet")
   )
   .addOption(
     new Option("-q, --quiet", "Suppress headers and decorations")
       .conflicts("verbose")
   )
   ```

4. Update executeSearchCommand() to use OutputFormatter:
   ```typescript
   // Determine output mode
   let outputMode: OutputMode = "default";
   if (options.json) outputMode = "json";
   else if (options.verbose) outputMode = "verbose";
   else if (options.quiet) outputMode = "quiet";

   const formatter = createOutputFormatter(outputMode, shouldUseColor());
   ```

5. Replace inline formatting with formatter calls:
   - Remove outputJson() and outputFormatted() functions
   - Use formatter.formatResults(results, formatOptions)
   - Use formatter.formatError() for error output
   - Print to stdout/stderr appropriately

6. Implement "no results" suggestion:
   ```typescript
   if (results.length === 0) {
     // Query for similar project names if --project was specified
     if (options.project) {
       const suggestions = await getSimilarProjects(options.project, sessionRepo);
       if (suggestions.length > 0) {
         console.log(`No results. Did you mean: ${suggestions.join(", ")}?`);
       } else {
         console.log(`No results found for: ${query}`);
       }
     } else {
       console.log(`No results found for: ${query}`);
     }
     return;
   }
   ```

7. Update timestamp display to use formatTimestamp():
   - Replace current formatTimestamp() function with imported one
   - Shows "2 days ago (2026-01-27 14:30)" format

8. Add summary line at end of results:
   ```typescript
   // After results output
   const summary = formatter.formatSummary({
     found: totalResults,
     shown: results.length,
     truncated: isTruncated
   });
   if (summary) console.log(summary);
   ```

9. Add tests:
   - --verbose shows execution details
   - --quiet has no headers
   - --verbose --quiet shows conflict error
   - "No results" shows suggestion when project specified
   - Summary line present in default output
  </action>
  <verify>
Run `bun test src/presentation/cli/commands/search.test.ts` - all tests pass
  </verify>
  <done>
Search command uses OutputFormatter. Verbose/quiet modes work. Summary line present. No results shows suggestions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add verbose/quiet modes to sync command</name>
  <files>
    src/presentation/cli/commands/sync.ts
    src/presentation/cli/commands/sync.test.ts
  </files>
  <action>
1. Import formatter dependencies:
   ```typescript
   import { Option } from "commander";
   import { createOutputFormatter, type OutputMode } from "../formatters/output-formatter.js";
   import { shouldUseColor } from "../formatters/color.js";
   ```

2. The sync command already has --quiet and --verbose options. Update to use Commander.js conflicts:
   ```typescript
   .addOption(
     new Option("-v, --verbose", "Verbose output with details")
       .conflicts("quiet")
   )
   .addOption(
     new Option("-q, --quiet", "Suppress all output")
       .conflicts("verbose")
   )
   ```

3. Update executeSyncCommand() to respect output modes more consistently:
   - Quiet mode: suppress progress bar AND summary output
   - Verbose mode: show additional sync details (session paths, file sizes)

4. Standardize summary line format:
   - "Synced 5 sessions (3 new, 2 updated)"
   - "Synced 0 sessions (all up to date)"

5. Ensure exit codes are consistent:
   - 0: Success (even if nothing to sync)
   - 1: User error (invalid --project name, bad arguments)
   - 2: Runtime error (database, filesystem)

6. Add/update tests:
   - --verbose --quiet shows conflict error
   - Exit code 0 on success
   - Exit code 1 on bad arguments
   - Exit code 2 on database error
  </action>
  <verify>
Run `bun test src/presentation/cli/commands/sync.test.ts` - all tests pass
  </verify>
  <done>
Sync command uses consistent output modes. Exit codes standardized. Summary format matches pattern.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify cross-command consistency and run full test suite</name>
  <files>
    src/presentation/cli/commands/search.test.ts
    src/presentation/cli/commands/sync.test.ts
  </files>
  <action>
1. Verify consistent patterns across commands:
   - Short flags: -q (quiet), -v (verbose), -l (limit), -p (project), -s (session), -j (json alias for --json)
   - Error format: "Error: <message>" to stderr
   - Exit codes: 0=success, 1=user error, 2=runtime error

2. Add -j short flag for --json in search command (if not already present)

3. Run full test suite: `bun test`
   - All existing tests should pass
   - New tests for verbose/quiet modes should pass
   - Phase 7 should add ~30-40 new tests

4. Manual verification (document in summary):
   - `memory search "query" --verbose` shows execution details
   - `memory search "query" --quiet` outputs results only
   - `memory search "query" --json` outputs valid JSON
   - `memory search "query" --project nonexistent` shows suggestion
   - `memory sync --verbose` shows session details
   - Piped output has no ANSI codes: `memory search "query" | cat`

5. Update any remaining inline formatting in search.ts to use formatter
  </action>
  <verify>
`bun test` - all tests pass. Manual verification of output modes documented.
  </verify>
  <done>
All commands have consistent patterns. Full test suite passes. Phase 7 complete.
  </done>
</task>

</tasks>

<verification>
Plan 07-04 verification:
1. Search command uses OutputFormatter for all output
2. Sync command uses consistent output patterns
3. --verbose and --quiet conflict properly
4. Exit codes: 0=success, 1=user error, 2=runtime error
5. Summary lines present in default output
6. "No results" shows project suggestions
7. TTY detection works (no ANSI when piped)
8. All tests pass
</verification>

<success_criteria>
- OutputFormatter integrated with search command
- Verbose mode shows execution details
- Quiet mode suitable for piping
- --verbose and --quiet are mutually exclusive
- Exit codes consistent across commands
- Summary line format: "Found N results (showing M)"
- "No results" shows project suggestions
- Piped output has no ANSI color codes
- All tests pass including new mode tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-filtering-and-output-formatting/07-04-SUMMARY.md`
</output>
