---
phase: 07-filtering-and-output-formatting
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/domain/ports/services.ts
  - src/infrastructure/database/services/search-service.ts
  - src/infrastructure/database/services/search-service.test.ts
  - src/presentation/cli/commands/search.ts
  - src/presentation/cli/commands/search.test.ts
autonomous: true

must_haves:
  truths:
    - "User can filter search results by project name with --project"
    - "User can filter search results by time range with --since, --before, or --days"
    - "User can filter search results by role with --role"
    - "--since/--before and --days are mutually exclusive (error if both specified)"
    - "--days 7 includes today plus past 6 days"
  artifacts:
    - path: "src/domain/ports/services.ts"
      provides: "Extended SearchOptions with session filter"
      exports: ["SearchOptions", "ISearchService"]
    - path: "src/infrastructure/database/services/search-service.ts"
      provides: "Search service with all filters implemented"
      exports: ["Fts5SearchService"]
  key_links:
    - from: "src/presentation/cli/commands/search.ts"
      to: "src/presentation/cli/parsers/date-parser.ts"
      via: "parseDate for CLI option parsing"
      pattern: "parseDate"
    - from: "src/presentation/cli/commands/search.ts"
      to: "commander Option.conflicts()"
      via: "Commander.js conflict declaration"
      pattern: "\\.conflicts\\("
---

<objective>
Add project, time range, role, and session filters to the search command.

Purpose: Enable users to narrow search results to specific projects, time ranges, or message roles. This makes the search command practical for targeted retrieval when the user knows the context they're looking for.

Output: Search command with --project, --since, --before, --days, --role, and --session filter options.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-filtering-and-output-formatting/07-CONTEXT.md
@.planning/phases/07-filtering-and-output-formatting/07-RESEARCH.md
@.planning/phases/07-filtering-and-output-formatting/07-01-SUMMARY.md

@src/presentation/cli/commands/search.ts (current search command)
@src/domain/ports/services.ts (SearchOptions interface)
@src/infrastructure/database/services/search-service.ts (Fts5SearchService)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SearchOptions and update search service</name>
  <files>
    src/domain/ports/services.ts
    src/infrastructure/database/services/search-service.ts
    src/infrastructure/database/services/search-service.test.ts
  </files>
  <action>
1. Update `src/domain/ports/services.ts` - extend SearchOptions:
   - Add `sessionFilter?: string` - filter to specific session ID
   - roleFilter already supports single role; update type to allow array: `roleFilter?: MessageRole | MessageRole[]`
   - sinceDate and beforeDate already exist

2. Update `src/infrastructure/database/services/search-service.ts`:
   - Update buildSearchQuery() to handle sessionFilter:
     - Add WHERE clause: `m.session_id = ?`
   - Update roleFilter handling to support array:
     - If array: use `m.role IN (?, ?, ...)` with params
     - If single: existing `m.role = ?` logic

3. Add tests in search-service.test.ts:
   - Test sessionFilter limits results to specific session
   - Test roleFilter with single value ("user")
   - Test roleFilter with array (["user", "assistant"])
   - Test combined filters (project + role + since)
  </action>
  <verify>
Run `bun test src/infrastructure/database/services/search-service.test.ts` - all tests pass
  </verify>
  <done>
SearchOptions extended with sessionFilter. roleFilter supports array. Fts5SearchService handles all filter combinations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add filter options to search CLI command</name>
  <files>
    src/presentation/cli/commands/search.ts
    src/presentation/cli/commands/search.test.ts
  </files>
  <action>
1. Import dependencies at top of search.ts:
   ```typescript
   import { Option } from "commander";
   import { parseDate, DateParseError } from "../parsers/date-parser.js";
   ```

2. Update SearchCommandOptions interface:
   ```typescript
   interface SearchCommandOptions {
     limit?: string;
     project?: string;
     session?: string;
     role?: string;       // Comma-separated: "user,assistant"
     since?: string;      // Flexible date input
     before?: string;     // Flexible date input
     days?: string;       // Number of days
     json?: boolean;
     ignoreCase?: boolean;
     caseSensitive?: boolean;
   }
   ```

3. Update createSearchCommand() with new options using Commander.js Option class for conflicts:
   ```typescript
   .option("-p, --project <name>", "Filter by project name")
   .option("-s, --session <id>", "Filter by session ID")
   .option("--role <roles>", "Filter by role: user, assistant, or both (comma-separated)")
   .addOption(
     new Option("--since <date>", "Results after date (e.g., 'yesterday', '2 weeks ago')")
       .conflicts(["days"])
   )
   .addOption(
     new Option("--before <date>", "Results before date")
       .conflicts(["days"])
   )
   .addOption(
     new Option("--days <n>", "Results from last N days (includes today)")
       .argParser((val) => {
         const n = parseInt(val, 10);
         if (isNaN(n) || n < 1) throw new Error("Days must be a positive number");
         return n;
       })
       .conflicts(["since", "before"])
   )
   ```

4. Update executeSearchCommand() to build SearchOptions:
   ```typescript
   // Parse role filter
   let roleFilter: MessageRole | MessageRole[] | undefined;
   if (options.role) {
     const roles = options.role.split(",").map(r => r.trim().toLowerCase());
     if (roles.length === 1) {
       roleFilter = roles[0] as MessageRole;
     } else {
       roleFilter = roles as MessageRole[];
     }
   }

   // Parse date filters
   let sinceDate: Date | undefined;
   let beforeDate: Date | undefined;

   if (options.days) {
     // --days N = today + past N-1 days
     const now = new Date();
     const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
     sinceDate = new Date(startOfToday.getTime() - (options.days - 1) * 24 * 60 * 60 * 1000);
   } else {
     if (options.since) {
       try {
         sinceDate = parseDate(options.since);
       } catch (err) {
         if (err instanceof DateParseError) {
           console.error(`Error: ${err.message}`);
           process.exitCode = 1;
           return;
         }
         throw err;
       }
     }
     if (options.before) {
       try {
         beforeDate = parseDate(options.before);
       } catch (err) {
         if (err instanceof DateParseError) {
           console.error(`Error: ${err.message}`);
           process.exitCode = 1;
           return;
         }
         throw err;
       }
     }
   }

   // Build complete SearchOptions
   const searchOptions: SearchOptions = {
     limit: fetchLimit,
     projectFilter: options.project ? ProjectPath.fromDecoded(options.project) : undefined,
     roleFilter,
     sinceDate,
     beforeDate,
     sessionFilter: options.session,
   };
   ```

5. Update search call to pass searchOptions

6. Add tests for new options:
   - --role user filters to user messages only
   - --role user,assistant includes both
   - --days 7 sets correct sinceDate
   - --since "yesterday" parses via parseDate
   - --since with --days shows Commander conflict error
   - Invalid --days shows error and exits with code 1
  </action>
  <verify>
Run `bun test src/presentation/cli/commands/search.test.ts` - all tests pass
  </verify>
  <done>
Search command accepts all filter options. Date parsing uses parseDate(). Commander.js conflicts prevent incompatible options. All filters passed to SearchOptions.
  </done>
</task>

</tasks>

<verification>
Plan 07-02 verification:
1. `memory search "query" --project wow-system` filters to project
2. `memory search "query" --days 7` filters to last 7 days
3. `memory search "query" --since yesterday` filters to yesterday onward
4. `memory search "query" --role assistant` shows only Claude's responses
5. `memory search "query" --days 7 --since yesterday` shows conflict error
6. All tests pass
</verification>

<success_criteria>
- --project filters results to specific project
- --since, --before accept natural language dates via parseDate()
- --days N includes today plus past N-1 days
- --since/--before and --days are mutually exclusive (Commander.js conflict)
- --role accepts single value or comma-separated values
- --session filters to specific session ID
- All filter combinations work (AND logic)
- Error handling for invalid inputs with helpful messages
</success_criteria>

<output>
After completion, create `.planning/phases/07-filtering-and-output-formatting/07-02-SUMMARY.md`
</output>
