---
phase: 07-filtering-and-output-formatting
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/presentation/cli/parsers/date-parser.ts
  - src/presentation/cli/parsers/date-parser.test.ts
  - src/presentation/cli/formatters/timestamp-formatter.ts
  - src/presentation/cli/formatters/timestamp-formatter.test.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can provide natural language dates ('yesterday', '2 weeks ago') as filter values"
    - "Invalid date values fail fast with clear error message and examples"
    - "Timestamps display both relative and absolute formats ('2 days ago (2026-01-27 14:30)')"
  artifacts:
    - path: "src/presentation/cli/parsers/date-parser.ts"
      provides: "Date parsing wrapper with validation"
      exports: ["parseDate", "DateParseError"]
    - path: "src/presentation/cli/formatters/timestamp-formatter.ts"
      provides: "Relative + absolute timestamp formatting"
      exports: ["formatTimestamp", "formatRelativeTime"]
  key_links:
    - from: "src/presentation/cli/parsers/date-parser.ts"
      to: "chrono-node"
      via: "import * as chrono from 'chrono-node'"
      pattern: "chrono\\.parseDate"
    - from: "src/presentation/cli/formatters/timestamp-formatter.ts"
      to: "Intl.RelativeTimeFormat"
      via: "Built-in API"
      pattern: "RelativeTimeFormat"
---

<objective>
Add date parsing infrastructure using chrono-node for natural language dates.

Purpose: Enable flexible date inputs ("yesterday", "2 weeks ago", "2026-01-15") for time-based filters (--since, --before, --days). Also create timestamp formatter for consistent display across all commands.

Output: Date parser wrapper with validation and timestamp formatter with relative+absolute display.
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-filtering-and-output-formatting/07-CONTEXT.md
@.planning/phases/07-filtering-and-output-formatting/07-RESEARCH.md
</context>

<feature>
  <name>Date Parser with chrono-node</name>
  <files>
    src/presentation/cli/parsers/date-parser.ts
    src/presentation/cli/parsers/date-parser.test.ts
  </files>
  <behavior>
TDD approach for date parsing wrapper.

Input -> Expected Output:
- parseDate("yesterday") -> Date for previous day at midnight
- parseDate("2 weeks ago") -> Date 14 days in the past
- parseDate("2026-01-15") -> Date for Jan 15, 2026
- parseDate("last Friday") -> Date of most recent Friday
- parseDate("invalid garbage") -> throws DateParseError with helpful message
- parseDate("") -> throws DateParseError with helpful message
- parseDate("tomorrow") -> throws DateParseError (future dates not allowed for search filters)

Validation rules:
- Result must be a valid Date (not NaN)
- Result must be in the past or today (not future dates)
- Pass explicit reference date to chrono-node for consistent results

Error message format:
"Invalid date format: 'invalid garbage'. Examples: 'yesterday', '2 weeks ago', '2026-01-15'"
  </behavior>
  <implementation>
1. Install chrono-node: `bun add chrono-node`

2. Create DateParseError class extending Error with original input in message

3. Create parseDate(input: string, referenceDate?: Date): Date
   - Use chrono.parseDate(input, referenceDate ?? new Date())
   - Validate result is not null/undefined
   - Validate result is not in future (> referenceDate)
   - Throw DateParseError with helpful message on failure

4. Export from new barrel: src/presentation/cli/parsers/index.ts

Test RED cases first:
- Empty string throws DateParseError
- Unparseable input throws DateParseError
- Future date throws DateParseError
- Error message includes examples

Test GREEN cases:
- "yesterday" parses correctly
- "2 weeks ago" parses correctly
- ISO date "2026-01-15" parses correctly
- "last Friday" parses correctly

REFACTOR: Ensure error messages are consistent and helpful.
  </implementation>
</feature>

<feature>
  <name>Timestamp Formatter</name>
  <files>
    src/presentation/cli/formatters/timestamp-formatter.ts
    src/presentation/cli/formatters/timestamp-formatter.test.ts
  </files>
  <behavior>
TDD approach for timestamp formatting.

Input -> Expected Output:
- formatTimestamp(date 2 days ago) -> "2 days ago (2026-01-27 14:30)"
- formatTimestamp(date 5 hours ago) -> "5 hours ago (2026-01-29 09:00)"
- formatTimestamp(date 3 weeks ago) -> "3 weeks ago (2026-01-08 10:15)"
- formatTimestamp(date just now) -> "just now (2026-01-29 14:25)"
- formatRelativeTime(date 2 days ago) -> "2 days ago"
- formatRelativeTime(date yesterday) -> "yesterday"
  </behavior>
  <implementation>
1. Create formatRelativeTime(date: Date, reference?: Date): string
   - Use Intl.RelativeTimeFormat with { numeric: "auto" } for "yesterday" instead of "1 day ago"
   - Auto-select appropriate unit (minute, hour, day, week, month)
   - Algorithm:
     - < 1 hour: use minutes
     - < 1 day: use hours
     - < 7 days: use days
     - < 30 days: use weeks
     - else: use months

2. Create formatAbsoluteTime(date: Date): string
   - Format as "YYYY-MM-DD HH:mm"
   - Use padStart for consistent width

3. Create formatTimestamp(date: Date, reference?: Date): string
   - Combine: formatRelativeTime(date) + " (" + formatAbsoluteTime(date) + ")"

4. Export from new barrel: src/presentation/cli/formatters/index.ts

Test with fixed reference dates for deterministic results.
  </implementation>
</feature>

<verification>
Plan 07-01 verification:
1. `bun add chrono-node` completes without error
2. `bun test src/presentation/cli/parsers/date-parser.test.ts` - all tests pass
3. `bun test src/presentation/cli/formatters/timestamp-formatter.test.ts` - all tests pass
4. parseDate("yesterday") returns correct Date
5. formatTimestamp shows both relative and absolute
</verification>

<success_criteria>
- chrono-node added to package.json dependencies
- parseDate() handles natural language dates
- DateParseError provides helpful error messages with examples
- formatTimestamp() shows "2 days ago (2026-01-27 14:30)" format
- Intl.RelativeTimeFormat used for relative time
- All tests pass (RED-GREEN-REFACTOR complete)
</success_criteria>

<output>
After completion, create `.planning/phases/07-filtering-and-output-formatting/07-01-SUMMARY.md`
</output>
