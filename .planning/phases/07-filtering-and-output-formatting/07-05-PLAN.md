---
phase: 07-filtering-and-output-formatting
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/ports/services.ts
  - src/infrastructure/database/services/search-service.ts
  - src/infrastructure/database/services/search-service.test.ts
  - src/presentation/cli/commands/search.ts
  - src/presentation/cli/commands/search.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can search with --project wow-system and see only results from that project"
    - "User can search with --project system and see results from any project containing 'system'"
    - "Project filter is case-insensitive substring match"
  artifacts:
    - path: "src/infrastructure/database/services/search-service.ts"
      provides: "Project filter using sessions.project_name LIKE clause"
      contains: "project_name LIKE"
    - path: "src/domain/ports/services.ts"
      provides: "SearchOptions with string projectFilter"
      contains: "projectFilter?: string"
  key_links:
    - from: "src/presentation/cli/commands/search.ts"
      to: "SearchOptions"
      via: "projectFilter as string (not ProjectPath)"
      pattern: "projectFilter: options\\.project"
    - from: "src/infrastructure/database/services/search-service.ts"
      to: "sessions.project_name"
      via: "LIKE query with wildcards"
      pattern: "project_name LIKE"
---

<objective>
Fix project filter to match user-friendly project names instead of encoded paths

Purpose: Users expect `--project wow-system` to filter by project name, but current implementation treats input as a full filesystem path and does exact match on encoded path column.
Output: Working project filter using substring match on project_name column
</objective>

<execution_context>
@~/.claude/get-stuff-done/workflows/execute-plan.md
@~/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-filtering-and-output-formatting/07-UAT.md

@src/domain/ports/services.ts
@src/infrastructure/database/services/search-service.ts
@src/presentation/cli/commands/search.ts
@src/infrastructure/database/repositories/session-repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change SearchOptions.projectFilter from ProjectPath to string</name>
  <files>
    - src/domain/ports/services.ts
    - src/infrastructure/database/services/search-service.ts
    - src/infrastructure/database/services/search-service.test.ts
    - src/domain/ports/ports.test.ts
  </files>
  <action>
1. In `src/domain/ports/services.ts`:
   - Change `projectFilter?: ProjectPath` to `projectFilter?: string`
   - Remove the ProjectPath import if no longer needed

2. In `src/infrastructure/database/services/search-service.ts`:
   - Update `buildSearchQuery()` to use project_name LIKE instead of project_path_encoded =
   - Current (broken):
     ```typescript
     if (options?.projectFilter) {
       joinClauses += `JOIN sessions s ON m.session_id = s.id`;
       whereClauses.push("s.project_path_encoded = ?");
       params.push(options.projectFilter.encoded);
     }
     ```
   - Fixed:
     ```typescript
     if (options?.projectFilter) {
       joinClauses += `JOIN sessions s ON m.session_id = s.id`;
       whereClauses.push("LOWER(s.project_name) LIKE LOWER(?)");
       params.push(`%${options.projectFilter}%`);
     }
     ```
   - This matches substring, case-insensitive (like session-repository.ts does for list command)

3. In `src/infrastructure/database/services/search-service.test.ts`:
   - Update existing projectFilter tests to pass string instead of ProjectPath
   - The test at line ~343 and ~362 create `ProjectPath.fromDecoded(...)` - change to plain string
   - Verify the test still passes with the new LIKE behavior

4. In `src/domain/ports/ports.test.ts`:
   - Update any mocks that use ProjectPath for projectFilter to use string
  </action>
  <verify>
    Run `bun test search-service.test.ts` and `bun test ports.test.ts` - all tests pass
  </verify>
  <done>
    SearchOptions uses string for projectFilter, search service uses LIKE clause on project_name
  </done>
</task>

<task type="auto">
  <name>Task 2: Update search command to pass string projectFilter</name>
  <files>
    - src/presentation/cli/commands/search.ts
    - src/presentation/cli/commands/search.test.ts
  </files>
  <action>
1. In `src/presentation/cli/commands/search.ts`:
   - Line 183 currently does: `projectFilter: options.project ? ProjectPath.fromDecoded(options.project) : undefined`
   - Change to simply: `projectFilter: options.project`
   - Remove the ProjectPath import since it's no longer needed for this file

2. In `src/presentation/cli/commands/search.test.ts`:
   - Add integration test that verifies project filter works with substring match
   - Test with partial name like "system" should match projects containing "system"
  </action>
  <verify>
    Run `bun test search.test.ts` - all tests pass including new integration test
  </verify>
  <done>
    Search command passes project name string directly, filter matches substring
  </done>
</task>

</tasks>

<verification>
1. Run `bun test` - all tests pass
2. Manual test (if database has data):
   - `bun run src/presentation/cli/index.ts search test --project system` returns results from wow-system, memory-nexus, etc.
   - `bun run src/presentation/cli/index.ts search test --project nonexistent` returns "No results found"
</verification>

<success_criteria>
- SearchOptions.projectFilter is type string (not ProjectPath)
- Search service uses LIKE clause on sessions.project_name column
- Project filter is case-insensitive substring match
- All existing tests pass
- New test verifies substring matching
</success_criteria>

<output>
After completion, create `.planning/phases/07-filtering-and-output-formatting/07-05-SUMMARY.md`
</output>
