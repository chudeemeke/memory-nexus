---
phase: 10-hook-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/hooks/config-manager.ts
  - src/infrastructure/hooks/config-manager.test.ts
  - src/infrastructure/hooks/log-writer.ts
  - src/infrastructure/hooks/log-writer.test.ts
  - src/infrastructure/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Config manager loads configuration from ~/.memory-nexus/config.json"
    - "Config manager returns defaults when config file missing"
    - "Config manager merges partial config with defaults"
    - "Config manager handles invalid JSON gracefully"
    - "Log writer appends structured JSON entries to sync.log"
    - "Log writer creates log directory if missing"
    - "Log rotation removes logs older than retention period"
  artifacts:
    - path: "src/infrastructure/hooks/config-manager.ts"
      provides: "Configuration loading and validation"
      exports: ["loadConfig", "DEFAULT_CONFIG", "MemoryNexusConfig"]
    - path: "src/infrastructure/hooks/log-writer.ts"
      provides: "Structured JSON log writer with rotation"
      exports: ["logSync", "rotateLogsIfNeeded", "LogEntry"]
    - path: "src/infrastructure/hooks/index.ts"
      provides: "Barrel export for hooks module"
      exports: ["loadConfig", "logSync", "DEFAULT_CONFIG"]
  key_links:
    - from: "config-manager.ts"
      to: "~/.memory-nexus/config.json"
      via: "fs.readFileSync"
      pattern: "readFileSync.*config\\.json"
    - from: "log-writer.ts"
      to: "~/.memory-nexus/logs/sync.log"
      via: "fs.appendFileSync"
      pattern: "appendFileSync.*sync\\.log"
---

<objective>
Create configuration management and structured logging infrastructure for hook system.

Purpose: The hook system needs reliable configuration loading (with defaults) and structured logging to track sync operations. This infrastructure layer is used by the hook runner and CLI status command. Configuration supports user customization without code changes.

Output: Working config-manager.ts and log-writer.ts with full test coverage, following existing infrastructure patterns.
</objective>

<execution_context>
@C:\Users\Destiny\.claude/get-stuff-done/workflows/execute-plan.md
@C:\Users\Destiny\.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-hook-integration/10-CONTEXT.md
@.planning/phases/10-hook-integration/10-RESEARCH.md

@src/infrastructure/database/connection.ts
@src/infrastructure/sources/session-source.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MemoryNexusConfig type and config-manager with defaults</name>
  <files>
    src/infrastructure/hooks/config-manager.ts
    src/infrastructure/hooks/config-manager.test.ts
  </files>
  <action>
Create config-manager.ts following the research patterns:

1. Define MemoryNexusConfig interface:
```typescript
export interface MemoryNexusConfig {
  autoSync: boolean;              // Enable automatic hook-based sync
  recoveryOnStartup: boolean;     // Scan for unsaved sessions on first command
  syncOnCompaction: boolean;      // Trigger sync on PreCompact event
  timeout: number;                // Sync timeout in milliseconds
  logLevel: "debug" | "info" | "warn" | "error";
  logRetentionDays: number;       // Days to keep log files
  showFailures: boolean;          // Show failure notifications to user
}
```

2. Define DEFAULT_CONFIG constant (from CONTEXT.md):
```typescript
export const DEFAULT_CONFIG: MemoryNexusConfig = {
  autoSync: true,
  recoveryOnStartup: true,
  syncOnCompaction: true,
  timeout: 5000,
  logLevel: "info",
  logRetentionDays: 7,
  showFailures: false,  // Silent by default
};
```

3. Implement getConfigPath() helper:
- Returns path to `~/.memory-nexus/config.json`
- Use `homedir()` from `node:os` and `join()` from `node:path`
- Export for testing purposes

4. Implement loadConfig():
- If config file doesn't exist, return DEFAULT_CONFIG
- If config exists, read and parse JSON
- Merge loaded config with defaults (spread: `{ ...DEFAULT_CONFIG, ...loaded }`)
- On parse error, log warning and return DEFAULT_CONFIG
- Note: logging import creates circular dependency; use console.warn for now

5. Implement saveConfig(config: Partial<MemoryNexusConfig>):
- Create ~/.memory-nexus directory if missing (mkdirSync recursive)
- Write JSON with 2-space indent for readability
- Merge with existing config if present

Tests should cover:
- loadConfig returns defaults when file missing
- loadConfig merges partial config with defaults
- loadConfig handles invalid JSON (returns defaults)
- loadConfig handles malformed JSON (syntax error)
- saveConfig creates directory if missing
- saveConfig writes valid JSON
- saveConfig merges with existing config
- getConfigPath returns correct path

Use temporary directory for tests (mkdtempSync pattern from session-source.test.ts).
  </action>
  <verify>
Run `bun test config-manager` - all tests pass
  </verify>
  <done>
MemoryNexusConfig type defined, loadConfig and saveConfig work correctly, defaults properly applied
  </done>
</task>

<task type="auto">
  <name>Task 2: Create log-writer with structured JSON logging and rotation</name>
  <files>
    src/infrastructure/hooks/log-writer.ts
    src/infrastructure/hooks/log-writer.test.ts
  </files>
  <action>
Create log-writer.ts following the research patterns:

1. Define LogEntry interface:
```typescript
export interface LogEntry {
  timestamp: string;  // ISO 8601 format
  level: "debug" | "info" | "warn" | "error";
  message: string;
  sessionId?: string;
  durationMs?: number;
  error?: string;
  hookEvent?: string;  // SessionEnd or PreCompact
}

export type LogEntryInput = Omit<LogEntry, "timestamp">;
```

2. Implement getLogDir() and getLogPath() helpers:
- Log directory: `~/.memory-nexus/logs/`
- Log file: `~/.memory-nexus/logs/sync.log`
- Export for testing

3. Implement logSync(entry: LogEntryInput):
- Create log directory if missing (mkdirSync recursive)
- Add timestamp (new Date().toISOString())
- Append JSON line to sync.log (appendFileSync with newline)
- Handle write errors gracefully (catch and ignore to not break sync)

4. Implement rotateLogsIfNeeded(retentionDays: number):
- Check if sync.log exists
- Get file modification time (statSync)
- If file older than retentionDays:
  - Rename to sync.log.YYYY-MM-DD (archive)
  - This clears main log for fresh writes
- Handle missing file gracefully

5. Implement readRecentLogs(limit: number = 100): LogEntry[]:
- Read sync.log file
- Parse JSON lines
- Return last `limit` entries (for status command)
- Handle missing file (return empty array)
- Handle malformed lines (skip with continue)

Tests should cover:
- logSync creates directory if missing
- logSync appends entry with timestamp
- logSync writes valid JSON lines
- Multiple logSync calls append correctly
- rotateLogsIfNeeded renames old log
- rotateLogsIfNeeded no-op if file is recent
- rotateLogsIfNeeded no-op if file missing
- readRecentLogs returns parsed entries
- readRecentLogs returns empty array if file missing
- readRecentLogs handles malformed lines gracefully

Use temporary directory for tests.
  </action>
  <verify>
Run `bun test log-writer` - all tests pass
  </verify>
  <done>
logSync writes structured JSON logs, rotateLogsIfNeeded handles retention, readRecentLogs parses log file
  </done>
</task>

<task type="auto">
  <name>Task 3: Create hooks module barrel export</name>
  <files>
    src/infrastructure/hooks/index.ts
    src/infrastructure/index.ts
  </files>
  <action>
Create hooks/index.ts barrel export:

```typescript
// Config exports
export {
  loadConfig,
  saveConfig,
  getConfigPath,
  DEFAULT_CONFIG,
  type MemoryNexusConfig,
} from "./config-manager.js";

// Log exports
export {
  logSync,
  rotateLogsIfNeeded,
  readRecentLogs,
  getLogPath,
  getLogDir,
  type LogEntry,
  type LogEntryInput,
} from "./log-writer.js";
```

Update src/infrastructure/index.ts to include hooks module:

```typescript
// Add to existing exports
export * from "./hooks/index.js";
```

Verify imports work from:
- `import { loadConfig } from "../infrastructure/hooks/index.js"`
- `import { loadConfig } from "../infrastructure/index.js"`
  </action>
  <verify>
Run `bun test` - all tests pass
Verify import: `import { loadConfig, logSync } from "../infrastructure/index.js"` compiles
  </verify>
  <done>
hooks module exports available from infrastructure barrel, all existing tests still pass
  </done>
</task>

</tasks>

<verification>
1. `bun test config-manager` passes all tests
2. `bun test log-writer` passes all tests
3. `bun test` passes all existing tests (no regressions)
4. Coverage for new files meets 95%+ threshold
5. Default config matches CONTEXT.md specification
6. Log format is valid JSON lines (machine parseable)
</verification>

<success_criteria>
1. MemoryNexusConfig interface matches CONTEXT.md specification
2. DEFAULT_CONFIG has all features enabled (autoSync, recoveryOnStartup, syncOnCompaction)
3. loadConfig gracefully handles missing/invalid config files
4. saveConfig creates directory structure and writes valid JSON
5. logSync appends structured JSON entries with timestamps
6. rotateLogsIfNeeded archives old logs based on retention
7. readRecentLogs parses log file for status display
8. All tests pass with 95%+ coverage
</success_criteria>

<output>
After completion, create `.planning/phases/10-hook-integration/10-01-SUMMARY.md`
</output>
